<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.display_title }} - Media Browser</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script> <!-- Added Alpine.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a73e8',
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col font-sans">
    <header class="bg-slate-800 sticky top-0 z-50 border-b border-slate-700">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
             <div class="flex justify-between items-center h-16">
                <a href="/" class="text-xl lg:text-2xl font-semibold text-white hover:text-primary transition-colors duration-150">Media Browser</a>
                <div class="flex items-center space-x-4">
                    <!-- Tools Dropdown -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" @click.away="open = false" class="flex items-center text-sm font-medium text-slate-300 hover:text-primary transition-colors duration-150 p-2 rounded-md hover:bg-slate-700">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1">
                                <path fill-rule="evenodd" d="M2.843 3.913A.75.75 0 0 0 2.25 4.5v11a.75.75 0 0 0 .593.737l3.521.88a.75.75 0 0 0 .874-.468l1.408-3.755a.75.75 0 0 1 1.428-.001l1.407 3.755a.75.75 0 0 0 .875.468l3.52-.88a.75.75 0 0 0 .594-.737V4.5a.75.75 0 0 0-.594-.737l-3.52-.88a.75.75 0 0 0-.875.468L11.16 6.105a.75.75 0 0 1-1.428.001L8.325 2.355a.75.75 0 0 0-.874-.468l-3.521.88.002-.001ZM4.463 4.58L7.5 3.75v3.479l-2.514.63a.75.75 0 0 0-.522.715v4.065L4.463 15.42V4.58Zm11.074 10.84L12.5 16.25V8.802l2.515-.63a.75.75 0 0 0 .52-.715V4.58l3.038.761v10.84Z" clip-rule="evenodd" />
                            </svg>
                            Tools
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1 opacity-70">
                                <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div x-show="open" x-transition 
                             class="absolute right-0 mt-2 w-56 bg-slate-800 border border-slate-700 rounded-md shadow-lg py-1 z-20">
                            <a href="{{ url_for('thumbnail_tools_page') }}" 
                               class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-primary">Media Processing Tools</a>
                            <a href="{{ url_for('background_jobs_page') }}" 
                               class="block px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-primary">Background Jobs</a>
                        </div>
                    </div>
                    
                    <!-- Settings Link -->
                    <a href="{{ url_for('settings_page') }}" 
                       class="text-slate-300 hover:text-primary transition-colors duration-150 p-2 rounded-md hover:bg-slate-700"
                       title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M11.078 2.25c-.217 0-.434.03-.642.08c-.262.064-.522.154-.776.27A52.346 52.346 0 0 0 6.22 3.987a.75.75 0 0 0-.618.928c.09.23.2.452.323.668C6.8 7.04 7.5 8.87 7.5 10.5c0 1.63-.7 3.46-1.577 4.915-.123.216-.233.438-.323.668a.75.75 0 0 0 .618.928c.598.288 1.236.533 1.918.731a52.532 52.532 0 0 0 3.376.432c.217 0 .434-.03.642-.08c.262-.064.522-.154.776-.27.598-.288 1.236-.533 1.918-.731a.75.75 0 0 0 .618-.928c-.09-.23-.2-.452-.323-.668C13.2 13.96 12.5 12.13 12.5 10.5c0-1.63.7-3.46 1.577-4.915.123-.216-.233.438-.323.668a.75.75 0 0 0-.618-.928A52.532 52.532 0 0 0 11.078 2.25ZM10 12.25a1.75 1.75 0 1 0 0-3.5 1.75 1.75 0 0 0 0 3.5Z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-screen-2xl p-4 md:p-6 lg:p-8">
        <div class="lg:flex lg:gap-6 xl:gap-8">
            <!-- Video Player Section -->
            <div class="lg:flex-grow mb-6 lg:mb-0">
                <!-- Video Title and Status -->
                <div class="mb-4" id="video-title-header">
                    <h1 class="text-2xl lg:text-3xl font-bold text-slate-100 mb-2 overflow-hidden whitespace-nowrap text-ellipsis" title="{{ video.display_title }}">{{ video.display_title }}</h1>
                    <div id="video-status-indicator" class="flex items-center space-x-2">
                        {% if video.has_transcoded_version %}
                            <span class="text-xs font-medium bg-green-500/20 text-green-400 px-2 py-1 rounded-full">Playing Transcoded Version</span>
                        {% else %}
                            <span class="text-xs font-medium bg-amber-500/20 text-amber-400 px-2 py-1 rounded-full">Playing Original Version</span>
                        {% endif %}
                        
                        <!-- Auto Replay Status Indicator -->
                        <span id="auto-replay-indicator" class="text-xs font-medium bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full flex items-center {{ 'block' if auto_replay else 'hidden' }}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1">
                                <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0112.548-3.364l1.903 1.903h-3.183a.75.75 0 100 1.5h4.992a.75.75 0 00.75-.75V4.356a.75.75 0 00-1.5 0v3.18l-1.9-1.9A9 9 0 003.306 9.67a.75.75 0 101.45.388zm15.408 3.352a.75.75 0 00-.919.53 7.5 7.5 0 01-12.548 3.364l-1.902-1.903h3.183a.75.75 0 000-1.5H2.984a.75.75 0 00-.75.75v4.992a.75.75 0 001.5 0v-3.18l1.9 1.9a9 9 0 0015.059-4.035.75.75 0 00-.53-.918z" clip-rule="evenodd" />
                            </svg>
                            Auto Replay
                        </span>
                    </div>
                </div>

                <!-- Custom Video Player Container -->
                <div class="aspect-video bg-black rounded-lg overflow-hidden shadow-2xl relative group {{ 'ring-2 ring-blue-500/50 shadow-blue-500/20' if auto_replay else '' }}" id="video-player-container">
                    <video id="main-video-player" 
                           class="w-full h-full" 
                           poster="{{ video.thumbnail }}"
                           preload="metadata"
                           {% if autoplay_enabled %}autoplay{% endif %}
                           {% if default_muted %}muted{% endif %}
                           onclick="togglePlay()"
                           crossorigin="anonymous">
                        <source src="{{ video.path }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    
                    <!-- Custom Video Controls -->
                    <div id="video-controls" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/60 to-transparent p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <!-- Timeline Container -->
                        <div class="mb-3">
                            <div class="flex items-center text-white text-sm mb-2">
                                <span id="current-time">0:00</span>
                                <span class="mx-2">/</span>
                                <span id="duration">0:00</span>
                            </div>
                            <!-- Timeline -->
                            <div class="relative h-2 bg-white/20 rounded-full cursor-pointer" id="timeline-container">
                                <div id="timeline-progress" class="absolute top-0 left-0 h-full bg-primary rounded-full pointer-events-none" style="width: 0%"></div>
                                <div id="timeline-handle" class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-lg opacity-0 transition-opacity duration-200 pointer-events-none" style="left: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <!-- Play/Pause Button -->
                                <button id="play-pause-btn" onclick="togglePlay()" class="text-white hover:text-primary transition-colors duration-150">
                                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                                    </svg>
                                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 hidden">
                                        <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0114.25 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75h-1.5a.75.75 0 01-.75-.75V5.25z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                
                                <!-- Volume Controls -->
                                <div class="flex items-center space-x-2">
                                    <button id="mute-btn" onclick="toggleMute()" class="text-white hover:text-primary transition-colors duration-150">
                                        <svg id="volume-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                                        </svg>
                                        <svg id="mute-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 hidden">
                                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                                        </svg>
                                    </button>
                                    <div class="w-16 h-1 bg-white/20 rounded-full cursor-pointer" id="volume-container" onclick="setVolume(event)">
                                        <div id="volume-progress" class="h-full bg-white rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                                
                                <!-- Time Display -->
                                <div class="text-white text-sm">
                                    <span id="current-time-main">0:00</span> / <span id="duration-main">0:00</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-3">
                                <!-- Speed Control -->
                                <div class="relative">
                                    <button id="speed-btn" onclick="toggleSpeedMenu()" class="text-white hover:text-primary transition-colors duration-150 text-sm font-medium">
                                        1x
                                    </button>
                                    <div id="speed-menu" class="absolute bottom-8 right-0 bg-slate-800 border border-slate-600 rounded-lg py-2 min-w-16 hidden">
                                        <button onclick="setSpeed(0.5)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">0.5x</button>
                                        <button onclick="setSpeed(0.75)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">0.75x</button>
                                        <button onclick="setSpeed(1)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">1x</button>
                                        <button onclick="setSpeed(1.25)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">1.25x</button>
                                        <button onclick="setSpeed(1.5)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">1.5x</button>
                                        <button onclick="setSpeed(2)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">2x</button>
                                    </div>
                                </div>
                                
                                <!-- Auto Replay Toggle -->
                                <button id="auto-replay-toggle" 
                                        onclick="toggleAutoReplay()"
                                        class="text-white hover:text-primary transition-colors duration-150 {{ 'text-primary' if auto_replay else 'text-slate-400' }}"
                                        title="Toggle auto replay"
                                        hx-post="/settings/auto-replay"
                                        hx-vals='js:{"auto_replay": document.getElementById("auto-replay-toggle").dataset.enabled}'
                                        hx-target="#auto-replay-status"
                                        hx-swap="innerHTML"
                                        hx-trigger="click"
                                        hx-include="this"
                                        hx-on:htmx:after-request="setTimeout(() => { document.getElementById('auto-replay-status').innerHTML = ''; }, 5000);">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                        <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0112.548-3.364l1.903 1.903h-3.183a.75.75 0 100 1.5h4.992a.75.75 0 00.75-.75V4.356a.75.75 0 00-1.5 0v3.18l-1.9-1.9A9 9 0 003.306 9.67a.75.75 0 101.45.388zm15.408 3.352a.75.75 0 00-.919.53 7.5 7.5 0 01-12.548 3.364l-1.902-1.903h3.183a.75.75 0 000-1.5H2.984a.75.75 0 00-.75.75v4.992a.75.75 0 001.5 0v-3.18l1.9 1.9a9 9 0 0015.059-4.035.75.75 0 00-.53-.918z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                
                                <!-- Fullscreen Button -->
                                <button id="fullscreen-btn" onclick="toggleFullscreen()" class="text-white hover:text-primary transition-colors duration-150">
                                    <svg id="fullscreen-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                        <path fill-rule="evenodd" d="M15 3.75a.75.75 0 01.75-.75h4.5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0V5.56l-3.97 3.97a.75.75 0 11-1.06-1.06l3.97-3.97h-2.69a.75.75 0 01-.75-.75zm-12 0A.75.75 0 013.75 3h4.5a.75.75 0 010 1.5H5.56l3.97 3.97a.75.75 0 01-1.06 1.06L4.5 5.56v2.69A.75.75 0 013 7.5v-4.5zm11.47 11.78a.75.75 0 111.06-1.06l3.97 3.97v-2.69a.75.75 0 011.5 0v4.5a.75.75 0 01-.75.75h-4.5a.75.75 0 010-1.5h2.69l-3.97-3.97zm-4.94-1.06a.75.75 0 010 1.06L5.56 19.5h2.69a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75v-4.5a.75.75 0 011.5 0v2.69l3.97-3.97a.75.75 0 011.06 0z" clip-rule="evenodd" />
                                    </svg>
                                    <svg id="exit-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 hidden">
                                        <path fill-rule="evenodd" d="M9.53 2.47a.75.75 0 010 1.06L6.81 6.25H9.5a.75.75 0 010 1.5H6.75a.75.75 0 01-.75-.75V4.25a.75.75 0 011.5 0v2.69L10.22 4.22a.75.75 0 011.06 0zM2.47 9.53a.75.75 0 011.06 0L6.25 6.81V9.5a.75.75 0 001.5 0V6.75a.75.75 0 00-.75-.75H4.25a.75.75 0 000 1.5h2.69L4.22 10.22a.75.75 0 000 1.06zm16.28 4.94a.75.75 0 01-1.06 0L14.97 11.75H17.5a.75.75 0 000-1.5h-2.75a.75.75 0 00-.75.75v2.75a.75.75 0 001.5 0v-2.69l2.72 2.72a.75.75 0 000 1.06zm-4.94 4.94a.75.75 0 010-1.06L16.53 15.75H14.5a.75.75 0 010-1.5h2.75a.75.75 0 01.75.75v2.75a.75.75 0 01-1.5 0V14.97l-2.72 2.72a.75.75 0 01-1.06 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-black/50 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    </div>

                    <!-- Auto Replay Status -->
                    <div id="auto-replay-status" class="absolute top-4 left-4"></div>

                    <!-- Autoplay Muted Notification -->
                    <div id="autoplay-muted-notice" class="absolute top-4 right-4 bg-black/80 text-white px-4 py-2 rounded-lg shadow-lg hidden">
                        <div class="flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                            </svg>
                            <span class="text-sm">Video is muted</span>
                            <button onclick="unmuteVideo()" class="bg-primary hover:bg-primary/80 text-white text-xs px-2 py-1 rounded transition-colors duration-150">
                                Unmute
                            </button>
                        </div>
                    </div>
                    
                    <!-- Center Play Button -->
                    <div id="center-play-btn" class="absolute inset-0 flex items-center justify-center cursor-pointer" onclick="togglePlay()">
                        <div class="bg-black/60 rounded-full p-4 hover:bg-black/80 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-white">
                                <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metadata Sidebar Section -->
            {% include "_video_metadata_sidebar.html" %}
        </div>

        <!-- Video Queue Section -->
        {% if video_queue %}
        <div class="mt-8 bg-slate-800 rounded-lg shadow-xl border border-slate-700">
            <!-- Queue Header (Clickable) -->
            <div class="flex items-center justify-between p-5 cursor-pointer hover:bg-slate-700/50 transition-colors duration-150 rounded-t-lg" 
                 onclick="toggleQueue()">
                <h2 class="text-xl font-semibold text-slate-100 flex items-center">
                    <span>Up Next</span>
                    <span class="ml-2 text-slate-400 text-sm">({{ video_queue|length }} videos)</span>
                </h2>
                <div class="flex items-center space-x-4">
                    <!-- Autoplay Next Toggle -->
                    <div class="flex items-center space-x-2" onclick="event.stopPropagation();">
                        <span class="text-xs text-slate-400">Autoplay</span>
                        <button id="autoplay-next-toggle" 
                                onclick="toggleAutoplayNext()"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-slate-800 {{ 'bg-primary' if autoplay_next else 'bg-slate-600' }}"
                                hx-post="/settings/autoplay-next"
                                hx-vals='js:{"autoplay_next": document.getElementById("autoplay-next-toggle").dataset.enabled}'
                                hx-target="#autoplay-toggle-status"
                                hx-swap="innerHTML"
                                hx-trigger="click"
                                hx-include="this"
                                hx-on:htmx:after-request="setTimeout(() => { document.getElementById('autoplay-toggle-status').innerHTML = ''; }, 3000);">
                            <span id="autoplay-toggle-dot" class="absolute left-1 inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform duration-200 {{ 'translate-x-5' if autoplay_next else 'translate-x-0' }}"></span>
                        </button>
                    </div>
                    <div class="flex items-center text-slate-400">
                        <svg id="queue-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" 
                             class="w-5 h-5 transform transition-transform duration-200">
                            <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 01-1.06 0l-7.5-7.5a.75.75 0 011.06-1.06L12 14.69l6.97-6.97a.75.75 0 111.06 1.06l-7.5 7.5z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Queue Content (Collapsible) -->
            <div id="queue-content" class="border-t border-slate-700">
                <!-- Status message area for the toggle -->
                <div id="autoplay-toggle-status" class="px-5 pt-2"></div>
                <div class="p-5 pt-4 space-y-3 max-h-96 overflow-y-auto pr-2">
                    {% for q_video in video_queue %}
                        <div class="flex items-center justify-between group">
                            <a href="{{ url_for('video_player_page', video_name=q_video.name) }}" 
                               class="text-sm {% if q_video.id_db == video.id_db %}text-primary font-semibold{% else %}text-slate-300 hover:text-primary{% endif %} transition-colors duration-150 overflow-hidden whitespace-nowrap text-ellipsis flex-grow" 
                               title="{{ q_video.display_title }}">
                                {{ loop.index }}. {{ q_video.display_title }}
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

    </main>

    <!-- Advanced Transcoding Modal -->
    <div id="advancedTranscodingModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-slate-900 bg-opacity-75" onclick="closeAdvancedTranscodingModal()"></div>

            <!-- Modal content -->
            <div class="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-slate-800 shadow-xl rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-slate-100">Advanced Transcoding Options</h3>
                    <button onclick="closeAdvancedTranscodingModal()" class="text-slate-400 hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <form hx-post="{{ url_for('transcode_specific_video_advanced_endpoint', video_name=video.name) }}" 
                      hx-target="#advanced-transcoding-status" 
                      hx-swap="innerHTML" 
                      hx-indicator="#advanced-loading-spinner"
                      hx-on:htmx:after-request="handleAdvancedTranscodeJobStart(event)">
                    
                    <div class="space-y-4">
                        <div>
                            <label for="modal-resolution" class="block text-sm font-medium text-slate-300 mb-2">Resolution</label>
                            <select name="resolution" id="modal-resolution" 
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="original">Original Resolution</option>
                                <option value="1080p">1080p (Full HD)</option>
                                <option value="720p" selected>720p (HD)</option>
                                <option value="480p">480p (SD)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-quality-mode" class="block text-sm font-medium text-slate-300 mb-2">Quality Mode</label>
                            <select name="quality_mode" id="modal-quality-mode" onchange="toggleModalQualityOptions()"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="crf" selected>CRF (Constant Quality)</option>
                                <option value="bitrate">Bitrate (Constant Rate)</option>
                            </select>
                        </div>
                        
                        <div id="modal-crf-container">
                            <label for="modal-crf" class="block text-sm font-medium text-slate-300 mb-2">CRF Quality (Lower = Better)</label>
                            <select name="crf" id="modal-crf"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="18">18 (Very High Quality)</option>
                                <option value="23" selected>23 (High Quality)</option>
                                <option value="28">28 (Medium Quality)</option>
                                <option value="32">32 (Lower Quality)</option>
                            </select>
                        </div>
                        
                        <div id="modal-bitrate-container" style="display: none;">
                            <label for="modal-video-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Video Bitrate</label>
                            <select name="video_bitrate" id="modal-video-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="1M">1 Mbps</option>
                                <option value="2M" selected>2 Mbps</option>
                                <option value="4M">4 Mbps</option>
                                <option value="8M">8 Mbps</option>
                                <option value="12M">12 Mbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-audio-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Audio Bitrate</label>
                            <select name="audio_bitrate" id="modal-audio-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="96k">96 kbps</option>
                                <option value="128k" selected>128 kbps</option>
                                <option value="192k">192 kbps</option>
                                <option value="256k">256 kbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-preset" class="block text-sm font-medium text-slate-300 mb-2">Encoding Speed</label>
                            <select name="preset" id="modal-preset"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="ultrafast">Ultra Fast (Larger Files)</option>
                                <option value="fast">Fast</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="slow">Slow (Better Compression)</option>
                            </select>
                        </div>

                        <div>
                            <label for="modal-profile" class="block text-sm font-medium text-slate-300 mb-2">H.264 Profile</label>
                            <select name="profile" id="modal-profile"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="baseline">Baseline (Max Compatibility)</option>
                                <option value="main">Main (Good Quality/Compatibility)</option>
                                <option value="high" selected>High (Best Quality)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button type="button" onclick="closeAdvancedTranscodingModal()" 
                                class="flex-1 bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 text-sm">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                            <span id="advanced-loading-spinner" class="htmx-indicator animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                            Start Transcoding
                        </button>
                    </div>
                </form>

                <div id="advanced-transcoding-status" class="mt-4 p-3 bg-slate-700/50 rounded-md min-h-[40px] text-sm text-slate-300"></div>
            </div>
        </div>
    </div>

    <script>
        let choicesTagsInstance = null;
        let video = null;
        let isVideoReady = false;
        let currentSpeed = 1;
        let isSeeking = false;
        let seekingTimeout = null;
        
        // Settings from backend
        const autoplayEnabled = {{ autoplay_enabled|lower }};
        const defaultMuted = {{ default_muted|lower }};
        let autoplayNext = {{ autoplay_next|lower }}; // Make this mutable so we can update it
        let autoReplay = {{ auto_replay|lower }}; // Make this mutable so we can update it

        // Initialize video player when page loads
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('main-video-player');
            initializeVideoPlayer();
            initializeAutoplayToggle();
        });

        function initializeVideoPlayer() {
            if (!video) return;

            // Video event listeners
            video.addEventListener('loadedmetadata', onVideoMetadataLoaded);
            video.addEventListener('loadeddata', onVideoDataLoaded);
            video.addEventListener('timeupdate', updateProgress);
            video.addEventListener('play', onVideoPlay);
            video.addEventListener('pause', onVideoPause);
            video.addEventListener('waiting', showLoading);
            video.addEventListener('canplay', hideLoading);
            video.addEventListener('ended', onVideoEnded);
            video.addEventListener('canplaythrough', onVideoCanPlayThrough);
            video.addEventListener('seeked', onVideoSeeked);
            video.addEventListener('seeking', onVideoSeeking);
            video.addEventListener('error', onVideoError);

            // Timeline event listeners - use both click and mousedown for better compatibility
            const timelineContainer = document.getElementById('timeline-container');
            timelineContainer.addEventListener('click', handleTimelineClick);
            
            // Add drag functionality for scrubbing
            let isDragging = false;
            timelineContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                handleTimelineSeek(e);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    handleTimelineSeek(e);
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            timelineContainer.addEventListener('mouseenter', () => {
                document.getElementById('timeline-handle').style.opacity = '1';
            });
            timelineContainer.addEventListener('mouseleave', () => {
                if (!isDragging) {
                    document.getElementById('timeline-handle').style.opacity = '0';
                }
            });

            // Handle autoplay
            handleAutoplay();

            // Initialize volume controls
            updateVolumeIcon();
            updateVolumeBar();

            // Hide center play button initially if autoplay
            updateCenterPlayButton();
        }

        function handleAutoplay() {
            // Only attempt autoplay if enabled in settings
            if (!autoplayEnabled) {
                console.log('Autoplay disabled in settings');
                document.getElementById('center-play-btn').classList.remove('hidden');
                return;
            }
            
            // Attempt to play the video (autoplay might fail in some browsers)
            const playPromise = video.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('Autoplay started successfully');
                    // Video started playing successfully - show muted notice if muted
                    if (video.muted) {
                        showMutedNotice();
                    }
                }).catch(error => {
                    console.log('Autoplay failed:', error);
                    // Autoplay failed, show the center play button
                    document.getElementById('center-play-btn').classList.remove('hidden');
                    // Only unmute if default_muted is false
                    if (!defaultMuted) {
                        video.muted = false;
                        updateVolumeIcon();
                        updateVolumeBar();
                    }
                });
            }
        }

        function showMutedNotice() {
            // Only show notice if video is actually muted
            if (!video.muted) return;
            
            const notice = document.getElementById('autoplay-muted-notice');
            notice.classList.remove('hidden');
            
            // Auto-hide the notice after 5 seconds
            setTimeout(() => {
                hideMutedNotice();
            }, 5000);
        }

        function hideMutedNotice() {
            const notice = document.getElementById('autoplay-muted-notice');
            notice.classList.add('hidden');
        }

        function unmuteVideo() {
            if (!video) return;
            
            video.muted = false;
            hideMutedNotice();
            updateVolumeIcon();
            updateVolumeBar();
        }

        function togglePlay() {
            if (!video) return;

            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }

        function onVideoPlay() {
            document.getElementById('play-icon').classList.add('hidden');
            document.getElementById('pause-icon').classList.remove('hidden');
            document.getElementById('center-play-btn').classList.add('hidden');
        }

        function onVideoPause() {
            document.getElementById('play-icon').classList.remove('hidden');
            document.getElementById('pause-icon').classList.add('hidden');
            document.getElementById('center-play-btn').classList.remove('hidden');
        }

        function onVideoEnded() {
            document.getElementById('play-icon').classList.remove('hidden');
            document.getElementById('pause-icon').classList.add('hidden');
            document.getElementById('center-play-btn').classList.remove('hidden');
            
            // Check if auto-replay is enabled first (takes priority)
            if (autoReplay) {
                console.log('Auto-replaying current video from beginning');
                video.currentTime = 0;
                video.play();
                return; // Exit early, don't check autoplay next
            }
            
            // If auto-replay is disabled, check if autoplay next is enabled
            if (autoplayNext) {
                {% if next_video %}
                // Automatically go to next video
                console.log('Auto-playing next video: {{ next_video.name }}');
                window.location.href = '/video/{{ next_video.name }}';
                {% else %}
                console.log('Autoplay next enabled but no next video available');
                {% endif %}
            }
        }

        function onVideoMetadataLoaded() {
            updateDuration();
            console.log('Video metadata loaded - duration:', video.duration);
        }

        function onVideoDataLoaded() {
            isVideoReady = true;
            console.log('Video data loaded - ready for seeking');
        }

        function updateCenterPlayButton() {
            const centerBtn = document.getElementById('center-play-btn');
            if (video && video.paused) {
                centerBtn.classList.remove('hidden');
            } else {
                centerBtn.classList.add('hidden');
            }
        }

        function showLoading() {
            document.getElementById('loading-spinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        function updateDuration() {
            if (!video) return;
            const duration = formatTime(video.duration);
            document.getElementById('duration').textContent = duration;
            document.getElementById('duration-main').textContent = duration;
        }

        function updateProgress() {
            if (!video || isSeeking) return;
            
            const progress = (video.currentTime / video.duration) * 100;
            const currentTime = formatTime(video.currentTime);
            
            document.getElementById('timeline-progress').style.width = progress + '%';
            document.getElementById('timeline-handle').style.left = progress + '%';
            document.getElementById('current-time').textContent = currentTime;
            document.getElementById('current-time-main').textContent = currentTime;
        }

        function handleTimelineClick(event) {
            // Only handle direct clicks, not drag events
            if (event.target === event.currentTarget || event.target.id === 'timeline-progress') {
                handleTimelineSeek(event);
            }
        }

        function handleTimelineSeek(event) {
            if (!video || !video.duration || isNaN(video.duration)) return;
            
            const timelineContainer = document.getElementById('timeline-container');
            const rect = timelineContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const progress = Math.max(0, Math.min(1, clickX / rect.width));
            const targetTime = progress * video.duration;
            
            // Update visual feedback immediately
            document.getElementById('timeline-progress').style.width = (progress * 100) + '%';
            document.getElementById('timeline-handle').style.left = (progress * 100) + '%';
            document.getElementById('current-time').textContent = formatTime(targetTime);
            document.getElementById('current-time-main').textContent = formatTime(targetTime);
            
            // Debounce the actual seeking
            if (seekingTimeout) {
                clearTimeout(seekingTimeout);
            }
            
            seekingTimeout = setTimeout(() => {
                performSeek(targetTime);
            }, 50); // Small delay to prevent too many seek operations
        }

        function performSeek(targetTime) {
            if (!video || isNaN(targetTime) || targetTime < 0 || targetTime > video.duration) {
                console.error('Invalid seek time:', targetTime);
                return;
            }
            
            console.log('Attempting to seek to:', targetTime, 'seconds');
            
            // For better compatibility, pause briefly during seek if playing
            const wasPlaying = !video.paused;
            
            try {
                // Method 1: Direct currentTime setting (works for most properly encoded videos)
                video.currentTime = targetTime;
                
                // If video was playing, ensure it continues
                if (wasPlaying && video.paused) {
                    video.play().catch(e => console.log('Play after seek failed:', e));
                }
            } catch (error) {
                console.error('Seek failed:', error);
                
                // Method 2: Try using fastSeek if available (for some browsers/formats)
                if (video.fastSeek) {
                    try {
                        video.fastSeek(targetTime);
                        if (wasPlaying && video.paused) {
                            video.play().catch(e => console.log('Play after fastSeek failed:', e));
                        }
                    } catch (fastSeekError) {
                        console.error('FastSeek also failed:', fastSeekError);
                    }
                }
            }
        }

        function toggleMute() {
            if (!video) return;
            
            video.muted = !video.muted;
            
            // Hide muted notice if unmuting
            if (!video.muted) {
                hideMutedNotice();
            }
            
            updateVolumeIcon();
            updateVolumeBar();
        }

        function updateVolumeIcon() {
            const volumeIcon = document.getElementById('volume-icon');
            const muteIcon = document.getElementById('mute-icon');
            
            if (video.muted || video.volume === 0) {
                volumeIcon.classList.add('hidden');
                muteIcon.classList.remove('hidden');
            } else {
                volumeIcon.classList.remove('hidden');
                muteIcon.classList.add('hidden');
            }
        }

        function updateVolumeBar() {
            const volumeProgress = document.getElementById('volume-progress');
            const volume = video.muted ? 0 : video.volume;
            volumeProgress.style.width = (volume * 100) + '%';
        }

        function setVolume(event) {
            if (!video) return;
            
            const volumeContainer = document.getElementById('volume-container');
            const rect = volumeContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const volume = Math.max(0, Math.min(1, clickX / rect.width));
            
            video.volume = volume;
            video.muted = false;
            updateVolumeIcon();
            updateVolumeBar();
        }

        function toggleSpeedMenu() {
            const speedMenu = document.getElementById('speed-menu');
            speedMenu.classList.toggle('hidden');
        }

        function setSpeed(speed) {
            if (!video) return;
            
            video.playbackRate = speed;
            currentSpeed = speed;
            document.getElementById('speed-btn').textContent = speed + 'x';
            document.getElementById('speed-menu').classList.add('hidden');
        }

        function toggleFullscreen() {
            const playerContainer = video.closest('.aspect-video');
            
            if (!document.fullscreenElement) {
                playerContainer.requestFullscreen().catch(err => {
                    console.log('Error attempting to enable fullscreen:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', function() {
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            const exitFullscreenIcon = document.getElementById('exit-fullscreen-icon');
            
            if (document.fullscreenElement) {
                fullscreenIcon.classList.add('hidden');
                exitFullscreenIcon.classList.remove('hidden');
            } else {
                fullscreenIcon.classList.remove('hidden');
                exitFullscreenIcon.classList.add('hidden');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (!video) return;
            
            // Only handle shortcuts when not typing in input fields
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    video.currentTime = Math.max(0, video.currentTime - 10);
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    video.currentTime = Math.min(video.duration, video.currentTime + 10);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    video.volume = Math.min(1, video.volume + 0.1);
                    updateVolumeIcon();
                    updateVolumeBar();
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    video.volume = Math.max(0, video.volume - 0.1);
                    updateVolumeIcon();
                    updateVolumeBar();
                    break;
                case 'KeyM':
                    event.preventDefault();
                    toggleMute();
                    break;
                case 'KeyF':
                    event.preventDefault();
                    toggleFullscreen();
                    break;
            }
        });

        // Close speed menu when clicking outside
        document.addEventListener('click', function(event) {
            const speedBtn = document.getElementById('speed-btn');
            const speedMenu = document.getElementById('speed-menu');
            
            if (!speedBtn.contains(event.target) && !speedMenu.contains(event.target)) {
                speedMenu.classList.add('hidden');
            }
        });

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function initializeChoices() {
            const tagsInput = document.getElementById('tags-input');
            if (tagsInput) {
                if (choicesTagsInstance) {
                    choicesTagsInstance.destroy();
                }
                choicesTagsInstance = new Choices(tagsInput, {
                    removeItemButton: true,
                    delimiter: ',',
                    editItems: true,
                    allowHTML: false,
                    placeholderValue: 'Enter tags',
                    duplicateItemsAllowed: false,
                    classNames: {
                        containerOuter: 'choices choices-tags-outer',
                        containerInner: 'choices__inner bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus-within:ring-2 focus-within:ring-primary focus-within:border-primary min-h-[40px]',
                        input: 'choices__input choices__input--cloned text-slate-200',
                        inputCloned: 'choices__input--cloned',
                        list: 'choices__list',
                        listItems: 'choices__list--multiple',
                        listSingle: 'choices__list--single',
                        listDropdown: 'choices__list--dropdown',
                        item: 'choices__item bg-primary/80 border-primary/90 text-white',
                        itemSelectable: 'choices__item--selectable',
                        itemDisabled: 'choices__item--disabled',
                        itemChoice: 'choices__item--choice',
                        placeholder: 'choices__placeholder text-slate-500',
                        group: 'choices__group',
                        groupHeading : 'choices__heading',
                        button: 'choices__button',
                        activeState: 'is-active',
                        focusState: 'is-focused',
                        openState: 'is-open',
                        disabledState: 'is-disabled',
                        highlightedState: 'is-highlighted',
                        selectedState: 'is-selected',
                        flippedState: 'is-flipped',
                        loadingState: 'is-loading',
                        noResults: 'has-no-results',
                        noChoices: 'has-no-choices'
                    }
                });
            }
        }

        function toggleEditMetadataMode(editing) {
            const displaySection = document.getElementById('metadata-display-section');
            const editForm = document.getElementById('metadata-edit-form');
            const systemDetails = document.getElementById('system-details-section'); // For button positioning
            const editButton = document.getElementById('edit-metadata-button');

            if (editing) {
                displaySection.classList.add('hidden');
                editForm.classList.remove('hidden');
                systemDetails.classList.add('hidden'); // Hide system details during edit
                initializeChoices();
            } else {
                displaySection.classList.remove('hidden');
                editForm.classList.add('hidden');
                systemDetails.classList.remove('hidden'); // Show system details
                if (choicesTagsInstance) {
                   // choicesTagsInstance.destroy(); // Or just clear input if needed on cancel
                }
            }
        }
        
        function handleMetadataUpdateResponse(event) {
            const messageDiv = document.getElementById('metadata-edit-message');
            if (event.detail.successful) {
                // The hx-swap="outerHTML" on the form for #video-metadata-sidebar handles the UI update.
                // So, we just need to ensure we are back in display mode.
                // The new sidebar that is swapped in should be in display mode by default.
                // However, if the swap target was different, we might call toggleEditMetadataMode(false) here.
                // console.log("Metadata updated successfully, sidebar swapped.");
                // toggleEditMetadataMode(false); // Will be handled by full sidebar swap
            } else {
                if (messageDiv) {
                    let errorMsg = "Failed to update metadata.";
                    try {
                        const xhrResponse = JSON.parse(event.detail.xhr.responseText);
                        errorMsg = xhrResponse.detail || xhrResponse.message || errorMsg;
                    } catch (e) { /* Use default error msg */ }
                    messageDiv.innerHTML = `<p class="text-red-400">${errorMsg}</p>`;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup if needed (e.g. if form was visible by default)
            // toggleEditMetadataMode(false); // Ensure starts in display mode
        });

        // If HTMX swaps in the sidebar (e.g. after successful edit), re-ensure edit mode is off
        // and Choices.js is not active on a non-existent input if the form was destroyed.
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'video-metadata-sidebar') {
                toggleEditMetadataMode(false); // Ensure we are in display mode
                 const newEditButton = document.getElementById('edit-metadata-button');
                 if(newEditButton) {
                    // If new button exists, we can assume the display section is there.
                 } else {
                    // This case might happen if an error prevented full sidebar swap
                 }
            }
        });

        function openAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.remove('hidden');
        }

        function closeAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.add('hidden');
        }

        function toggleModalQualityOptions() {
            const qualityMode = document.getElementById('modal-quality-mode').value;
            const crfContainer = document.getElementById('modal-crf-container');
            const bitrateContainer = document.getElementById('modal-bitrate-container');
            
            if (qualityMode === 'crf') {
                crfContainer.style.display = 'block';
                bitrateContainer.style.display = 'none';
            } else {
                crfContainer.style.display = 'none';
                bitrateContainer.style.display = 'block';
            }
        }

        // Close modal when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAdvancedTranscodingModal();
            }
        });

        // Toggle queue visibility
        function toggleQueue() {
            const queueContent = document.getElementById('queue-content');
            const chevron = document.getElementById('queue-chevron');
            
            if (queueContent.style.display === 'none') {
                queueContent.style.display = 'block';
                chevron.classList.remove('rotate-180');
            } else {
                queueContent.style.display = 'none';
                chevron.classList.add('rotate-180');
            }
        }

        // Handle new transcode event triggered by HX-Trigger from server
        document.body.addEventListener('newTranscodeAvailable', function(event) {
            const newPath = event.detail.newPath;
            const fileName = event.detail.fileName;
            const player = document.getElementById('main-video-player');
            const videoStatusSpan = document.querySelector('#video-status-indicator span'); // More robust selector

            if (player && newPath) {
                player.src = newPath;
                player.load(); // Load the new source
                // player.play(); // Optionally auto-play
                
                if (videoStatusSpan) {
                    videoStatusSpan.textContent = `Playing Advanced Transcode: ${fileName}`;
                    videoStatusSpan.className = 'text-xs font-medium bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded-full';
                }
                
                // Update the download link if it needs to reflect the newest transcode (optional)
                // const downloadLink = document.getElementById('download-original-link');
                // if(downloadLink) { /* update if needed */ }

                // Close the modal as the primary action is complete
                closeAdvancedTranscodingModal(); 
                
                // Optionally, disable the basic transcode button if this advanced one supersedes it
                const basicTranscodeButton = document.querySelector('button[hx-post*="transcode_specific_video_endpoint"]');
                if (basicTranscodeButton) {
                    // basicTranscodeButton.disabled = true;
                    // basicTranscodeButton.innerText = 'Advanced Version Created';
                }
            } else {
                console.error("Could not update player. Player or newPath missing.", event.detail);
            }
        });

        function initializeAutoplayToggle() {
            const toggleBtn = document.getElementById('autoplay-next-toggle');
            if (toggleBtn) {
                toggleBtn.dataset.enabled = autoplayNext.toString();
                updateToggleUI();
            }
            
            const autoReplayBtn = document.getElementById('auto-replay-toggle');
            if (autoReplayBtn) {
                autoReplayBtn.dataset.enabled = autoReplay.toString();
                updateAutoReplayUI();
            }
        }

        function updateToggleUI() {
            const toggleBtn = document.getElementById('autoplay-next-toggle');
            const toggleDot = document.getElementById('autoplay-toggle-dot');
            
            if (!toggleBtn || !toggleDot) return;
            
            const enabled = toggleBtn.dataset.enabled === 'true';
            
            if (enabled) {
                toggleBtn.className = 'relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-slate-800 bg-primary';
                toggleDot.className = 'absolute left-1 inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform duration-200 translate-x-5';
            } else {
                toggleBtn.className = 'relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-slate-800 bg-slate-600';
                toggleDot.className = 'absolute left-1 inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform duration-200 translate-x-0';
            }
        }

        function updateAutoReplayUI() {
            const autoReplayBtn = document.getElementById('auto-replay-toggle');
            const autoReplayIndicator = document.getElementById('auto-replay-indicator');
            const videoPlayerContainer = document.getElementById('video-player-container');
            
            if (!autoReplayBtn) return;
            
            const enabled = autoReplayBtn.dataset.enabled === 'true';
            
            // Update button appearance
            if (enabled) {
                autoReplayBtn.className = 'text-white hover:text-primary transition-colors duration-150 text-primary';
            } else {
                autoReplayBtn.className = 'text-white hover:text-primary transition-colors duration-150 text-slate-400';
            }
            
            // Update persistent indicator
            if (autoReplayIndicator) {
                if (enabled) {
                    autoReplayIndicator.classList.remove('hidden');
                    autoReplayIndicator.classList.add('block');
                } else {
                    autoReplayIndicator.classList.remove('block');
                    autoReplayIndicator.classList.add('hidden');
                }
            }
            
            // Update video player container glow effect
            if (videoPlayerContainer) {
                if (enabled) {
                    videoPlayerContainer.classList.add('ring-2', 'ring-blue-500/50', 'shadow-blue-500/20');
                } else {
                    videoPlayerContainer.classList.remove('ring-2', 'ring-blue-500/50', 'shadow-blue-500/20');
                }
            }
        }

        function toggleAutoplayNext() {
            const toggleBtn = document.getElementById('autoplay-next-toggle');
            if (!toggleBtn) return;
            
            const currentlyEnabled = toggleBtn.dataset.enabled === 'true';
            const newState = !currentlyEnabled;
            
            // Update the dataset and UI immediately for responsive feel
            toggleBtn.dataset.enabled = newState.toString();
            autoplayNext = newState; // Update the global variable
            updateToggleUI();
            
            // The HTMX request will handle saving to the backend
        }

        function toggleAutoReplay() {
            const toggleBtn = document.getElementById('auto-replay-toggle');
            if (!toggleBtn) return;
            
            const currentlyEnabled = toggleBtn.dataset.enabled === 'true';
            const newState = !currentlyEnabled;
            
            // Update the dataset and UI immediately for responsive feel
            toggleBtn.dataset.enabled = newState.toString();
            autoReplay = newState; // Update the global variable
            updateAutoReplayUI();
            
            // The HTMX request will handle saving to the backend
        }

        function onVideoCanPlayThrough() {
            isVideoReady = true;
            console.log('Video can play through - fully ready for seeking');
        }

        function onVideoSeeking() {
            isSeeking = true;
            showLoading();
        }

        function onVideoSeeked() {
            isSeeking = false;
            hideLoading();
            console.log('Seek completed to:', video.currentTime);
        }

        function onVideoError(e) {
            console.error('Video error:', e);
            hideLoading();
        }

        function handleAdvancedTranscodeJobStart(event) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.job_id) {
                    // Add job to monitoring
                    videoActiveJobs.add(response.job_id);
                    showVideoJobsSection();
                    startVideoJobPolling();
                    
                    // Close the modal since job is started
                    closeAdvancedTranscodingModal();
                    
                    // Update status message
                    const statusDiv = document.getElementById('advanced-transcoding-status');
                    if (statusDiv) {
                        statusDiv.innerHTML = `<div class="text-blue-400">Started in background: ${response.message}</div>`;
                    }
                } else {
                    console.error('No job_id in response');
                }
            } catch (e) {
                console.error('Error parsing advanced transcode response:', e);
            }
        }

        function handleVideoJobStart(event) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.job_id) {
                    // Add job to monitoring
                    videoActiveJobs.add(response.job_id);
                    showVideoJobsSection();
                    startVideoJobPolling();
                    
                    // Update the status message with job info
                    const target = event.detail.target;
                    if (target) {
                        target.innerHTML = `<div class="text-blue-400">Started in background: ${response.message}</div>`;
                    }
                }
            } catch (e) {
                console.error('Error parsing video job start response:', e);
            }
        }

        // Background job monitoring for video page
        let videoActiveJobs = new Set();
        let videoJobPollingInterval = null;
        let previousVideoPageJobStates = new Map(); // To track job state changes for notifications

        // Toast Notification Container (add if not present, or ensure it exists in the base HTML structure)
        // For this example, assuming a global toast container or one added to video_player.html like others.
        // If not globally available, it would be added here:
        /*
        if (!document.getElementById('toast-container')) {
            const toastContainerHTML = '<div id="toast-container" class="fixed bottom-0 right-0 p-6 space-y-3 z-[100]"></div>';
            document.body.insertAdjacentHTML('beforeend', toastContainerHTML);
        }
        */

        function showVideoJobsSection() {
            document.getElementById('video-background-jobs').classList.remove('hidden');
        }

        function hideVideoJobs() {
            document.getElementById('video-background-jobs').classList.add('hidden');
            // Don't stop polling, just hide the UI
        }

        function startVideoJobPolling() {
            if (videoJobPollingInterval) return; // Already polling
            
            videoJobPollingInterval = setInterval(() => {
                if (videoActiveJobs.size === 0) {
                    stopVideoJobPolling();
                    return;
                }
                refreshVideoJobs();
            }, 2000); // Poll every 2 seconds
        }

        function stopVideoJobPolling() {
            if (videoJobPollingInterval) {
                clearInterval(videoJobPollingInterval);
                videoJobPollingInterval = null;
            }
        }

        function refreshVideoJobs() {
            fetch('/jobs')
                .then(response => response.json())
                .then(data => {
                    const relevantJobs = data.jobs.filter(job => videoActiveJobs.has(job.job_id) || previousVideoPageJobStates.has(job.job_id));
                    updateVideoJobsDisplay(relevantJobs); // Updates the inline job list for the video player
                    checkForVideoPageCompletedJobsAndNotify(relevantJobs); // For toast notifications
                })
                .catch(error => {
                    console.error('Error fetching video jobs:', error);
                });
        }

        function updateVideoJobsDisplay(jobs) {
            const container = document.getElementById('video-jobs-container');
            
            if (jobs.length === 0) {
                videoActiveJobs.clear();
                stopVideoJobPolling();
                setTimeout(() => {
                    if (videoActiveJobs.size === 0) {
                        hideVideoJobs();
                    }
                }, 2000);
                return;
            }

            // Update active jobs set and check for completed transcoding jobs
            const completedTranscodeJobs = [];
            videoActiveJobs.clear();
            jobs.forEach(job => {
                if (job.status === 'running') {
                    videoActiveJobs.add(job.job_id);
                } else if (job.status === 'completed' && (job.job_type === 'transcode_single' || job.job_type === 'transcode_single_advanced') && job.result && job.result.video_name) {
                    completedTranscodeJobs.push(job);
                }
            });

            container.innerHTML = jobs.map(job => createVideoJobElement(job)).join('');
            
            // Handle completed transcoding jobs - reload sidebar
            if (completedTranscodeJobs.length > 0) {
                console.log('Transcoding job(s) completed, reloading sidebar');
                reloadVideoSidebar(); // This existing function already handles sidebar refresh
            }
            
            // Stop polling if no running jobs related to this video page
            if (videoActiveJobs.size === 0) {
                setTimeout(() => {
                    if (videoActiveJobs.size === 0) {
                        stopVideoJobPolling();
                        // Consider hiding the video-specific job display area if empty
                        // if (container.children.length === 0) { hideVideoJobs(); }
                    }
                }, 5000); 
            }
        }

        function checkForVideoPageCompletedJobsAndNotify(newJobs) {
            newJobs.forEach(job => {
                const previousState = previousVideoPageJobStates.get(job.job_id);
                if (previousState === 'running' && (job.status === 'completed' || job.status === 'failed')) {
                    // Use a generic toast function, or one specific to video page if styles differ
                    showToastOnVideoPage(job.result?.message || job.error || `Job ${job.status}`, job.description, job.status);
                }
                previousVideoPageJobStates.set(job.job_id, job.status);
            });

            const currentJobIds = new Set(newJobs.map(j => j.job_id));
            for (const jobId of previousVideoPageJobStates.keys()) {
                if (!currentJobIds.has(jobId)) {
                    previousVideoPageJobStates.delete(jobId);
                }
            }
        }

        // Assuming a global or similarly styled toast function as in other pages
        // If not, define showToastOnVideoPage similarly to showToastOnToolsPage
        function showToastOnVideoPage(message, description, status = 'info') {
            const container = document.getElementById('toast-container-video'); // Use a specific ID for video page toasts
            if (!container) {
                console.warn("Toast container #toast-container-video not found on video page.");
                return;
            }

            const toastId = `toast-video-${Date.now()}`;
            const toast = document.createElement('div');
            toast.id = toastId;
            // Basic styling, can be enhanced
            toast.className = `max-w-sm w-full bg-slate-800 shadow-2xl rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden border ${status === 'completed' ? 'border-green-500' : status === 'failed' ? 'border-red-500' : 'border-blue-500'}`;

            const iconColor = status === 'completed' ? 'text-green-400' : status === 'failed' ? 'text-red-400' : 'text-blue-400';
            let iconSvg = '';
            if (status === 'completed') {
                iconSvg = `
                    <svg class="h-6 w-6 ${iconColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>`;
            } else if (status === 'failed') {
                iconSvg = `
                    <svg class="h-6 w-6 ${iconColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z" />
                    </svg>`;
            } else { 
                 iconSvg = `
                    <svg class="h-6 w-6 ${iconColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>`;
            }

            toast.innerHTML = `
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            ${iconSvg}
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-semibold text-slate-100">${description}</p>
                            <p class="mt-1 text-xs text-slate-300">${message}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button type="button" onclick="document.getElementById('${toastId}').remove()" class="inline-flex bg-slate-800 rounded-md p-1 text-slate-400 hover:text-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-600">
                                <span class="sr-only">Close</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                const currentToast = document.getElementById(toastId);
                if (currentToast) {
                    currentToast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => currentToast.remove(), 500);
                }
            }, 7000);
        }

        function createVideoJobElement(job) {
            const progressPercent = job.total > 0 ? Math.round((job.progress / job.total) * 100) : 0;
            const statusColor = {
                'running': 'text-blue-400',
                'completed': 'text-green-400',
                'failed': 'text-red-400'
            }[job.status] || 'text-slate-400';

            const statusIcon = {
                'running': '',
                'completed': '',
                'failed': ''
            }[job.status] || '';

            return `
                <div class="bg-slate-600/50 rounded-md p-3 border border-slate-500">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm">${statusIcon}</span>
                            <span class="text-xs font-medium text-slate-200">${job.description}</span>
                            <span class="text-xs ${statusColor} capitalize">${job.status}</span>
                        </div>
                        ${job.status !== 'running' ? `
                            <button onclick="removeVideoJob('${job.job_id}')" class="text-xs text-slate-400 hover:text-slate-300 px-1">
                                
                            </button>
                        ` : ''}
                    </div>
                    
                    ${job.status === 'running' ? `
                        <div class="mb-1">
                            <div class="text-xs text-slate-400 mb-1">${job.current_item || 'Processing...'}</div>
                            <div class="w-full bg-slate-600 rounded-full h-1.5">
                                <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${job.status === 'completed' && job.result ? `
                        <div class="text-xs text-green-400 mt-1">
                            ${job.result.message || 'Completed successfully'}
                        </div>
                    ` : ''}
                    
                    ${job.status === 'failed' && job.error ? `
                        <div class="text-xs text-red-400 mt-1">
                            Error: ${job.error}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function removeVideoJob(jobId) {
            fetch(`/jobs/${jobId}`, { method: 'DELETE' })
                .then(() => {
                    videoActiveJobs.delete(jobId);
                    refreshVideoJobs();
                })
                .catch(error => {
                    console.error('Error removing video job:', error);
                });
        }

        function reloadVideoSidebar() {
            // Trigger an HTMX request to reload the sidebar
            const sidebarElement = document.getElementById('video-metadata-sidebar');
            if (sidebarElement) {
                // Use HTMX to reload the sidebar content
                htmx.ajax('GET', window.location.pathname, {
                    target: '#video-metadata-sidebar',
                    swap: 'outerHTML',
                    select: '#video-metadata-sidebar'
                }).then(() => {
                    console.log('Video sidebar reloaded successfully');
                    // Re-initialize any necessary functionality
                    initializeChoices();
                }).catch(error => {
                    console.error('Failed to reload video sidebar:', error);
                });
            }
        }

        // Initialize video job monitoring on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing jobs related to this video on page load
            refreshVideoJobs();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopVideoJobPolling(); // Ensure polling stops if user navigates away
        });
    </script>

    <!-- Toast Notification Container for Video Page -->
    <div id="toast-container-video" class="fixed bottom-0 right-0 p-6 space-y-3 z-[100]">
        <!-- Toasts will be appended here -->
    </div>
</body>
</html> 