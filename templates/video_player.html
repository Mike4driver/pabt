<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.display_title }} - Media Browser</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a73e8',
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col font-sans">
    <header class="bg-slate-800 sticky top-0 z-50 border-b border-slate-700">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
             <div class="flex justify-between items-center h-16">
                <a href="/" class="text-xl lg:text-2xl font-semibold text-white hover:text-primary transition-colors duration-150">Media Browser</a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-screen-2xl p-4 md:p-6 lg:p-8">
        <div class="lg:flex lg:gap-6 xl:gap-8">
            <!-- Video Player Section -->
            <div class="lg:flex-grow mb-6 lg:mb-0">
                <!-- Video Title and Status -->
                <div class="mb-4" id="video-title-header">
                    <h1 class="text-2xl lg:text-3xl font-bold text-slate-100 mb-2 overflow-hidden whitespace-nowrap text-ellipsis" title="{{ video.display_title }}">{{ video.display_title }}</h1>
                    <div id="video-status-indicator">
                        {% if video.has_transcoded_version %}
                            <span class="text-xs font-medium bg-green-500/20 text-green-400 px-2 py-1 rounded-full">Playing Transcoded Version</span>
                        {% else %}
                            <span class="text-xs font-medium bg-amber-500/20 text-amber-400 px-2 py-1 rounded-full">Playing Original Version</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Video Player Container -->
                <div class="aspect-video bg-black rounded-lg overflow-hidden shadow-2xl">
                    <video id="main-video-player" 
                           class="w-full h-full" 
                           controls 
                           autoplay 
                           poster="{{ video.thumbnail }}"
                           preload="metadata">
                        <source src="{{ video.path }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>

            <!-- Metadata Sidebar Section -->
            {% include "_video_metadata_sidebar.html" %}
        </div>
    </main>

    <!-- Advanced Transcoding Modal -->
    <div id="advancedTranscodingModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-slate-900 bg-opacity-75" onclick="closeAdvancedTranscodingModal()"></div>

            <!-- Modal content -->
            <div class="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-slate-800 shadow-xl rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-slate-100">Advanced Transcoding Options</h3>
                    <button onclick="closeAdvancedTranscodingModal()" class="text-slate-400 hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <form hx-post="{{ url_for('transcode_specific_video_advanced_endpoint', video_name=video.name) }}" 
                      hx-target="#advanced-transcoding-status" 
                      hx-swap="innerHTML" 
                      hx-indicator="#advanced-loading-spinner"
                      hx-on::after-request="closeAdvancedTranscodingModal()">
                    
                    <div class="space-y-4">
                        <div>
                            <label for="modal-resolution" class="block text-sm font-medium text-slate-300 mb-2">Resolution</label>
                            <select name="resolution" id="modal-resolution" 
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="original">Original Resolution</option>
                                <option value="1080p">1080p (Full HD)</option>
                                <option value="720p" selected>720p (HD)</option>
                                <option value="480p">480p (SD)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-quality-mode" class="block text-sm font-medium text-slate-300 mb-2">Quality Mode</label>
                            <select name="quality_mode" id="modal-quality-mode" onchange="toggleModalQualityOptions()"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="crf" selected>CRF (Constant Quality)</option>
                                <option value="bitrate">Bitrate (Constant Rate)</option>
                            </select>
                        </div>
                        
                        <div id="modal-crf-container">
                            <label for="modal-crf" class="block text-sm font-medium text-slate-300 mb-2">CRF Quality (Lower = Better)</label>
                            <select name="crf" id="modal-crf"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="18">18 (Very High Quality)</option>
                                <option value="23" selected>23 (High Quality)</option>
                                <option value="28">28 (Medium Quality)</option>
                                <option value="32">32 (Lower Quality)</option>
                            </select>
                        </div>
                        
                        <div id="modal-bitrate-container" style="display: none;">
                            <label for="modal-video-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Video Bitrate</label>
                            <select name="video_bitrate" id="modal-video-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="1M">1 Mbps</option>
                                <option value="2M" selected>2 Mbps</option>
                                <option value="4M">4 Mbps</option>
                                <option value="8M">8 Mbps</option>
                                <option value="12M">12 Mbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-audio-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Audio Bitrate</label>
                            <select name="audio_bitrate" id="modal-audio-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="96k">96 kbps</option>
                                <option value="128k" selected>128 kbps</option>
                                <option value="192k">192 kbps</option>
                                <option value="256k">256 kbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-preset" class="block text-sm font-medium text-slate-300 mb-2">Encoding Speed</label>
                            <select name="preset" id="modal-preset"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="ultrafast">Ultra Fast (Larger Files)</option>
                                <option value="fast">Fast</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="slow">Slow (Better Compression)</option>
                            </select>
                        </div>

                        <div>
                            <label for="modal-profile" class="block text-sm font-medium text-slate-300 mb-2">H.264 Profile</label>
                            <select name="profile" id="modal-profile"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="baseline">Baseline (Max Compatibility)</option>
                                <option value="main">Main (Good Quality/Compatibility)</option>
                                <option value="high" selected>High (Best Quality)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button type="button" onclick="closeAdvancedTranscodingModal()" 
                                class="flex-1 bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 text-sm">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                            <span id="advanced-loading-spinner" class="htmx-indicator animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                            Start Transcoding
                        </button>
                    </div>
                </form>

                <div id="advanced-transcoding-status" class="mt-4 p-3 bg-slate-700/50 rounded-md min-h-[40px] text-sm text-slate-300"></div>
            </div>
        </div>
    </div>

    <script>
        let choicesTagsInstance = null;

        function initializeChoices() {
            const tagsInput = document.getElementById('tags-input');
            if (tagsInput) {
                if (choicesTagsInstance) {
                    choicesTagsInstance.destroy();
                }
                choicesTagsInstance = new Choices(tagsInput, {
                    removeItemButton: true,
                    delimiter: ',',
                    editItems: true,
                    allowHTML: false,
                    placeholderValue: 'Enter tags',
                    duplicateItemsAllowed: false,
                    classNames: {
                        containerOuter: 'choices choices-tags-outer',
                        containerInner: 'choices__inner bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus-within:ring-2 focus-within:ring-primary focus-within:border-primary min-h-[40px]',
                        input: 'choices__input choices__input--cloned text-slate-200',
                        inputCloned: 'choices__input--cloned',
                        list: 'choices__list',
                        listItems: 'choices__list--multiple',
                        listSingle: 'choices__list--single',
                        listDropdown: 'choices__list--dropdown',
                        item: 'choices__item bg-primary/80 border-primary/90 text-white',
                        itemSelectable: 'choices__item--selectable',
                        itemDisabled: 'choices__item--disabled',
                        itemChoice: 'choices__item--choice',
                        placeholder: 'choices__placeholder text-slate-500',
                        group: 'choices__group',
                        groupHeading : 'choices__heading',
                        button: 'choices__button',
                        activeState: 'is-active',
                        focusState: 'is-focused',
                        openState: 'is-open',
                        disabledState: 'is-disabled',
                        highlightedState: 'is-highlighted',
                        selectedState: 'is-selected',
                        flippedState: 'is-flipped',
                        loadingState: 'is-loading',
                        noResults: 'has-no-results',
                        noChoices: 'has-no-choices'
                    }
                });
            }
        }

        function toggleEditMetadataMode(editing) {
            const displaySection = document.getElementById('metadata-display-section');
            const editForm = document.getElementById('metadata-edit-form');
            const systemDetails = document.getElementById('system-details-section'); // For button positioning
            const editButton = document.getElementById('edit-metadata-button');

            if (editing) {
                displaySection.classList.add('hidden');
                editForm.classList.remove('hidden');
                systemDetails.classList.add('hidden'); // Hide system details during edit
                initializeChoices();
            } else {
                displaySection.classList.remove('hidden');
                editForm.classList.add('hidden');
                systemDetails.classList.remove('hidden'); // Show system details
                if (choicesTagsInstance) {
                   // choicesTagsInstance.destroy(); // Or just clear input if needed on cancel
                }
            }
        }
        
        function handleMetadataUpdateResponse(event) {
            const messageDiv = document.getElementById('metadata-edit-message');
            if (event.detail.successful) {
                // The hx-swap="outerHTML" on the form for #video-metadata-sidebar handles the UI update.
                // So, we just need to ensure we are back in display mode.
                // The new sidebar that is swapped in should be in display mode by default.
                // However, if the swap target was different, we might call toggleEditMetadataMode(false) here.
                // console.log("Metadata updated successfully, sidebar swapped.");
                // toggleEditMetadataMode(false); // Will be handled by full sidebar swap
            } else {
                if (messageDiv) {
                    let errorMsg = "Failed to update metadata.";
                    try {
                        const xhrResponse = JSON.parse(event.detail.xhr.responseText);
                        errorMsg = xhrResponse.detail || xhrResponse.message || errorMsg;
                    } catch (e) { /* Use default error msg */ }
                    messageDiv.innerHTML = `<p class="text-red-400">${errorMsg}</p>`;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup if needed (e.g. if form was visible by default)
            // toggleEditMetadataMode(false); // Ensure starts in display mode
        });

        // If HTMX swaps in the sidebar (e.g. after successful edit), re-ensure edit mode is off
        // and Choices.js is not active on a non-existent input if the form was destroyed.
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'video-metadata-sidebar') {
                toggleEditMetadataMode(false); // Ensure we are in display mode
                 const newEditButton = document.getElementById('edit-metadata-button');
                 if(newEditButton) {
                    // If new button exists, we can assume the display section is there.
                 } else {
                    // This case might happen if an error prevented full sidebar swap
                 }
            }
        });

        function openAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.remove('hidden');
        }

        function closeAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.add('hidden');
        }

        function toggleModalQualityOptions() {
            const qualityMode = document.getElementById('modal-quality-mode').value;
            const crfContainer = document.getElementById('modal-crf-container');
            const bitrateContainer = document.getElementById('modal-bitrate-container');
            
            if (qualityMode === 'crf') {
                crfContainer.style.display = 'block';
                bitrateContainer.style.display = 'none';
            } else {
                crfContainer.style.display = 'none';
                bitrateContainer.style.display = 'block';
            }
        }

        // Close modal when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAdvancedTranscodingModal();
            }
        });

        // Handle new transcode event triggered by HX-Trigger from server
        document.body.addEventListener('newTranscodeAvailable', function(event) {
            const newPath = event.detail.newPath;
            const fileName = event.detail.fileName;
            const player = document.getElementById('main-video-player');
            const videoStatusSpan = document.querySelector('#video-status-indicator span'); // More robust selector

            if (player && newPath) {
                player.src = newPath;
                player.load(); // Load the new source
                // player.play(); // Optionally auto-play
                
                if (videoStatusSpan) {
                    videoStatusSpan.textContent = `Playing Advanced Transcode: ${fileName}`;
                    videoStatusSpan.className = 'text-xs font-medium bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded-full';
                }
                
                // Update the download link if it needs to reflect the newest transcode (optional)
                // const downloadLink = document.getElementById('download-original-link');
                // if(downloadLink) { /* update if needed */ }

                // Close the modal as the primary action is complete
                closeAdvancedTranscodingModal(); 
                
                // Optionally, disable the basic transcode button if this advanced one supersedes it
                const basicTranscodeButton = document.querySelector('button[hx-post*="transcode_specific_video_endpoint"]');
                if (basicTranscodeButton) {
                    // basicTranscodeButton.disabled = true;
                    // basicTranscodeButton.innerText = 'Advanced Version Created';
                }
            } else {
                console.error("Could not update player. Player or newPath missing.", event.detail);
            }
        });
    </script>
</body>
</html> 