<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.display_title }} - Media Browser</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script> <!-- Added Alpine.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a73e8',
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar for Webkit browsers */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }

        /* For Firefox - not as customizable but can set basic colors */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #475569 transparent; /* thumb and track */
        }

        /* Standardized Button Styles */
        .btn-base {
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            outline: none;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: none;
            cursor: pointer;
            text-decoration: none;
        }
        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }
        .btn-primary:hover {
            background-color: rgba(26, 115, 232, 0.9);
        }
        .btn-primary:focus {
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.6), 0 0 0 4px rgba(15, 23, 42, 1);
        }
        .btn-secondary {
            color: white;
        }
        .btn-secondary:focus {
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.6), 0 0 0 4px rgba(15, 23, 42, 1);
        }
        .btn-destructive {
            background-color: #b91c1c;
            color: white;
        }
        .btn-destructive:hover {
            background-color: #dc2626;
        }
        .btn-destructive:focus {
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.6), 0 0 0 4px rgba(15, 23, 42, 1);
        }
        .btn-destructive-secondary {
            background-color: #dc2626;
            color: white;
        }
        .btn-destructive-secondary:hover {
            background-color: #ef4444;
        }
        .btn-destructive-secondary:focus {
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.6), 0 0 0 4px rgba(15, 23, 42, 1);
        }

    </style>
</head>
<body class="bg-slate-900 text-slate-200 h-full flex flex-col font-sans overflow-hidden">
    <header class="bg-slate-800 flex-shrink-0 z-50 border-b border-slate-700 shadow-lg">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Main Navigation Bar -->
            <div class="flex justify-between items-center h-16">
                <!-- Brand/Logo -->
                <div class="flex-shrink-0">
                    <a href="/" class="text-xl font-bold text-white hover:text-primary transition-colors duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2 text-primary">
                            <path d="M4.5 6.375a4.125 4.125 0 1 1 8.25 0 4.125 4.125 0 0 1-8.25 0ZM14.25 8.625a3.375 3.375 0 1 1 6.75 0 3.375 3.375 0 0 1-6.75 0ZM1.5 19.125a7.125 7.125 0 0 1 14.25 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM17.25 19.128l-.001.144a2.25 2.25 0 0 1-.233.96 10.088 10.088 0 0 0 5.06-1.01.75.75 0 0 0 .42-.643 4.875 4.875 0 0 0-6.957-4.611 8.586 8.586 0 0 1 1.71 5.157l.001.003Z"/>
                        </svg>
                        Media Browser
                    </a>
                </div>

                <!-- Center - Now Playing Info -->
                <div class="flex-1 max-w-2xl mx-6 text-center">
                    <div class="text-sm text-slate-400 font-medium">Now Playing</div>
                    <div class="text-slate-200 text-lg font-semibold truncate" title="{{ video.display_title }}">{{ video.display_title }}</div>
                </div>

                <!-- Right Navigation -->
                <div class="flex items-center space-x-2">
                    <!-- Mobile Queue Toggle (visible only on mobile) -->
                    {% if video_queue %}
                    <button onclick="toggleQueueSidebar()" 
                            class="lg:hidden inline-flex items-center p-2 text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200 border border-transparent hover:border-slate-600"
                            title="Show queue">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M3 6.75A.75.75 0 013.75 6h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 6.75zM3 12a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75A.75.75 0 013 12zm0 5.25a.75.75 0 01.75-.75h16.5a.75.75 0 010 1.5H3.75a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                        </svg>
                        <span class="ml-1 text-xs">Queue</span>
                    </button>
                    {% endif %}
                    <!-- Tools Menu -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" 
                                class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200 border border-transparent hover:border-slate-600">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2">
                                <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 0 1 8.82 1h2.36a1 1 0 0 1 .98.804l.331 1.652a6.993 6.993 0 0 1 1.929 1.115l1.598-.54a1 1 0 0 1 1.186.447l1.18 2.044a1 1 0 0 1-.205 1.251l-1.267 1.113a7.047 7.047 0 0 1 0 2.228l1.267 1.113a1 1 0 0 1 .206 1.25l-1.18 2.045a1 1 0 0 1-1.187.447l-1.598-.54a6.993 6.993 0 0 1-1.929 1.115l-.33 1.652a1 1 0 0 1-.98.804H8.82a1 1 0 0 1-.98-.804l-.331-1.652a6.993 6.993 0 0 1-1.929-1.115l-1.598.54a1 1 0 0 1-1.186-.447l-1.18-2.044a1 1 0 0 1 .205-1.251l1.267-1.114a7.05 7.05 0 0 1 0-2.227L1.821 7.773a1 1 0 0 1-.206-1.25l1.18-2.045a1 1 0 0 1 1.187-.447l1.598.54A6.992 6.992 0 0 1 7.51 3.456l.33-1.652ZM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" clip-rule="evenodd" />
                            </svg>
                            Tools
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1 opacity-70">
                                <path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div x-show="open" 
                             @click.away="open = false"
                             x-transition:enter="transition ease-out duration-200" 
                             x-transition:enter-start="opacity-0 scale-95" 
                             x-transition:enter-end="opacity-100 scale-100" 
                             x-transition:leave="transition ease-in duration-150" 
                             x-transition:leave-start="opacity-100 scale-100" 
                             x-transition:leave-end="opacity-0 scale-95"
                             class="absolute right-0 mt-2 w-56 bg-slate-800 border border-slate-700 rounded-lg shadow-xl py-1 z-20 backdrop-blur-sm">
                            <a href="{{ url_for('tools_page') }}" 
                               class="flex items-center px-4 py-3 text-sm text-slate-300 hover:bg-slate-700/50 hover:text-white transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-3 text-slate-400">
                                    <path fill-rule="evenodd" d="M1 5.25A2.25 2.25 0 0 1 3.25 3h13.5A2.25 2.25 0 0 1 19 5.25v9.5A2.25 2.25 0 0 1 16.75 17H3.25A2.25 2.25 0 0 1 1 14.75v-9.5Zm1.5 5.81v3.69c0 .414.336.75.75.75h13.5a.75.75 0 0 0 .75-.75v-2.69l-2.22-2.219a.75.75 0 0 0-1.06 0l-1.91 1.909.47.47a.75.75 0 1 1-1.06 1.06L6.53 8.091a.75.75 0 0 0-1.06 0l-2.97 2.97ZM12 7a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z" clip-rule="evenodd" />
                                </svg>
                                Media Processing
                            </a>
                            <a href="{{ url_for('ml_processing_page') }}" 
                               class="flex items-center px-4 py-3 text-sm text-slate-300 hover:bg-slate-700/50 hover:text-white transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-3 text-slate-400">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                                ML Video Processing
                            </a>
                            <a href="{{ url_for('background_jobs_page') }}" 
                               class="flex items-center px-4 py-3 text-sm text-slate-300 hover:bg-slate-700/50 hover:text-white transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-3 text-slate-400">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.236 4.53L8.107 10.5a.75.75 0 0 0-1.214 1.007l1.643 2.25a.75.75 0 0 0 1.214-.007l3.857-5.557Z" clip-rule="evenodd" />
                                </svg>
                                Background Jobs
                            </a>
                        </div>
                    </div>
                    
                    <!-- Settings -->
                    <a href="{{ url_for('settings_page') }}" 
                       class="inline-flex items-center p-2 text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200 border border-transparent hover:border-slate-600"
                       title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 0 1 8.82 1h2.36a1 1 0 0 1 .98.804l.331 1.652a6.993 6.993 0 0 1 1.929 1.115l1.598-.54a1 1 0 0 1 1.186.447l1.18 2.044a1 1 0 0 1-.205 1.251l-1.267 1.113a7.047 7.047 0 0 1 0 2.228l1.267 1.113a1 1 0 0 1 .206 1.25l-1.18 2.045a1 1 0 0 1-1.187.447l-1.598-.54a6.993 6.993 0 0 1-1.929 1.115l-.33 1.652a1 1 0 0 1-.98.804H8.82a1 1 0 0 1-.98-.804l-.331-1.652a6.993 6.993 0 0 1-1.929-1.115l-1.598.54a1 1 0 0 1-1.186-.447l-1.18-2.044a1 1 0 0 1 .205-1.251l1.267-1.114a7.05 7.05 0 0 1 0-2.227L1.821 7.773a1 1 0 0 1-.206-1.25l1.18-2.045a1 1 0 0 1 1.187-.447l1.598.54A6.992 6.992 0 0 1 7.51 3.456l.33-1.652ZM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden" style="height: calc(100vh - 4rem);">
        <!-- Video Queue Sidebar -->
        {% if video_queue %}
        <div id="queue-sidebar" class="w-80 md:w-80 bg-slate-800 border-r border-slate-700 flex flex-col h-full transition-all duration-300 relative">
            <!-- Queue Header -->
            <div class="flex items-center justify-between p-4 border-b border-slate-700 bg-slate-800/95 backdrop-blur-sm">
                <div class="flex items-center space-x-2 queue-header-content">
                    <h2 class="text-lg font-semibold text-slate-100">Up Next</h2>
                    <span class="text-slate-400 text-sm">({{ video_queue|length }})</span>
                    {% if search_query or current_media_type or current_tags or current_sort_by != 'date_added' or current_sort_order != 'desc' %}
                        <span class="text-xs text-blue-400 bg-blue-500/20 px-2 py-1 rounded-full">Filtered</span>
                    {% endif %}
                </div>
                
                <!-- Collapse/Expand Button -->
                <button id="queue-toggle-btn" onclick="toggleQueueSidebar()" 
                        class="p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-700 rounded-md transition-colors duration-200 flex-shrink-0"
                        title="Collapse queue (Q)">
                    <svg id="queue-collapse-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                        <path d="M15 18L9 12l6-6"/>
                    </svg>
                    <svg id="queue-expand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 hidden">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
            </div>
            
            <!-- Collapsed State Indicator -->
            <div id="queue-collapsed-indicator" class="hidden flex-col items-center justify-center h-full bg-slate-800 border-r border-slate-700">
                <!-- Expand Button at Top -->
                <button onclick="toggleQueueSidebar()" 
                        class="p-2 text-slate-400 hover:text-slate-200 hover:bg-slate-700 rounded-md transition-colors duration-200 mb-6"
                        title="Expand queue (Q)">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
                
                <!-- Vertical Text -->
                <div class="flex flex-col items-center space-y-4">
                    <div class="text-slate-400 text-xs font-medium transform -rotate-90 whitespace-nowrap select-none">
                        Queue
                    </div>
                    <div class="w-6 h-px bg-slate-600"></div>
                    <div class="text-slate-500 text-xs font-medium transform -rotate-90 whitespace-nowrap select-none">
                        {{ video_queue|length }}
                    </div>
                </div>
                
                <!-- Current Video Indicator -->
                <div class="mt-6 w-2 h-2 bg-primary rounded-full opacity-60"></div>
            </div>

            <!-- Autoplay Controls -->
            <div class="autoplay-controls px-4 py-3 border-b border-slate-700 bg-slate-700/30">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-slate-300">Autoplay Next</span>
                    <button id="autoplay-next-toggle" 
                            onclick="toggleAutoplayNext()"
                            class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-slate-800 {{ 'bg-primary' if autoplay_next else 'bg-slate-600' }}"
                            hx-post="/settings/autoplay-next"
                            hx-vals='js:{"autoplay_next": document.getElementById("autoplay-next-toggle").dataset.enabled}'
                            hx-target="#autoplay-toggle-status"
                            hx-swap="innerHTML"
                            hx-trigger="click"
                            hx-include="this"
                            hx-on:htmx:after-request="setTimeout(() => { document.getElementById('autoplay-toggle-status').innerHTML = ''; }, 3000);">
                        <span id="autoplay-toggle-dot" class="absolute left-0.5 inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform duration-200 {{ 'translate-x-4' if autoplay_next else 'translate-x-0' }}"></span>
                    </button>
                </div>
                <div id="autoplay-toggle-status" class="mt-1 text-xs"></div>
            </div>

            <!-- Filter Details -->
            {% if search_query or current_media_type or current_tags or current_sort_by != 'date_added' or current_sort_order != 'desc' %}
            <div class="filter-details px-4 py-3 bg-slate-700/30 border-b border-slate-600">
                <div class="text-xs text-slate-400 mb-2">Active Filters:</div>
                <div class="flex flex-wrap gap-1 text-xs">
                    {% if search_query %}
                        <span class="bg-blue-500/20 text-blue-300 px-2 py-1 rounded">Search: "{{ search_query }}"</span>
                    {% endif %}
                    {% if current_media_type %}
                        <span class="bg-green-500/20 text-green-300 px-2 py-1 rounded">{{ current_media_type.title() }}</span>
                    {% endif %}
                    {% if current_tags %}
                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded">{{ current_tags }}</span>
                    {% endif %}
                    {% if current_sort_by != 'date_added' or current_sort_order != 'desc' %}
                        <span class="bg-orange-500/20 text-orange-300 px-2 py-1 rounded">
                            {{ current_sort_by.replace('_', ' ').title() }} 
                            {{ 'Asc' if current_sort_order == 'asc' else 'Desc' }}
                        </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Queue Content -->
            <div id="video-queue-container" class="flex-1 overflow-y-auto custom-scrollbar">
                <div class="p-3 space-y-2">
                    {% for q_video in video_queue %}
                        {% set queue_url_params = [] %}
                        {% if search_query %}{% set _ = queue_url_params.append('search=' + search_query|urlencode) %}{% endif %}
                        {% if current_media_type %}{% set _ = queue_url_params.append('media_type=' + current_media_type|urlencode) %}{% endif %}
                        {% if current_tags %}{% set _ = queue_url_params.append('tags=' + current_tags|urlencode) %}{% endif %}
                        {% if current_sort_by and current_sort_by != 'date_added' %}{% set _ = queue_url_params.append('sort_by=' + current_sort_by|urlencode) %}{% endif %}
                        {% if current_sort_order and current_sort_order != 'desc' %}{% set _ = queue_url_params.append('sort_order=' + current_sort_order|urlencode) %}{% endif %}
                        {% set queue_url_query = '?' + queue_url_params|join('&') if queue_url_params else '' %}
                        
                        <a href="{{ (url_for('video_player_page', video_name=q_video.name) | string) + queue_url_query }}" 
                           id="{{ 'current-video-in-queue' if q_video.id_db == video.id_db else 'queue-item-' + loop.index|string }}"
                           class="flex flex-col p-2 rounded-lg transition-all duration-150 group border
                                  {% if q_video.id_db == video.id_db %}
                                      bg-primary/20 border-primary/50 shadow-md ring-1 ring-primary/30
                                  {% else %}
                                      hover:bg-slate-700/60 border-transparent hover:border-slate-600
                                  {% endif %}"
                           title="{{ q_video.display_title }}">
                            <div class="relative">
                                <img src="{{ q_video.thumbnail_url_or_generic }}" alt="Thumbnail for {{ q_video.display_title }}" 
                                     class="w-full aspect-video object-cover rounded-md mb-2 border border-slate-600">
                                {% if q_video.has_ml_analysis %}
                                <span class="absolute top-1 right-1 bg-blue-500/90 text-white text-xs px-1 py-0.5 rounded-sm font-medium flex items-center" title="ML Analysis: {{ q_video.ml_analysis_info.frame_count or 0 }} frames processed">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-2.5 h-2.5 mr-0.5">
                                        <path d="M8 2L2 7l6 5 6-5-6-5zM2 12l6 5 6-5M2 9l6 5 6-5"/>
                                    </svg>
                                    ML
                                </span>
                                {% endif %}
                            </div>
                            <div class="flex-grow">
                                <p class="text-sm font-medium line-clamp-2 leading-tight mb-1
                                          {% if q_video.id_db == video.id_db %}
                                              text-primary
                                          {% else %}
                                              text-slate-200 group-hover:text-primary
                                          {% endif %}">
                                    {{ q_video.display_title }}
                                </p>
                                <div class="flex items-center justify-between text-xs text-slate-400">
                                    <span>{{ q_video.duration_formatted if q_video.duration_formatted else 'N/A' }}</span>
                                    {% if q_video.id_db == video.id_db %}
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-primary">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                        </svg>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

                <!-- Main Content Area -->
        <div class="flex-1 flex flex-col min-w-0 h-full overflow-hidden">
            <div class="flex-1 flex flex-col lg:flex-row gap-4 lg:gap-6 xl:gap-8 p-3 md:p-4 lg:p-6 xl:p-8 min-h-0">
                <!-- Video Player Section -->
                <div class="flex-1 flex flex-col min-w-0">
                <!-- Video Title and Status -->
                <div class="mb-4" id="video-title-header">
                    <h1 class="text-2xl lg:text-3xl font-bold text-slate-100 mb-2 overflow-hidden whitespace-nowrap text-ellipsis" title="{{ video.display_title }}">{{ video.display_title }}</h1>
                    <div id="video-status-indicator" class="flex items-center space-x-2">
                        {% if video.has_transcoded_version %}
                            <span class="text-xs font-medium bg-green-500/20 text-green-400 px-2 py-1 rounded-full">Playing Transcoded Version</span>
                        {% else %}
                            <span class="text-xs font-medium bg-amber-500/20 text-amber-400 px-2 py-1 rounded-full">Playing Original Version</span>
                        {% endif %}
                        
                        {% if video.has_ml_analysis %}
                            <span class="text-xs font-medium bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full flex items-center" title="ML Analysis: {{ video.ml_analysis_info.frame_count or 0 }} frames processed with {{ video.ml_analysis_info.model_name or 'unknown model' }}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3 h-3 mr-1">
                                    <path d="M8 2L2 7l6 5 6-5-6-5zM2 12l6 5 6-5M2 9l6 5 6-5"/>
                                </svg>
                                ML Analysis Available
                            </span>
                        {% endif %}
                        
                        <!-- Auto Replay Status Indicator -->
                        <span id="auto-replay-indicator" class="text-xs font-medium bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full flex items-center {{ 'block' if auto_replay else 'hidden' }}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-3 h-3 mr-1">
                                <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0112.548-3.364l1.903 1.903h-3.183a.75.75 0 100 1.5h4.992a.75.75 0 00.75-.75V4.356a.75.75 0 00-1.5 0v3.18l-1.9-1.9A9 9 0 003.306 9.67a.75.75 0 101.45.388zm15.408 3.352a.75.75 0 00-.919.53 7.5 7.5 0 01-12.548 3.364l-1.902-1.903h3.183a.75.75 0 000-1.5H2.984a.75.75 0 00-.75.75v4.992a.75.75 0 001.5 0v-3.18l1.9 1.9a9 9 0 0015.059-4.035.75.75 0 00-.53-.918z" clip-rule="evenodd" />
                            </svg>
                            Auto Replay
                        </span>
                    </div>
                </div>

                <!-- Custom Video Player Container -->
                <div class="flex-1 bg-black rounded-lg overflow-hidden shadow-2xl relative group {{ 'ring-2 ring-blue-500/50 shadow-blue-500/20' if auto_replay else '' }} min-h-0" id="video-player-container">
                    <video id="main-video-player" 
                           class="w-full h-full" 
                           poster="{{ video.thumbnail }}"
                           preload="metadata"
                           {% if autoplay_enabled %}autoplay{% endif %}
                           {% if default_muted %}muted{% endif %}
                           onclick="togglePlay()"
                           crossorigin="anonymous">
                        <source src="{{ video.path }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    
                    <!-- Custom Video Controls -->
                    <div id="video-controls" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/60 to-transparent p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <!-- Timeline Container -->
                        <div class="mb-3">
                            <div class="flex items-center text-white text-sm mb-2">
                                <!-- This time display is removed as it's redundant with the one in the main controls bar -->
                                <!-- <span id="current-time">0:00</span> -->
                                <!-- <span class="mx-2">/</span> -->
                                <!-- <span id="duration">0:00</span> -->
                            </div>
                            <!-- Timeline -->
                            <div class="relative h-2 bg-white/20 rounded-full cursor-pointer" id="timeline-container">
                                <div id="timeline-progress" class="absolute top-0 left-0 h-full bg-primary rounded-full pointer-events-none" style="width: 0%"></div>
                                <div id="timeline-handle" class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-lg opacity-0 transition-opacity duration-200 pointer-events-none" style="left: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <!-- Play/Pause Button -->
                                <button id="play-pause-btn" onclick="togglePlay()" class="text-white hover:text-primary transition-colors duration-150">
                                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                                    </svg>
                                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 hidden">
                                        <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0114.25 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75h-1.5a.75.75 0 01-.75-.75V5.25z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                
                                <!-- Volume Controls -->
                                <div class="flex items-center space-x-2">
                                    <button id="mute-btn" onclick="toggleMute()" class="text-white hover:text-primary transition-colors duration-150">
                                        <svg id="volume-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                                        </svg>
                                        <svg id="mute-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 hidden">
                                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                                        </svg>
                                    </button>
                                    <div class="w-16 h-1 bg-white/20 rounded-full cursor-pointer" id="volume-container" onclick="setVolume(event)">
                                        <div id="volume-progress" class="h-full bg-white rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                                
                                <!-- Time Display -->
                                <div class="text-white text-sm">
                                    <span id="current-time-main">0:00</span> / <span id="duration-main">0:00</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-3">
                                <!-- Speed Control -->
                                <div class="relative">
                                    <button id="speed-btn" onclick="toggleSpeedMenu()" class="text-white hover:text-primary transition-colors duration-150 text-sm font-medium">
                                        1x
                                    </button>
                                    <div id="speed-menu" class="absolute bottom-8 right-0 bg-slate-800 border border-slate-600 rounded-lg py-2 min-w-16 hidden">
                                        <button onclick="setSpeed(0.5)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">0.5x</button>
                                        <button onclick="setSpeed(0.75)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">0.75x</button>
                                        <button onclick="setSpeed(1)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">1x</button>
                                        <button onclick="setSpeed(1.25)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">1.25x</button>
                                        <button onclick="setSpeed(1.5)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">1.5x</button>
                                        <button onclick="setSpeed(2)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">2x</button>
                                    </div>
                                </div>
                                
                                <!-- Frame Search Button -->
                                <button id="frame-search-btn" 
                                        onclick="openFrameSearchModal()"
                                        class="text-white hover:text-primary transition-colors duration-150"
                                        title="Search by frame">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                        <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd" />
                                    </svg>
                                </button>

                                <!-- Keyboard Shortcuts Help Button -->
                                <button id="keyboard-shortcuts-btn" 
                                        onclick="openKeyboardShortcutsModal()"
                                        class="text-white hover:text-primary transition-colors duration-150"
                                        title="Keyboard shortcuts (?)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 01-.988-1.129c1.454-1.272 3.776-1.272 5.23 0 1.513 1.324 1.513 3.518 0 4.842a3.75 3.75 0 01-.837.552c-.676.328-1.028.774-1.028 1.152v.75a.75.75 0 01-1.5 0v-.75c0-1.279.8-2.38 1.532-2.757.602-.293 1.163-.816 1.163-1.645 0-.59-.327-1.376-.317-2.015zM12 18a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                
                                <!-- Auto Replay Toggle -->
                                <button id="auto-replay-toggle" 
                                        onclick="toggleAutoReplay()"
                                        class="text-white hover:text-primary transition-colors duration-150 {{ 'text-primary' if auto_replay else 'text-slate-400' }}"
                                        title="Toggle auto replay"
                                        hx-post="/settings/auto-replay"
                                        hx-vals='js:{"auto_replay": document.getElementById("auto-replay-toggle").dataset.enabled}'
                                        hx-target="#auto-replay-status"
                                        hx-swap="innerHTML"
                                        hx-trigger="click"
                                        hx-include="this"
                                        hx-on:htmx:after-request="setTimeout(() => { document.getElementById('auto-replay-status').innerHTML = ''; }, 5000);">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                        <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0112.548-3.364l1.903 1.903h-3.183a.75.75 0 100 1.5h4.992a.75.75 0 00.75-.75V4.356a.75.75 0 00-1.5 0v3.18l-1.9-1.9A9 9 0 003.306 9.67a.75.75 0 101.45.388zm15.408 3.352a.75.75 0 00-.919.53 7.5 7.5 0 01-12.548 3.364l-1.902-1.903h3.183a.75.75 0 000-1.5H2.984a.75.75 0 00-.75.75v4.992a.75.75 0 001.5 0v-3.18l1.9 1.9a9 9 0 0015.059-4.035.75.75 0 00-.53-.918z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                
                                <!-- Fullscreen Button -->
                                <button id="fullscreen-btn" onclick="toggleFullscreen()" class="text-white hover:text-primary transition-colors duration-150">
                                    <svg id="fullscreen-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                        <path fill-rule="evenodd" d="M15 3.75a.75.75 0 01.75-.75h4.5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0V5.56l-3.97 3.97a.75.75 0 11-1.06-1.06l3.97-3.97h-2.69a.75.75 0 01-.75-.75zm-12 0A.75.75 0 013.75 3h4.5a.75.75 0 010 1.5H5.56l3.97 3.97a.75.75 0 01-1.06 1.06L4.5 5.56v2.69A.75.75 0 013 7.5v-4.5zm11.47 11.78a.75.75 0 111.06-1.06l3.97 3.97v-2.69a.75.75 0 011.5 0v4.5a.75.75 0 01-.75.75h-4.5a.75.75 0 010-1.5h2.69l-3.97-3.97zm-4.94-1.06a.75.75 0 010 1.06L5.56 19.5h2.69a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75v-4.5a.75.75 0 011.5 0v2.69l3.97-3.97a.75.75 0 011.06 0z" clip-rule="evenodd" />
                                    </svg>
                                    <svg id="exit-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 hidden">
                                        <path fill-rule="evenodd" d="M9.53 2.47a.75.75 0 010 1.06L6.81 6.25H9.5a.75.75 0 010 1.5H6.75a.75.75 0 01-.75-.75V4.25a.75.75 0 011.5 0v2.69L10.22 4.22a.75.75 0 011.06 0zM2.47 9.53a.75.75 0 011.06 0L6.25 6.81V9.5a.75.75 0 001.5 0V6.75a.75.75 0 00-.75-.75H4.25a.75.75 0 000 1.5h2.69L4.22 10.22a.75.75 0 000 1.06zm16.28 4.94a.75.75 0 01-1.06 0L14.97 11.75H17.5a.75.75 0 000-1.5h-2.75a.75.75 0 00-.75.75v2.75a.75.75 0 001.5 0v-2.69l2.72 2.72a.75.75 0 000 1.06zm-4.94 4.94a.75.75 0 010-1.06L16.53 15.75H14.5a.75.75 0 010-1.5h2.75a.75.75 0 01.75.75v2.75a.75.75 0 01-1.5 0V14.97l-2.72 2.72a.75.75 0 01-1.06 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-black/50 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    </div>

                    <!-- Auto Replay Status -->
                    <div id="auto-replay-status" class="absolute top-4 left-4"></div>

                    <!-- Autoplay Muted Notification -->
                    <div id="autoplay-muted-notice" class="absolute top-4 right-4 bg-black/80 text-white px-4 py-2 rounded-lg shadow-lg hidden">
                        <div class="flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                            </svg>
                            <span class="text-sm">Video is muted</span>
                            <button onclick="unmuteVideo()" class="bg-primary hover:bg-primary/80 text-white text-xs px-2 py-1 rounded transition-colors duration-150">
                                Unmute
                            </button>
                        </div>
                    </div>
                    
                    <!-- Center Play Button -->
                    <div id="center-play-btn" class="absolute inset-0 flex items-center justify-center cursor-pointer" onclick="togglePlay()">
                        <div class="bg-black/60 rounded-full p-4 hover:bg-black/80 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-white">
                                <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Previous Video Button -->
                    {% set prev_video = get_previous_video_in_queue(video_queue, video.id_db) %}
                    {% if prev_video %}
                        {% set prev_url_params = [] %}
                        {% if search_query %}{% set _ = prev_url_params.append('search=' + search_query|urlencode) %}{% endif %}
                        {% if current_media_type %}{% set _ = prev_url_params.append('media_type=' + current_media_type|urlencode) %}{% endif %}
                        {% if current_tags %}{% set _ = prev_url_params.append('tags=' + current_tags|urlencode) %}{% endif %}
                        {% if current_sort_by and current_sort_by != 'date_added' %}{% set _ = prev_url_params.append('sort_by=' + current_sort_by|urlencode) %}{% endif %}
                        {% if current_sort_order and current_sort_order != 'desc' %}{% set _ = prev_url_params.append('sort_order=' + current_sort_order|urlencode) %}{% endif %}
                        {% set prev_url_query = '?' + prev_url_params|join('&') if prev_url_params else '' %}
                        
                        <div class="absolute left-4 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <a href="{{ (url_for('video_player_page', video_name=prev_video.name) | string) + prev_url_query }}" 
                               class="flex items-center justify-center w-12 h-12 bg-black/60 hover:bg-black/80 rounded-full transition-colors duration-200 text-white hover:text-primary"
                               title="Previous video: {{ prev_video.display_title }}"
                               onclick="event.stopPropagation();">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                    <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 010-1.06l7.5-7.5a.75.75 0 111.06 1.06L9.31 12l6.97 6.97a.75.75 0 11-1.06 1.06l-7.5-7.5z" clip-rule="evenodd" />
                                </svg>
                            </a>
                        </div>
                    {% endif %}
                    
                    <!-- Next Video Button -->
                    {% if next_video %}
                        {% set next_url_params = [] %}
                        {% if search_query %}{% set _ = next_url_params.append('search=' + search_query|urlencode) %}{% endif %}
                        {% if current_media_type %}{% set _ = next_url_params.append('media_type=' + current_media_type|urlencode) %}{% endif %}
                        {% if current_tags %}{% set _ = next_url_params.append('tags=' + current_tags|urlencode) %}{% endif %}
                        {% if current_sort_by and current_sort_by != 'date_added' %}{% set _ = next_url_params.append('sort_by=' + current_sort_by|urlencode) %}{% endif %}
                        {% if current_sort_order and current_sort_order != 'desc' %}{% set _ = next_url_params.append('sort_order=' + current_sort_order|urlencode) %}{% endif %}
                        {% set next_url_query = '?' + next_url_params|join('&') if next_url_params else '' %}
                        
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <a href="{{ (url_for('video_player_page', video_name=next_video.name) | string) + next_url_query }}" 
                               class="flex items-center justify-center w-12 h-12 bg-black/60 hover:bg-black/80 rounded-full transition-colors duration-200 text-white hover:text-primary"
                               title="Next video: {{ next_video.display_title }}"
                               onclick="event.stopPropagation();">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                    <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 010 1.06l-7.5 7.5a.75.75 0 01-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 011.06-1.06l7.5 7.5z" clip-rule="evenodd" />
                                </svg>
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

                            <!-- Metadata Sidebar Section -->
                <div class="lg:w-80 xl:w-96 flex-shrink-0 h-full">
                    {% include "_video_metadata_sidebar.html" %}
                </div>
            </div>
        </div>

    </main>

    <!-- Advanced Transcoding Modal -->
    <div id="advancedTranscodingModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-slate-900 bg-opacity-75" onclick="closeAdvancedTranscodingModal()"></div>

            <!-- Modal content -->
            <div class="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-slate-800 shadow-xl rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-slate-100">Advanced Transcoding Options</h3>
                    <button onclick="closeAdvancedTranscodingModal()" class="text-slate-400 hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <form hx-post="{{ url_for('transcode_specific_video_advanced_endpoint', video_name=video.name) }}" 
                      hx-target="#advanced-transcoding-status" 
                      hx-swap="innerHTML" 
                      hx-indicator="#advanced-loading-spinner"
                      hx-on:htmx:after-request="handleAdvancedTranscodeJobStart(event)">
                    
                    <div class="space-y-4">
                        <div>
                            <label for="modal-resolution" class="block text-sm font-medium text-slate-300 mb-2">Resolution</label>
                            <select name="resolution" id="modal-resolution" 
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="original">Original Resolution</option>
                                <option value="1080p">1080p (Full HD)</option>
                                <option value="720p" selected>720p (HD)</option>
                                <option value="480p">480p (SD)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-quality-mode" class="block text-sm font-medium text-slate-300 mb-2">Quality Mode</label>
                            <select name="quality_mode" id="modal-quality-mode" onchange="toggleModalQualityOptions()"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="crf" selected>CRF (Constant Quality)</option>
                                <option value="bitrate">Bitrate (Constant Rate)</option>
                            </select>
                        </div>
                        
                        <div id="modal-crf-container">
                            <label for="modal-crf" class="block text-sm font-medium text-slate-300 mb-2">CRF Quality (Lower = Better)</label>
                            <select name="crf" id="modal-crf"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="18">18 (Very High Quality)</option>
                                <option value="23" selected>23 (High Quality)</option>
                                <option value="28">28 (Medium Quality)</option>
                                <option value="32">32 (Lower Quality)</option>
                            </select>
                        </div>
                        
                        <div id="modal-bitrate-container" style="display: none;">
                            <label for="modal-video-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Video Bitrate</label>
                            <select name="video_bitrate" id="modal-video-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="1M">1 Mbps</option>
                                <option value="2M" selected>2 Mbps</option>
                                <option value="4M">4 Mbps</option>
                                <option value="8M">8 Mbps</option>
                                <option value="12M">12 Mbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-audio-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Audio Bitrate</label>
                            <select name="audio_bitrate" id="modal-audio-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="96k">96 kbps</option>
                                <option value="128k" selected>128 kbps</option>
                                <option value="192k">192 kbps</option>
                                <option value="256k">256 kbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-preset" class="block text-sm font-medium text-slate-300 mb-2">Encoding Speed</label>
                            <select name="preset" id="modal-preset"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="ultrafast">Ultra Fast (Larger Files)</option>
                                <option value="fast">Fast</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="slow">Slow (Better Compression)</option>
                            </select>
                        </div>

                        <div>
                            <label for="modal-profile" class="block text-sm font-medium text-slate-300 mb-2">H.264 Profile</label>
                            <select name="profile" id="modal-profile"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="baseline">Baseline (Max Compatibility)</option>
                                <option value="main">Main (Good Quality/Compatibility)</option>
                                <option value="high" selected>High (Best Quality)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button type="button" onclick="closeAdvancedTranscodingModal()" 
                                class="flex-1 bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 text-sm">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                            <span id="advanced-loading-spinner" class="htmx-indicator animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                            Start Transcoding
                        </button>
                    </div>
                </form>

                <div id="advanced-transcoding-status" class="mt-4 p-3 bg-slate-700/50 rounded-md min-h-[40px] text-sm text-slate-300"></div>
            </div>
        </div>
    </div>

    <!-- Frame Search Modal -->
    <div id="frameSearchModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-slate-900 bg-opacity-75" onclick="closeFrameSearchModal()"></div>

            <!-- Modal content -->
            <div class="inline-block w-full max-w-4xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-slate-800 shadow-xl rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-slate-100">Search by Frame</h3>
                    <button onclick="closeFrameSearchModal()" class="text-slate-400 hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <!-- Step 1: Extract Frames -->
                <div id="frame-extraction-step" class="mb-6">
                    <h4 class="text-md font-medium text-slate-200 mb-4">Step 1: Extract Frames from Current Video</h4>
                    <div class="flex items-center space-x-4 mb-4">
                        <button onclick="extractCurrentFrame()" 
                                class="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors duration-200">
                            📸 Current Frame
                        </button>
                        <button onclick="extractMultipleFrames()" 
                                class="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors duration-200">
                            🎬 Multiple Frames
                        </button>
                        <div class="text-sm text-slate-400">
                            Extract frames to use for semantic search
                        </div>
                    </div>
                    
                    <!-- Multiple frames options -->
                    <div id="multiple-frames-options" class="hidden bg-slate-700/50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Frame Count</label>
                                <select id="frame-count-select" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200">
                                    <option value="5">5 frames</option>
                                    <option value="8" selected>8 frames</option>
                                    <option value="10">10 frames</option>
                                    <option value="12">12 frames</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-300 mb-2">Distribution</label>
                                <select id="frame-distribution-select" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200">
                                    <option value="even" selected>Even distribution</option>
                                    <option value="around-current">Around current time</option>
                                    <option value="custom">Custom timestamps</option>
                                </select>
                            </div>
                            <div>
                                <button onclick="generateFrameTimestamps()" 
                                        class="mt-6 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-500 transition-colors duration-200">
                                    Generate Frames
                                </button>
                            </div>
                        </div>
                        
                        <!-- Custom timestamps input -->
                        <div id="custom-timestamps-input" class="hidden mt-4">
                            <label class="block text-sm font-medium text-slate-300 mb-2">Custom Timestamps (seconds, comma-separated)</label>
                            <input type="text" id="custom-timestamps" placeholder="10, 30, 60, 120, 180" 
                                   class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200">
                        </div>
                    </div>
                    
                    <!-- Loading indicator -->
                    <div id="frame-extraction-loading" class="hidden text-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"></div>
                        <div class="text-slate-400">Extracting frames...</div>
                    </div>
                </div>

                <!-- Step 2: Select Frame -->
                <div id="frame-selection-step" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-slate-200 mb-4">Step 2: Select Frame for Search</h4>
                    <div id="extracted-frames-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <!-- Frames will be populated here -->
                    </div>
                    <div class="text-sm text-slate-400 mb-4">
                        Click on a frame to select it for semantic search
                    </div>
                </div>

                <!-- Step 3: Search Options -->
                <div id="search-options-step" class="mb-6 hidden">
                    <h4 class="text-md font-medium text-slate-200 mb-4">Step 3: Search Options</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Similarity Threshold</label>
                            <select id="frame-search-threshold" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200">
                                <option value="0.25">Broad (25%)</option>
                                <option value="0.35" selected>Balanced (35%)</option>
                                <option value="0.45">Precise (45%)</option>
                                <option value="0.55">Very Precise (55%)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Max Results</label>
                            <select id="frame-search-max-results" class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200">
                                <option value="10">10 videos</option>
                                <option value="20" selected>20 videos</option>
                                <option value="30">30 videos</option>
                                <option value="50">50 videos</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Selected frame preview -->
                    <div id="selected-frame-preview" class="bg-slate-700/50 rounded-lg p-4 mb-4 hidden">
                        <div class="flex items-center space-x-4">
                            <img id="selected-frame-image" src="" alt="Selected frame" class="w-24 h-16 object-cover rounded border border-slate-600">
                            <div>
                                <div class="text-sm font-medium text-slate-200">Selected Frame</div>
                                <div id="selected-frame-timestamp" class="text-xs text-slate-400"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="performFrameSearch()" 
                            class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-500 transition-colors duration-200 flex items-center justify-center">
                        <span id="frame-search-loading" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                        🔍 Search Similar Videos
                    </button>
                </div>

                <!-- Search Results -->
                <div id="frame-search-results" class="hidden">
                    <h4 class="text-md font-medium text-slate-200 mb-4">Search Results</h4>
                    <div id="frame-search-results-content" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                        <!-- Results will be populated here -->
                    </div>
                    <div class="mt-4 flex space-x-3">
                        <button onclick="closeFrameSearchModal()" 
                                class="flex-1 bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors duration-200">
                            Close
                        </button>
                        <button onclick="openSearchResultsInNewTab()" 
                                class="flex-1 bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors duration-200">
                            Open Results in New Tab
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboardShortcutsModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-slate-900 bg-opacity-75" onclick="closeKeyboardShortcutsModal()"></div>

            <!-- Modal content -->
            <div class="inline-block w-full max-w-2xl p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-slate-800 shadow-xl rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-slate-100 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2 text-primary">
                            <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 01-.988-1.129c1.454-1.272 3.776-1.272 5.23 0 1.513 1.324 1.513 3.518 0 4.842a3.75 3.75 0 01-.837.552c-.676.328-1.028.774-1.028 1.152v.75a.75.75 0 01-1.5 0v-.75c0-1.279.8-2.38 1.532-2.757.602-.293 1.163-.816 1.163-1.645 0-.59-.327-1.376-.317-2.015zM12 18a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                        </svg>
                        Keyboard Shortcuts
                    </h3>
                    <button onclick="closeKeyboardShortcutsModal()" class="text-slate-400 hover:text-slate-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 01-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-96 overflow-y-auto custom-scrollbar">
                    <!-- Video Playback Controls -->
                    <div class="space-y-3">
                        <h4 class="text-lg font-medium text-slate-200 border-b border-slate-600 pb-2">Video Playback</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Play/Pause</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">Space</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Seek backward 10s</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">←</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Seek forward 10s</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">→</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Volume up</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">↑</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Volume down</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">↓</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Toggle mute</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">M</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Toggle fullscreen</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">F</kbd>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation & Interface -->
                    <div class="space-y-3">
                        <h4 class="text-lg font-medium text-slate-200 border-b border-slate-600 pb-2">Navigation</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Previous video</span>
                                <div class="flex space-x-1">
                                    <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">Ctrl</kbd>
                                    <span class="text-slate-400">+</span>
                                    <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">←</kbd>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Next video</span>
                                <div class="flex space-x-1">
                                    <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">Ctrl</kbd>
                                    <span class="text-slate-400">+</span>
                                    <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">→</kbd>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Toggle queue sidebar</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">Q</kbd>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Center current video in queue</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">C</kbd>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Features -->
                    <div class="space-y-3">
                        <h4 class="text-lg font-medium text-slate-200 border-b border-slate-600 pb-2">Advanced Features</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Frame search modal</span>
                                <div class="flex space-x-1">
                                    <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">Ctrl</kbd>
                                    <span class="text-slate-400">+</span>
                                    <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">S</kbd>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Show keyboard shortcuts</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">?</kbd>
                            </div>
                        </div>
                    </div>

                    <!-- General -->
                    <div class="space-y-3">
                        <h4 class="text-lg font-medium text-slate-200 border-b border-slate-600 pb-2">General</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Close modal/dialog</span>
                                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs font-mono text-slate-200">Esc</kbd>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-center">
                    <button onclick="closeKeyboardShortcutsModal()" 
                            class="bg-primary text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200">
                        Got it!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Custom Scrollbar for Webkit browsers */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }

        /* For Firefox - not as customizable but can set basic colors */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #475569 transparent; /* thumb and track */
        }

        /* Line clamp utility for text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Queue sidebar collapsed state */
        .queue-collapsed {
            width: 3rem !important;
            min-width: 3rem !important;
        }
        
        .queue-collapsed .queue-header-content {
            display: none;
        }
        
        .queue-collapsed #queue-toggle-btn {
            display: none;
        }
        
        .queue-collapsed #queue-collapsed-indicator {
            display: flex !important;
        }
        
        .queue-collapsed .autoplay-controls,
        .queue-collapsed .filter-details,
        .queue-collapsed #video-queue-container {
            display: none;
        }
        
        /* Vertical text for collapsed state */
        .writing-mode-vertical {
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        
        /* Smooth transitions for queue collapse */
        #queue-sidebar {
            transition: width 0.3s ease-in-out;
        }
        
        /* Ensure collapsed indicator is properly positioned */
        #queue-collapsed-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
        }

        /* Ensure video maintains aspect ratio within flex container */
        #video-player-container video {
            object-fit: contain;
        }

        /* Custom scrollbar for metadata sidebar */
        .metadata-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .metadata-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .metadata-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        .metadata-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Mobile responsiveness */
        @media (max-width: 1024px) {
            #queue-sidebar {
                position: absolute;
                left: 0;
                top: 0;
                z-index: 40;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            
            #queue-sidebar.mobile-visible {
                transform: translateX(0);
            }
            
            /* On mobile, collapsed state should hide completely */
            .queue-collapsed {
                transform: translateX(-100%) !important;
            }
            
            /* Hide collapsed indicator on mobile */
            @media (max-width: 1024px) {
                #queue-collapsed-indicator {
                    display: none !important;
                }
            }
        }

        /* Ensure proper aspect ratio on smaller screens */
        @media (max-width: 768px) {
            #video-player-container {
                min-height: 200px;
            }
        }

        /* Frame Search Modal Styles */
        .frame-hover-effect {
            transition: all 0.2s ease-in-out;
        }
        
        .frame-hover-effect:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .frame-selected {
            transform: scale(1.02);
            box-shadow: 0 0 0 2px #1a73e8, 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        /* Smooth transitions for modal steps */
        #frame-extraction-step,
        #frame-selection-step,
        #search-options-step,
        #frame-search-results {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Custom scrollbar for frame search results */
        #frame-search-results-content::-webkit-scrollbar {
            width: 6px;
        }
        #frame-search-results-content::-webkit-scrollbar-track {
            background: transparent;
        }
        #frame-search-results-content::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        #frame-search-results-content::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
    <script>
        let choicesTagsInstance = null;
        let video = null;
        let isVideoReady = false;
        let currentSpeed = 1;
        let isSeeking = false;
        let seekingTimeout = null;
        
        // Settings from backend
        const autoplayEnabled = {{ autoplay_enabled|lower }};
        const defaultMuted = {{ default_muted|lower }};
        let autoplayNext = {{ autoplay_next|lower }}; // Make this mutable so we can update it
        let autoReplay = {{ auto_replay|lower }}; // Make this mutable so we can update it

        // Initialize video player when page loads
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('main-video-player');
            initializeVideoPlayer();
            initializeAutoplayToggle();
        });

        function initializeVideoPlayer() {
            if (!video) return;

            // Video event listeners
            video.addEventListener('loadedmetadata', onVideoMetadataLoaded);
            video.addEventListener('loadeddata', onVideoDataLoaded);
            video.addEventListener('timeupdate', updateProgress);
            video.addEventListener('play', onVideoPlay);
            video.addEventListener('pause', onVideoPause);
            video.addEventListener('waiting', showLoading);
            video.addEventListener('canplay', hideLoading);
            video.addEventListener('ended', onVideoEnded);
            video.addEventListener('canplaythrough', onVideoCanPlayThrough);
            video.addEventListener('seeked', onVideoSeeked);
            video.addEventListener('seeking', onVideoSeeking);
            video.addEventListener('error', onVideoError);

            // Timeline event listeners - use both click and mousedown for better compatibility
            const timelineContainer = document.getElementById('timeline-container');
            timelineContainer.addEventListener('click', handleTimelineClick);
            
            // Add drag functionality for scrubbing
            let isDragging = false;
            timelineContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                handleTimelineSeek(e);
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    handleTimelineSeek(e);
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
            
            timelineContainer.addEventListener('mouseenter', () => {
                document.getElementById('timeline-handle').style.opacity = '1';
            });
            timelineContainer.addEventListener('mouseleave', () => {
                if (!isDragging) {
                    document.getElementById('timeline-handle').style.opacity = '0';
                }
            });

            // Handle start time from semantic search
            handleStartTime();

            // Handle autoplay
            handleAutoplay();

            // Initialize volume controls
            updateVolumeIcon();
            updateVolumeBar();

            // Hide center play button initially if autoplay
            updateCenterPlayButton();
        }

        function handleStartTime() {
            // Check if we have a start time from semantic search
            {% if start_time %}
            const startTime = {{ start_time }};
            console.log('🎯 Semantic search start time detected:', startTime, 'seconds');
            
            // Set the start time when metadata is loaded
            if (video.readyState >= 1) {
                // Metadata already loaded, set time immediately
                video.currentTime = startTime;
                console.log('✅ Set video start time to', startTime, 'seconds');
            } else {
                // Wait for metadata to load
                video.addEventListener('loadedmetadata', function setStartTime() {
                    video.currentTime = startTime;
                    console.log('✅ Set video start time to', startTime, 'seconds (after metadata loaded)');
                    video.removeEventListener('loadedmetadata', setStartTime);
                });
            }
            
            // Show a notification about the semantic search jump
            showSemanticSearchNotification(startTime);
            {% endif %}
        }

        function showSemanticSearchNotification(timestamp) {
            // Create and show a notification that we jumped to a semantic search result
            const notification = document.createElement('div');
            notification.id = 'semantic-search-notification';
            notification.className = 'absolute top-4 left-1/2 transform -translate-x-1/2 bg-purple-600/90 text-white px-4 py-2 rounded-lg shadow-lg z-10 flex items-center space-x-2';
            notification.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path d="M8 2a6 6 0 100 12A6 6 0 008 2zM7 5a1 1 0 112 0v2a1 1 0 11-2 0V5zM8 10a1 1 0 100-2 1 1 0 000 2z"/>
                </svg>
                <span class="text-sm font-medium">Jumped to best matching frame at ${formatTime(timestamp)}</span>
                <button onclick="hideSemanticSearchNotification()" class="text-purple-200 hover:text-white ml-2">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                        <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                </button>
            `;
            
            // Add to video container
            const videoContainer = document.getElementById('video-player-container');
            videoContainer.appendChild(notification);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideSemanticSearchNotification();
            }, 5000);
        }

        function hideSemanticSearchNotification() {
            const notification = document.getElementById('semantic-search-notification');
            if (notification) {
                notification.remove();
            }
        }

        function handleAutoplay() {
            // Only attempt autoplay if enabled in settings
            if (!autoplayEnabled) {
                console.log('Autoplay disabled in settings');
                document.getElementById('center-play-btn').classList.remove('hidden');
                return;
            }
            
            // Attempt to play the video (autoplay might fail in some browsers)
            const playPromise = video.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('Autoplay started successfully');
                    // Video started playing successfully - show muted notice if muted
                    if (video.muted) {
                        showMutedNotice();
                    }
                }).catch(error => {
                    console.log('Autoplay failed:', error);
                    // Autoplay failed, show the center play button
                    document.getElementById('center-play-btn').classList.remove('hidden');
                    // Only unmute if default_muted is false
                    if (!defaultMuted) {
                        video.muted = false;
                        updateVolumeIcon();
                        updateVolumeBar();
                    }
                });
            }
        }

        function showMutedNotice() {
            // Only show notice if video is actually muted
            if (!video.muted) return;
            
            const notice = document.getElementById('autoplay-muted-notice');
            notice.classList.remove('hidden');
            
            // Auto-hide the notice after 5 seconds
            setTimeout(() => {
                hideMutedNotice();
            }, 5000);
        }

        function hideMutedNotice() {
            const notice = document.getElementById('autoplay-muted-notice');
            notice.classList.add('hidden');
        }

        function unmuteVideo() {
            if (!video) return;
            
            video.muted = false;
            hideMutedNotice();
            updateVolumeIcon();
            updateVolumeBar();
        }

        function togglePlay() {
            if (!video) return;

            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }

        function onVideoPlay() {
            document.getElementById('play-icon').classList.add('hidden');
            document.getElementById('pause-icon').classList.remove('hidden');
            document.getElementById('center-play-btn').classList.add('hidden');
        }

        function onVideoPause() {
            document.getElementById('play-icon').classList.remove('hidden');
            document.getElementById('pause-icon').classList.add('hidden');
            document.getElementById('center-play-btn').classList.remove('hidden');
        }

        function onVideoEnded() {
            document.getElementById('play-icon').classList.remove('hidden');
            document.getElementById('pause-icon').classList.add('hidden');
            document.getElementById('center-play-btn').classList.remove('hidden');
            
            // Check if auto-replay is enabled first (takes priority)
            if (autoReplay) {
                console.log('Auto-replaying current video from beginning');
                video.currentTime = 0;
                video.play();
                return; // Exit early, don't check autoplay next
            }
            
            // If auto-replay is disabled, check if autoplay next is enabled
            if (autoplayNext) {
                {% if next_video %}
                // Build URL with current filter parameters
                const currentUrl = new URL(window.location);
                const nextVideoUrl = new URL('/video/{{ next_video.name }}', window.location.origin);
                
                // Copy search and filter parameters from current URL
                const paramsToKeep = ['search', 'media_type', 'tags', 'sort_by', 'sort_order'];
                paramsToKeep.forEach(param => {
                    const value = currentUrl.searchParams.get(param);
                    if (value) {
                        nextVideoUrl.searchParams.set(param, value);
                    }
                });
                
                // Automatically go to next video with preserved filters
                console.log('Auto-playing next video: {{ next_video.name }} with filters');
                window.location.href = nextVideoUrl.toString();
                {% else %}
                console.log('Autoplay next enabled but no next video available');
                {% endif %}
            }
        }

        function onVideoMetadataLoaded() {
            updateDuration();
            console.log('Video metadata loaded - duration:', video.duration);
        }

        function onVideoDataLoaded() {
            isVideoReady = true;
            console.log('Video data loaded - ready for seeking');
        }

        function updateCenterPlayButton() {
            const centerBtn = document.getElementById('center-play-btn');
            if (video && video.paused) {
                centerBtn.classList.remove('hidden');
            } else {
                centerBtn.classList.add('hidden');
            }
        }

        function showLoading() {
            document.getElementById('loading-spinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        function updateDuration() {
            if (!video) return;
            const duration = formatTime(video.duration);
            document.getElementById('duration-main').textContent = duration;
        }

        function updateProgress() {
            if (!video || isSeeking) return;
            
            const progress = (video.currentTime / video.duration) * 100;
            const currentTime = formatTime(video.currentTime);
            
            document.getElementById('timeline-progress').style.width = progress + '%';
            document.getElementById('timeline-handle').style.left = progress + '%';
            document.getElementById('current-time-main').textContent = currentTime;
        }

        function handleTimelineClick(event) {
            // Only handle direct clicks, not drag events
            if (event.target === event.currentTarget || event.target.id === 'timeline-progress') {
                handleTimelineSeek(event);
            }
        }

        function handleTimelineSeek(event) {
            if (!video || !video.duration || isNaN(video.duration)) return;
            
            const timelineContainer = document.getElementById('timeline-container');
            const rect = timelineContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const progress = Math.max(0, Math.min(1, clickX / rect.width));
            const targetTime = progress * video.duration;
            
            // Update visual feedback immediately
            document.getElementById('timeline-progress').style.width = (progress * 100) + '%';
            document.getElementById('timeline-handle').style.left = (progress * 100) + '%';
            document.getElementById('current-time-main').textContent = formatTime(targetTime);
            
            // Debounce the actual seeking
            if (seekingTimeout) {
                clearTimeout(seekingTimeout);
            }
            
            seekingTimeout = setTimeout(() => {
                performSeek(targetTime);
            }, 50); // Small delay to prevent too many seek operations
        }

        function performSeek(targetTime) {
            if (!video || isNaN(targetTime) || targetTime < 0 || targetTime > video.duration) {
                console.error('Invalid seek time:', targetTime);
                return;
            }
            
            console.log('Attempting to seek to:', targetTime, 'seconds');
            
            // For better compatibility, pause briefly during seek if playing
            const wasPlaying = !video.paused;
            
            try {
                // Method 1: Direct currentTime setting (works for most properly encoded videos)
                video.currentTime = targetTime;
                
                // If video was playing, ensure it continues
                if (wasPlaying && video.paused) {
                    video.play().catch(e => console.log('Play after seek failed:', e));
                }
            } catch (error) {
                console.error('Seek failed:', error);
                
                // Method 2: Try using fastSeek if available (for some browsers/formats)
                if (video.fastSeek) {
                    try {
                        video.fastSeek(targetTime);
                        if (wasPlaying && video.paused) {
                            video.play().catch(e => console.log('Play after fastSeek failed:', e));
                        }
                    } catch (fastSeekError) {
                        console.error('FastSeek also failed:', fastSeekError);
                    }
                }
            }
        }

        function toggleMute() {
            if (!video) return;
            
            video.muted = !video.muted;
            
            // Hide muted notice if unmuting
            if (!video.muted) {
                hideMutedNotice();
            }
            
            updateVolumeIcon();
            updateVolumeBar();
        }

        function updateVolumeIcon() {
            const volumeIcon = document.getElementById('volume-icon');
            const muteIcon = document.getElementById('mute-icon');
            
            if (video.muted || video.volume === 0) {
                volumeIcon.classList.add('hidden');
                muteIcon.classList.remove('hidden');
            } else {
                volumeIcon.classList.remove('hidden');
                muteIcon.classList.add('hidden');
            }
        }

        function updateVolumeBar() {
            const volumeProgress = document.getElementById('volume-progress');
            const volume = video.muted ? 0 : video.volume;
            volumeProgress.style.width = (volume * 100) + '%';
        }

        function setVolume(event) {
            if (!video) return;
            
            const volumeContainer = document.getElementById('volume-container');
            const rect = volumeContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const volume = Math.max(0, Math.min(1, clickX / rect.width));
            
            video.volume = volume;
            video.muted = false;
            updateVolumeIcon();
            updateVolumeBar();
        }

        function toggleSpeedMenu() {
            const speedMenu = document.getElementById('speed-menu');
            speedMenu.classList.toggle('hidden');
        }

        function setSpeed(speed) {
            if (!video) return;
            
            video.playbackRate = speed;
            currentSpeed = speed;
            document.getElementById('speed-btn').textContent = speed + 'x';
            document.getElementById('speed-menu').classList.add('hidden');
        }

        function toggleFullscreen() {
            const playerContainer = video.closest('.aspect-video');
            
            if (!document.fullscreenElement) {
                playerContainer.requestFullscreen().catch(err => {
                    console.log('Error attempting to enable fullscreen:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', function() {
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            const exitFullscreenIcon = document.getElementById('exit-fullscreen-icon');
            
            if (document.fullscreenElement) {
                fullscreenIcon.classList.add('hidden');
                exitFullscreenIcon.classList.remove('hidden');
            } else {
                fullscreenIcon.classList.remove('hidden');
                exitFullscreenIcon.classList.add('hidden');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (!video) return;
            
            // Only handle shortcuts when not typing in input fields
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    video.currentTime = Math.max(0, video.currentTime - 10);
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    video.currentTime = Math.min(video.duration, video.currentTime + 10);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    video.volume = Math.min(1, video.volume + 0.1);
                    updateVolumeIcon();
                    updateVolumeBar();
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    video.volume = Math.max(0, video.volume - 0.1);
                    updateVolumeIcon();
                    updateVolumeBar();
                    break;
                case 'KeyM':
                    event.preventDefault();
                    toggleMute();
                    break;
                case 'KeyF':
                    event.preventDefault();
                    toggleFullscreen();
                    break;
                case 'KeyS':
                    // S key - open frame search modal
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        openFrameSearchModal();
                    }
                    break;
                case 'Escape':
                    // Close frame search modal if open
                    if (!document.getElementById('frameSearchModal').classList.contains('hidden')) {
                        event.preventDefault();
                        closeFrameSearchModal();
                    }
                    // Close keyboard shortcuts modal if open
                    if (!document.getElementById('keyboardShortcutsModal').classList.contains('hidden')) {
                        event.preventDefault();
                        closeKeyboardShortcutsModal();
                    }
                    break;
                case 'Slash':
                    // Question mark key - show keyboard shortcuts (Shift + /)
                    if (event.shiftKey) {
                        event.preventDefault();
                        openKeyboardShortcutsModal();
                    }
                    break;
            }
        });

        // Close speed menu when clicking outside
        document.addEventListener('click', function(event) {
            const speedBtn = document.getElementById('speed-btn');
            const speedMenu = document.getElementById('speed-menu');
            
            if (!speedBtn.contains(event.target) && !speedMenu.contains(event.target)) {
                speedMenu.classList.add('hidden');
            }
        });

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function initializeChoices() {
            const tagsInput = document.getElementById('tags-input');
            if (tagsInput) {
                if (choicesTagsInstance) {
                    choicesTagsInstance.destroy();
                }
                choicesTagsInstance = new Choices(tagsInput, {
                    removeItemButton: true,
                    delimiter: ',',
                    editItems: true,
                    allowHTML: false,
                    placeholderValue: 'Enter tags',
                    duplicateItemsAllowed: false,
                    classNames: {
                        containerOuter: 'choices choices-tags-outer',
                        containerInner: 'choices__inner bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus-within:ring-2 focus-within:ring-primary focus-within:border-primary min-h-[40px]',
                        input: 'choices__input choices__input--cloned text-slate-200',
                        inputCloned: 'choices__input--cloned',
                        list: 'choices__list',
                        listItems: 'choices__list--multiple',
                        listSingle: 'choices__list--single',
                        listDropdown: 'choices__list--dropdown',
                        item: 'choices__item bg-primary/80 border-primary/90 text-white',
                        itemSelectable: 'choices__item--selectable',
                        itemDisabled: 'choices__item--disabled',
                        itemChoice: 'choices__item--choice',
                        placeholder: 'choices__placeholder text-slate-500',
                        group: 'choices__group',
                        groupHeading : 'choices__heading',
                        button: 'choices__button',
                        activeState: 'is-active',
                        focusState: 'is-focused',
                        openState: 'is-open',
                        disabledState: 'is-disabled',
                        highlightedState: 'is-highlighted',
                        selectedState: 'is-selected',
                        flippedState: 'is-flipped',
                        loadingState: 'is-loading',
                        noResults: 'has-no-results',
                        noChoices: 'has-no-choices'
                    }
                });
            }
        }

        function toggleEditMetadataMode(editing) {
            const displaySection = document.getElementById('metadata-display-section');
            const editForm = document.getElementById('metadata-edit-form');
            const systemDetails = document.getElementById('system-details-section'); // For button positioning
            const editButton = document.getElementById('edit-metadata-button');

            if (editing) {
                displaySection.classList.add('hidden');
                editForm.classList.remove('hidden');
                systemDetails.classList.add('hidden'); // Hide system details during edit
                initializeChoices();
            } else {
                displaySection.classList.remove('hidden');
                editForm.classList.add('hidden');
                systemDetails.classList.remove('hidden'); // Show system details
                if (choicesTagsInstance) {
                   // choicesTagsInstance.destroy(); // Or just clear input if needed on cancel
                }
            }
        }
        
        function handleMetadataUpdateResponse(event) {
            const messageDiv = document.getElementById('metadata-edit-message');
            if (event.detail.successful) {
                // The hx-swap="outerHTML" on the form for #video-metadata-sidebar handles the UI update.
                // So, we just need to ensure we are back in display mode.
                // The new sidebar that is swapped in should be in display mode by default.
                // However, if the swap target was different, we might call toggleEditMetadataMode(false) here.
                // console.log("Metadata updated successfully, sidebar swapped.");
                // toggleEditMetadataMode(false); // Will be handled by full sidebar swap
            } else {
                if (messageDiv) {
                    let errorMsg = "Failed to update metadata.";
                    try {
                        const xhrResponse = JSON.parse(event.detail.xhr.responseText);
                        errorMsg = xhrResponse.detail || xhrResponse.message || errorMsg;
                    } catch (e) { /* Use default error msg */ }
                    messageDiv.innerHTML = `<p class="text-red-400">${errorMsg}</p>`;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup if needed (e.g. if form was visible by default)
            // toggleEditMetadataMode(false); // Ensure starts in display mode
        });

        // If HTMX swaps in the sidebar (e.g. after successful edit), re-ensure edit mode is off
        // and Choices.js is not active on a non-existent input if the form was destroyed.
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'video-metadata-sidebar') {
                toggleEditMetadataMode(false); // Ensure we are in display mode
                 const newEditButton = document.getElementById('edit-metadata-button');
                 if(newEditButton) {
                    // If new button exists, we can assume the display section is there.
                 } else {
                    // This case might happen if an error prevented full sidebar swap
                 }
            }
        });

        function openAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.remove('hidden');
        }

        function closeAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.add('hidden');
        }

        function toggleModalQualityOptions() {
            const qualityMode = document.getElementById('modal-quality-mode').value;
            const crfContainer = document.getElementById('modal-crf-container');
            const bitrateContainer = document.getElementById('modal-bitrate-container');
            
            if (qualityMode === 'crf') {
                crfContainer.style.display = 'block';
                bitrateContainer.style.display = 'none';
            } else {
                crfContainer.style.display = 'none';
                bitrateContainer.style.display = 'block';
            }
        }

        // Close modals when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAdvancedTranscodingModal();
                closeFrameSearchModal();
                closeKeyboardShortcutsModal();
            }
        });

        // Toggle queue sidebar visibility
        function toggleQueueSidebar() {
            const queueSidebar = document.getElementById('queue-sidebar');
            const collapseIcon = document.getElementById('queue-collapse-icon');
            const expandIcon = document.getElementById('queue-expand-icon');
            const toggleBtn = document.getElementById('queue-toggle-btn');
            
            // Check if we're on mobile
            const isMobile = window.innerWidth <= 1024;
            
            if (isMobile) {
                // Mobile behavior - slide in/out
                if (queueSidebar.classList.contains('mobile-visible')) {
                    queueSidebar.classList.remove('mobile-visible');
                } else {
                    queueSidebar.classList.add('mobile-visible');
                    setTimeout(centerCurrentVideoInQueue, 300);
                }
            } else {
                // Desktop behavior - collapse/expand
                if (queueSidebar.classList.contains('queue-collapsed')) {
                    // Expand sidebar
                    queueSidebar.classList.remove('queue-collapsed');
                    updateQueueToggleButton(false);
                    // Center the queue after it's expanded
                    setTimeout(centerCurrentVideoInQueue, 300);
                } else {
                    // Collapse sidebar
                    queueSidebar.classList.add('queue-collapsed');
                    updateQueueToggleButton(true);
                }
            }
        }
        
        // Update queue toggle button state and tooltip
        function updateQueueToggleButton(isCollapsed) {
            const toggleBtn = document.getElementById('queue-toggle-btn');
            const collapseIcon = document.getElementById('queue-collapse-icon');
            const expandIcon = document.getElementById('queue-expand-icon');
            
            if (isCollapsed) {
                collapseIcon.classList.add('hidden');
                expandIcon.classList.remove('hidden');
                toggleBtn.title = 'Expand queue (Q)';
            } else {
                collapseIcon.classList.remove('hidden');
                expandIcon.classList.add('hidden');
                toggleBtn.title = 'Collapse queue (Q)';
            }
        }

        // Legacy function for backward compatibility
        function toggleQueue() {
            // For keyboard shortcuts and other legacy calls
            centerCurrentVideoInQueue();
        }

        // Handle new transcode event triggered by HX-Trigger from server
        document.body.addEventListener('newTranscodeAvailable', function(event) {
            const newPath = event.detail.newPath;
            const fileName = event.detail.fileName;
            const player = document.getElementById('main-video-player');
            const videoStatusSpan = document.querySelector('#video-status-indicator span'); // More robust selector

            if (player && newPath) {
                player.src = newPath;
                player.load(); // Load the new source
                // player.play(); // Optionally auto-play
                
                if (videoStatusSpan) {
                    videoStatusSpan.textContent = `Playing Advanced Transcode: ${fileName}`;
                    videoStatusSpan.className = 'text-xs font-medium bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded-full';
                }
                
                // Update the download link if it needs to reflect the newest transcode (optional)
                // const downloadLink = document.getElementById('download-original-link');
                // if(downloadLink) { /* update if needed */ }

                // Close the modal as the primary action is complete
                closeAdvancedTranscodingModal(); 
                
                // Optionally, disable the basic transcode button if this advanced one supersedes it
                const basicTranscodeButton = document.querySelector('button[hx-post*="transcode_specific_video_endpoint"]');
                if (basicTranscodeButton) {
                    // basicTranscodeButton.disabled = true;
                    // basicTranscodeButton.innerText = 'Advanced Version Created';
                }
            } else {
                console.error("Could not update player. Player or newPath missing.", event.detail);
            }
        });

        function initializeAutoplayToggle() {
            const toggleBtn = document.getElementById('autoplay-next-toggle');
            if (toggleBtn) {
                toggleBtn.dataset.enabled = autoplayNext.toString();
                updateToggleUI();
            }
            
            const autoReplayBtn = document.getElementById('auto-replay-toggle');
            if (autoReplayBtn) {
                autoReplayBtn.dataset.enabled = autoReplay.toString();
                updateAutoReplayUI();
            }
        }

        function updateToggleUI() {
            const toggleBtn = document.getElementById('autoplay-next-toggle');
            const toggleDot = document.getElementById('autoplay-toggle-dot');
            
            if (!toggleBtn || !toggleDot) return;
            
            const enabled = toggleBtn.dataset.enabled === 'true';
            
            if (enabled) {
                toggleBtn.className = 'relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-slate-800 bg-primary';
                toggleDot.className = 'absolute left-0.5 inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform duration-200 translate-x-4';
            } else {
                toggleBtn.className = 'relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-slate-800 bg-slate-600';
                toggleDot.className = 'absolute left-0.5 inline-block h-4 w-4 transform rounded-full bg-white shadow-lg transition-transform duration-200 translate-x-0';
            }
        }

        function updateAutoReplayUI() {
            const autoReplayBtn = document.getElementById('auto-replay-toggle');
            const autoReplayIndicator = document.getElementById('auto-replay-indicator');
            const videoPlayerContainer = document.getElementById('video-player-container');
            
            if (!autoReplayBtn) return;
            
            const enabled = autoReplayBtn.dataset.enabled === 'true';
            
            // Update button appearance
            if (enabled) {
                autoReplayBtn.className = 'text-white hover:text-primary transition-colors duration-150 text-primary';
            } else {
                autoReplayBtn.className = 'text-white hover:text-primary transition-colors duration-150 text-slate-400';
            }
            
            // Update persistent indicator
            if (autoReplayIndicator) {
                if (enabled) {
                    autoReplayIndicator.classList.remove('hidden');
                    autoReplayIndicator.classList.add('block');
                } else {
                    autoReplayIndicator.classList.remove('block');
                    autoReplayIndicator.classList.add('hidden');
                }
            }
            
            // Update video player container glow effect
            if (videoPlayerContainer) {
                if (enabled) {
                    videoPlayerContainer.classList.add('ring-2', 'ring-blue-500/50', 'shadow-blue-500/20');
                } else {
                    videoPlayerContainer.classList.remove('ring-2', 'ring-blue-500/50', 'shadow-blue-500/20');
                }
            }
        }

        function toggleAutoplayNext() {
            const toggleBtn = document.getElementById('autoplay-next-toggle');
            if (!toggleBtn) return;
            
            const currentlyEnabled = toggleBtn.dataset.enabled === 'true';
            const newState = !currentlyEnabled;
            
            // Update the dataset and UI immediately for responsive feel
            toggleBtn.dataset.enabled = newState.toString();
            autoplayNext = newState; // Update the global variable
            updateToggleUI();
            
            // The HTMX request will handle saving to the backend
        }

        function toggleAutoReplay() {
            const toggleBtn = document.getElementById('auto-replay-toggle');
            if (!toggleBtn) return;
            
            const currentlyEnabled = toggleBtn.dataset.enabled === 'true';
            const newState = !currentlyEnabled;
            
            // Update the dataset and UI immediately for responsive feel
            toggleBtn.dataset.enabled = newState.toString();
            autoReplay = newState; // Update the global variable
            updateAutoReplayUI();
            
            // The HTMX request will handle saving to the backend
        }

        function onVideoCanPlayThrough() {
            isVideoReady = true;
            console.log('Video can play through - fully ready for seeking');
        }

        function onVideoSeeking() {
            isSeeking = true;
            showLoading();
        }

        function onVideoSeeked() {
            isSeeking = false;
            hideLoading();
            console.log('Seek completed to:', video.currentTime);
        }

        function onVideoError(e) {
            console.error('Video error:', e);
            hideLoading();
        }

        function handleAdvancedTranscodeJobStart(event) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.job_id) {
                    // Add job to monitoring
                    videoActiveJobs.add(response.job_id);
                    showVideoJobsSection();
                    startVideoJobPolling();
                    
                    // Close the modal since job is started
                    closeAdvancedTranscodingModal();
                    
                    // Update status message
                    const statusDiv = document.getElementById('advanced-transcoding-status');
                    if (statusDiv) {
                        statusDiv.innerHTML = `<div class="text-blue-400">Started in background: ${response.message}</div>`;
                    }
                } else {
                    console.error('No job_id in response');
                }
            } catch (e) {
                console.error('Error parsing advanced transcode response:', e);
            }
        }

        function handleVideoJobStart(event) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.job_id) {
                    // Add job to monitoring
                    videoActiveJobs.add(response.job_id);
                    showVideoJobsSection();
                    startVideoJobPolling();
                    
                    // Update the status message with job info
                    const target = event.detail.target;
                    if (target) {
                        target.innerHTML = `<div class="text-blue-400">Started in background: ${response.message}</div>`;
                    }
                }
            } catch (e) {
                console.error('Error parsing video job start response:', e);
            }
        }

        // Background job monitoring for video page
        let videoActiveJobs = new Set();
        let videoJobPollingInterval = null;
        let previousVideoPageJobStates = new Map(); // To track job state changes for notifications

        // Toast Notification Container (add if not present, or ensure it exists in the base HTML structure)
        // For this example, assuming a global toast container or one added to video_player.html like others.
        // If not globally available, it would be added here:
        /*
        if (!document.getElementById('toast-container')) {
            const toastContainerHTML = '<div id="toast-container" class="fixed bottom-0 right-0 p-6 space-y-3 z-[100]"></div>';
            document.body.insertAdjacentHTML('beforeend', toastContainerHTML);
        }
        */

        function showVideoJobsSection() {
            document.getElementById('video-background-jobs').classList.remove('hidden');
        }

        function hideVideoJobs() {
            document.getElementById('video-background-jobs').classList.add('hidden');
            // Don't stop polling, just hide the UI
        }

        function startVideoJobPolling() {
            if (videoJobPollingInterval) return; // Already polling
            
            videoJobPollingInterval = setInterval(() => {
                if (videoActiveJobs.size === 0) {
                    stopVideoJobPolling();
                    return;
                }
                refreshVideoJobs();
            }, 2000); // Poll every 2 seconds
        }

        function stopVideoJobPolling() {
            if (videoJobPollingInterval) {
                clearInterval(videoJobPollingInterval);
                videoJobPollingInterval = null;
            }
        }

        function refreshVideoJobs() {
            fetch('/jobs')
                .then(response => response.json())
                .then(data => {
                    const relevantJobs = data.jobs.filter(job => videoActiveJobs.has(job.job_id) || previousVideoPageJobStates.has(job.job_id));
                    updateVideoJobsDisplay(relevantJobs); // Updates the inline job list for the video player
                    checkForVideoPageCompletedJobsAndNotify(relevantJobs); // For toast notifications
                })
                .catch(error => {
                    console.error('Error fetching video jobs:', error);
                });
        }

        function updateVideoJobsDisplay(jobs) {
            const container = document.getElementById('video-jobs-container');
            
            if (jobs.length === 0) {
                videoActiveJobs.clear();
                stopVideoJobPolling();
                setTimeout(() => {
                    if (videoActiveJobs.size === 0) {
                        hideVideoJobs();
                    }
                }, 2000);
                return;
            }

            // Update active jobs set and check for completed transcoding jobs
            const completedTranscodeJobs = [];
            videoActiveJobs.clear();
            jobs.forEach(job => {
                if (job.status === 'running') {
                    videoActiveJobs.add(job.job_id);
                } else if (job.status === 'completed' && (job.job_type === 'transcode_single' || job.job_type === 'transcode_single_advanced') && job.result && job.result.video_name) {
                    completedTranscodeJobs.push(job);
                }
            });

            container.innerHTML = jobs.map(job => createVideoJobElement(job)).join('');
            
            // Handle completed transcoding jobs - reload sidebar
            if (completedTranscodeJobs.length > 0) {
                console.log('Transcoding job(s) completed, reloading sidebar');
                reloadVideoSidebar(); // This existing function already handles sidebar refresh
            }
            
            // Stop polling if no running jobs related to this video page
            if (videoActiveJobs.size === 0) {
                setTimeout(() => {
                    if (videoActiveJobs.size === 0) {
                        stopVideoJobPolling();
                        // Consider hiding the video-specific job display area if empty
                        // if (container.children.length === 0) { hideVideoJobs(); }
                    }
                }, 5000); 
            }
        }

        function checkForVideoPageCompletedJobsAndNotify(newJobs) {
            newJobs.forEach(job => {
                const previousState = previousVideoPageJobStates.get(job.job_id);
                if (previousState === 'running' && (job.status === 'completed' || job.status === 'failed')) {
                    // Use a generic toast function, or one specific to video page if styles differ
                    showToastOnVideoPage(job.result?.message || job.error || `Job ${job.status}`, job.description, job.status);
                }
                previousVideoPageJobStates.set(job.job_id, job.status);
            });

            const currentJobIds = new Set(newJobs.map(j => j.job_id));
            for (const jobId of previousVideoPageJobStates.keys()) {
                if (!currentJobIds.has(jobId)) {
                    previousVideoPageJobStates.delete(jobId);
                }
            }
        }

        // Assuming a global or similarly styled toast function as in other pages
        // If not, define showToastOnVideoPage similarly to showToastOnToolsPage
        function showToastOnVideoPage(message, description, status = 'info') {
            const container = document.getElementById('toast-container-video'); // Use a specific ID for video page toasts
            if (!container) {
                console.warn("Toast container #toast-container-video not found on video page.");
                return;
            }

            const toastId = `toast-video-${Date.now()}`;
            const toast = document.createElement('div');
            toast.id = toastId;
            // Basic styling, can be enhanced
            toast.className = `max-w-sm w-full bg-slate-800 shadow-2xl rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden border ${status === 'completed' ? 'border-green-500' : status === 'failed' ? 'border-red-500' : 'border-blue-500'}`;

            const iconColor = status === 'completed' ? 'text-green-400' : status === 'failed' ? 'text-red-400' : 'text-blue-400';
            let iconSvg = '';
            if (status === 'completed') {
                iconSvg = `
                    <svg class="h-6 w-6 ${iconColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>`;
            } else if (status === 'failed') {
                iconSvg = `
                    <svg class="h-6 w-6 ${iconColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z" />
                    </svg>`;
            } else { 
                 iconSvg = `
                    <svg class="h-6 w-6 ${iconColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>`;
            }

            toast.innerHTML = `
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            ${iconSvg}
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-semibold text-slate-100">${description}</p>
                            <p class="mt-1 text-xs text-slate-300">${message}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button type="button" onclick="document.getElementById('${toastId}').remove()" class="inline-flex bg-slate-800 rounded-md p-1 text-slate-400 hover:text-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-600">
                                <span class="sr-only">Close</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                const currentToast = document.getElementById(toastId);
                if (currentToast) {
                    currentToast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => currentToast.remove(), 500);
                }
            }, 7000);
        }

        function createVideoJobElement(job) {
            const progressPercent = job.total > 0 ? Math.round((job.progress / job.total) * 100) : 0;
            const statusColor = {
                'running': 'text-blue-400',
                'completed': 'text-green-400',
                'failed': 'text-red-400'
            }[job.status] || 'text-slate-400';

            const statusIcon = {
                'running': '🔄',
                'completed': '✅',
                'failed': '❌'
            }[job.status] || '⏳';

            return `
                <div class="bg-slate-600/50 rounded-md p-3 border border-slate-500">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center space-x-2">
                            <span class="text-sm">${statusIcon}</span>
                            <span class="text-xs font-medium text-slate-200">${job.description}</span>
                            <span class="text-xs ${statusColor} capitalize">${job.status}</span>
                        </div>
                        ${job.status !== 'running' ? `
                            <button onclick="removeVideoJob('${job.job_id}')" class="text-xs text-slate-400 hover:text-slate-300 px-1">
                                ✕
                            </button>
                        ` : ''}
                    </div>
                    
                    ${job.status === 'running' ? `
                        <div class="mb-1">
                            <div class="text-xs text-slate-400 mb-1">${job.current_item || 'Processing...'}</div>
                            <div class="w-full bg-slate-600 rounded-full h-1.5">
                                <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${job.status === 'completed' && job.result ? `
                        <div class="text-xs text-green-400 mt-1">
                            ${job.result.message || 'Completed successfully'}
                        </div>
                    ` : ''}
                    
                    ${job.status === 'failed' && job.error ? `
                        <div class="text-xs text-red-400 mt-1">
                            Error: ${job.error}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function removeVideoJob(jobId) {
            fetch(`/jobs/${jobId}`, { method: 'DELETE' })
                .then(() => {
                    videoActiveJobs.delete(jobId);
                    refreshVideoJobs();
                })
                .catch(error => {
                    console.error('Error removing video job:', error);
                });
        }

        function reloadVideoSidebar() {
            // Trigger an HTMX request to reload the sidebar
            const sidebarElement = document.getElementById('video-metadata-sidebar');
            if (sidebarElement) {
                // Use HTMX to reload the sidebar content
                htmx.ajax('GET', window.location.pathname, {
                    target: '#video-metadata-sidebar',
                    swap: 'outerHTML',
                    select: '#video-metadata-sidebar'
                }).then(() => {
                    console.log('Video sidebar reloaded successfully');
                    // Re-initialize any necessary functionality
                    initializeChoices();
                }).catch(error => {
                    console.error('Failed to reload video sidebar:', error);
                });
            }
        }

        // Initialize video job monitoring on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing jobs related to this video on page load
            refreshVideoJobs();
            
            // Add click-outside handler for mobile queue
            document.addEventListener('click', function(event) {
                const queueSidebar = document.getElementById('queue-sidebar');
                const isMobile = window.innerWidth <= 1024;
                
                if (isMobile && queueSidebar && queueSidebar.classList.contains('mobile-visible')) {
                    // Check if click is outside the queue sidebar and not on the toggle button
                    if (!queueSidebar.contains(event.target) && 
                        !event.target.closest('button[onclick*="toggleQueueSidebar"]')) {
                        queueSidebar.classList.remove('mobile-visible');
                    }
                }
            });
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopVideoJobPolling(); // Ensure polling stops if user navigates away
            
            // Cleanup queue observer
            if (queueObserver) {
                queueObserver.disconnect();
                queueObserver = null;
            }
        });

        // Keyboard navigation for previous/next video
        document.addEventListener('keydown', function(event) {
            // Only handle keyboard navigation if not typing in an input field
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.isContentEditable) {
                return;
            }

            // Left arrow key - previous video
            if (event.key === 'ArrowLeft' && event.ctrlKey) {
                event.preventDefault();
                const prevButton = document.querySelector('a[title*="Previous video"]');
                if (prevButton) {
                    prevButton.click();
                }
            }
            
            // Right arrow key - next video
            if (event.key === 'ArrowRight' && event.ctrlKey) {
                event.preventDefault();
                const nextButton = document.querySelector('a[title*="Next video"]');
                if (nextButton) {
                    nextButton.click();
                }
            }
            
            // Q key - toggle queue sidebar
            if (event.key === 'q' || event.key === 'Q') {
                event.preventDefault();
                toggleQueueSidebar();
            }
            
            // C key - center current video in queue (for testing)
            if (event.key === 'c' || event.key === 'C') {
                event.preventDefault();
                centerCurrentVideoInQueue();
            }
        });

        // Enhanced queue centering functionality
        function centerCurrentVideoInQueue(smooth = true) {
            const currentVideoInQueue = document.getElementById('current-video-in-queue');
            const queueContainer = document.getElementById('video-queue-container');
            const queueSidebar = document.getElementById('queue-sidebar');
            
            if (!currentVideoInQueue || !queueContainer) {
                console.log('Queue centering: Missing elements', {
                    currentVideo: !!currentVideoInQueue,
                    container: !!queueContainer
                });
                return;
            }

            // Wait for layout to be complete
            requestAnimationFrame(() => {
                try {
                    // Check if queue sidebar is collapsed or hidden on mobile
                    const isMobile = window.innerWidth <= 1024;
                    if (queueSidebar && (
                        queueSidebar.classList.contains('queue-collapsed') ||
                        (isMobile && !queueSidebar.classList.contains('mobile-visible'))
                    )) {
                        console.log('Queue sidebar is collapsed or hidden, skipping centering');
                        return;
                    }
                    
                    // Method 1: Use scrollIntoView with block: 'center' (most reliable)
                    if (currentVideoInQueue.scrollIntoView) {
                        currentVideoInQueue.scrollIntoView({
                            behavior: smooth ? 'smooth' : 'auto',
                            block: 'center',
                            inline: 'nearest'
                        });
                        console.log('Queue centered using scrollIntoView');
                        return;
                    }
                    
                    // Method 2: Manual calculation (fallback for older browsers)
                    const containerHeight = queueContainer.clientHeight;
                    const scrollHeight = queueContainer.scrollHeight;
                    const currentVideoHeight = currentVideoInQueue.offsetHeight;
                    
                    // Calculate the offset of the current video within its scrollable container
                    let currentVideoTop = 0;
                    let element = currentVideoInQueue;
                    
                    // Walk up the DOM tree until we reach the scrollable container
                    while (element && element !== queueContainer) {
                        currentVideoTop += element.offsetTop;
                        element = element.offsetParent;
                    }
                    
                    // Debug logging
                    console.log('Queue centering manual calculations:', {
                        containerHeight,
                        scrollHeight,
                        currentVideoTop,
                        currentVideoHeight,
                        currentScrollTop: queueContainer.scrollTop
                    });
                    
                    // Calculate scroll position to center the current video
                    const targetScrollTop = currentVideoTop - (containerHeight / 2) + (currentVideoHeight / 2);
                    
                    // Ensure scroll position is within valid bounds
                    const maxScrollTop = scrollHeight - containerHeight;
                    const finalScrollTop = Math.max(0, Math.min(targetScrollTop, maxScrollTop));
                    
                    console.log('Queue centering target:', {
                        targetScrollTop,
                        maxScrollTop,
                        finalScrollTop
                    });
                    
                    // Scroll to the calculated position
                    if (smooth && queueContainer.scrollTo) {
                        queueContainer.scrollTo({
                            top: finalScrollTop,
                            behavior: 'smooth'
                        });
                    } else {
                        // Fallback for browsers that don't support smooth scrolling
                queueContainer.scrollTop = finalScrollTop;
            }
                    
                    console.log('Queue centered on current video at position:', finalScrollTop);
                } catch (error) {
                    console.error('Error centering queue:', error);
                    // Ultimate fallback: try to at least make the current video visible
                    try {
                        currentVideoInQueue.scrollIntoView({
                            behavior: 'auto',
                            block: 'nearest'
                        });
                    } catch (fallbackError) {
                        console.error('All queue centering methods failed:', fallbackError);
                    }
                }
            });
        }

        // Observer to detect when queue content changes
        let queueObserver = null;
        
        function initializeQueueObserver() {
            const queueContainer = document.getElementById('video-queue-container');
            if (!queueContainer || queueObserver) return;
            
            queueObserver = new MutationObserver((mutations) => {
                let shouldCenter = false;
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        shouldCenter = true;
                    }
                });
                
                if (shouldCenter) {
                    // Small delay to ensure new content is rendered
                    setTimeout(() => centerCurrentVideoInQueue(false), 50);
                }
            });
            
            queueObserver.observe(queueContainer, {
                childList: true,
                subtree: true
            });
        }

        // Center queue on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize queue observer for dynamic updates
            initializeQueueObserver();
            
            // Use a longer delay to ensure all elements are fully rendered and laid out
            setTimeout(() => {
                // Check if the queue sidebar exists and is not collapsed
                const queueSidebar = document.getElementById('queue-sidebar');
                if (queueSidebar && !queueSidebar.classList.contains('queue-collapsed')) {
                    centerCurrentVideoInQueue();
                } else {
                    console.log('Queue sidebar is collapsed or missing on page load, not centering');
                }
            }, 300); // Increased delay to ensure layout is complete
        });

        // Re-center queue when window is resized (in case queue height changes)
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                centerCurrentVideoInQueue();
            }, 250); // Debounce resize events
        });

        
        // Collapsible sections functionality
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const chevron = document.getElementById(sectionId + '-chevron');
            
            if (!content || !chevron) return;
            
            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // Frame Search Modal Functions
        let extractedFrames = [];
        let selectedFrame = null;

        function openFrameSearchModal() {
            document.getElementById('frameSearchModal').classList.remove('hidden');
            resetFrameSearchModal();
        }

        function closeFrameSearchModal() {
            document.getElementById('frameSearchModal').classList.add('hidden');
            resetFrameSearchModal();
        }

        function resetFrameSearchModal() {
            // Reset all steps
            document.getElementById('frame-extraction-step').classList.remove('hidden');
            document.getElementById('frame-selection-step').classList.add('hidden');
            document.getElementById('search-options-step').classList.add('hidden');
            document.getElementById('frame-search-results').classList.add('hidden');
            
            // Reset options
            document.getElementById('multiple-frames-options').classList.add('hidden');
            document.getElementById('custom-timestamps-input').classList.add('hidden');
            document.getElementById('frame-extraction-loading').classList.add('hidden');
            document.getElementById('selected-frame-preview').classList.add('hidden');
            
            // Clear data
            extractedFrames = [];
            selectedFrame = null;
            document.getElementById('extracted-frames-grid').innerHTML = '';
            document.getElementById('frame-search-results-content').innerHTML = '';
        }

        // Keyboard Shortcuts Modal Functions
        function openKeyboardShortcutsModal() {
            document.getElementById('keyboardShortcutsModal').classList.remove('hidden');
        }

        function closeKeyboardShortcutsModal() {
            document.getElementById('keyboardShortcutsModal').classList.add('hidden');
        }

        function extractCurrentFrame() {
            if (!video) {
                alert('Video not ready');
                return;
            }
            
            const currentTime = video.currentTime;
            extractFramesAtTimestamps([currentTime]);
        }

        function extractMultipleFrames() {
            document.getElementById('multiple-frames-options').classList.toggle('hidden');
        }

        function generateFrameTimestamps() {
            if (!video || !video.duration) {
                alert('Video not ready');
                return;
            }
            
            const frameCount = parseInt(document.getElementById('frame-count-select').value);
            const distribution = document.getElementById('frame-distribution-select').value;
            const duration = video.duration;
            const currentTime = video.currentTime;
            
            let timestamps = [];
            
            if (distribution === 'even') {
                // Distribute frames evenly across the video
                for (let i = 0; i < frameCount; i++) {
                    const timestamp = (duration / (frameCount + 1)) * (i + 1);
                    timestamps.push(timestamp);
                }
            } else if (distribution === 'around-current') {
                // Distribute frames around current time
                const timeWindow = Math.min(60, duration / 2); // 60 seconds or half video duration
                const startTime = Math.max(0, currentTime - timeWindow / 2);
                const endTime = Math.min(duration, currentTime + timeWindow / 2);
                
                for (let i = 0; i < frameCount; i++) {
                    const timestamp = startTime + ((endTime - startTime) / (frameCount - 1)) * i;
                    timestamps.push(timestamp);
                }
            } else if (distribution === 'custom') {
                const customInput = document.getElementById('custom-timestamps').value;
                if (!customInput.trim()) {
                    alert('Please enter custom timestamps');
                    return;
                }
                
                try {
                    timestamps = customInput.split(',').map(t => parseFloat(t.trim())).filter(t => !isNaN(t) && t >= 0 && t <= duration);
                    if (timestamps.length === 0) {
                        alert('No valid timestamps found');
                        return;
                    }
                } catch (e) {
                    alert('Invalid timestamp format');
                    return;
                }
            }
            
            extractFramesAtTimestamps(timestamps);
        }

        function extractFramesAtTimestamps(timestamps) {
            document.getElementById('frame-extraction-loading').classList.remove('hidden');
            
            const videoName = '{{ video.name }}';
            const timestampsStr = timestamps.join(',');
            
            const formData = new FormData();
            formData.append('timestamps', timestampsStr);
            formData.append('max_frames', '12');
            
            fetch(`/api/extract-frames/${encodeURIComponent(videoName)}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('frame-extraction-loading').classList.add('hidden');
                
                if (data.extracted_frames && data.extracted_frames.length > 0) {
                    extractedFrames = data.extracted_frames;
                    displayExtractedFrames();
                    showFrameSelectionStep();
                } else {
                    alert('No frames could be extracted. Please try different timestamps.');
                }
            })
            .catch(error => {
                document.getElementById('frame-extraction-loading').classList.add('hidden');
                console.error('Error extracting frames:', error);
                alert('Error extracting frames. Please try again.');
            });
        }

        function displayExtractedFrames() {
            const grid = document.getElementById('extracted-frames-grid');
            grid.innerHTML = '';
            
            extractedFrames.forEach((frame, index) => {
                const frameElement = document.createElement('div');
                frameElement.className = 'relative cursor-pointer group frame-hover-effect';
                frameElement.onclick = () => selectFrame(index);
                
                frameElement.innerHTML = `
                    <img src="${frame.frame_data}" alt="Frame at ${frame.timestamp.toFixed(1)}s" 
                         class="w-full aspect-video object-cover rounded border-2 border-transparent group-hover:border-primary transition-colors duration-200">
                    <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-xs p-1 rounded-b">
                        ${formatTime(frame.timestamp)}
                    </div>
                    <div id="frame-selected-${index}" class="absolute inset-0 bg-primary/20 border-2 border-primary rounded hidden">
                        <div class="absolute top-1 right-1 bg-primary text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                            ✓
                        </div>
                    </div>
                `;
                
                grid.appendChild(frameElement);
            });
        }

        function selectFrame(index) {
            // Clear previous selection
            extractedFrames.forEach((_, i) => {
                document.getElementById(`frame-selected-${i}`).classList.add('hidden');
            });
            
            // Select new frame
            document.getElementById(`frame-selected-${index}`).classList.remove('hidden');
            selectedFrame = extractedFrames[index];
            
            // Update preview
            document.getElementById('selected-frame-image').src = selectedFrame.frame_data;
            document.getElementById('selected-frame-timestamp').textContent = `Timestamp: ${formatTime(selectedFrame.timestamp)}`;
            document.getElementById('selected-frame-preview').classList.remove('hidden');
            
            showSearchOptionsStep();
        }

        function showFrameSelectionStep() {
            document.getElementById('frame-extraction-step').classList.add('hidden');
            document.getElementById('frame-selection-step').classList.remove('hidden');
        }

        function showSearchOptionsStep() {
            document.getElementById('frame-selection-step').classList.add('hidden');
            document.getElementById('search-options-step').classList.remove('hidden');
        }

        function performFrameSearch() {
            if (!selectedFrame) {
                alert('Please select a frame first');
                return;
            }
            
            document.getElementById('frame-search-loading').classList.remove('hidden');
            
            const threshold = parseFloat(document.getElementById('frame-search-threshold').value);
            const maxResults = parseInt(document.getElementById('frame-search-max-results').value);
            
            const formData = new FormData();
            formData.append('frame_data', selectedFrame.frame_data);
            formData.append('similarity_threshold', threshold.toString());
            formData.append('max_results', maxResults.toString());
            
            fetch('/api/semantic-search-by-frame', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('frame-search-loading').classList.add('hidden');
                displayFrameSearchResults(data);
                showSearchResults();
            })
            .catch(error => {
                document.getElementById('frame-search-loading').classList.add('hidden');
                console.error('Error performing frame search:', error);
                alert('Error performing search. Please try again.');
            });
        }

        function displayFrameSearchResults(data) {
            const container = document.getElementById('frame-search-results-content');
            container.innerHTML = '';
            
            if (!data.search_results || data.search_results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <div class="text-lg mb-2">No similar videos found</div>
                        <div class="text-sm">Try adjusting the similarity threshold or selecting a different frame</div>
                    </div>
                `;
                return;
            }
            
            data.search_results.forEach(video => {
                const resultElement = document.createElement('div');
                resultElement.className = 'flex items-center space-x-4 p-3 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition-colors duration-200 cursor-pointer';
                
                // Build URL with timestamp if available
                let videoUrl = `/video/${encodeURIComponent(video.name)}`;
                if (video.best_frame_timestamp !== undefined) {
                    videoUrl += `?t=${video.best_frame_timestamp}`;
                }
                
                resultElement.onclick = () => window.open(videoUrl, '_blank');
                
                resultElement.innerHTML = `
                    <img src="${video.thumbnail || '/static/icons/generic-video-icon.svg'}" alt="${video.display_title}" 
                         class="w-20 h-12 object-cover rounded border border-slate-600">
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-slate-200 truncate">${video.display_title}</div>
                        <div class="text-xs text-slate-400 mt-1">
                            Similarity: ${(video.max_similarity * 100).toFixed(1)}% • 
                            ${video.matching_frames} matching frames • 
                            ${video.duration || 'Unknown duration'}
                            ${video.best_frame_timestamp !== undefined ? ` • Best match at ${formatTime(video.best_frame_timestamp)}` : ''}
                        </div>
                    </div>
                    <div class="text-xs text-slate-400">
                        Score: ${(video.semantic_search_score * 100).toFixed(1)}%
                    </div>
                `;
                
                container.appendChild(resultElement);
            });
            
            // Add summary
            const summary = document.createElement('div');
            summary.className = 'text-xs text-slate-400 text-center py-2 border-t border-slate-600 mt-4';
            summary.textContent = `Found ${data.total_results} videos with ${data.frames_above_threshold} matching frames (threshold: ${(data.similarity_threshold * 100).toFixed(0)}%)`;
            container.appendChild(summary);
        }

        function showSearchResults() {
            document.getElementById('search-options-step').classList.add('hidden');
            document.getElementById('frame-search-results').classList.remove('hidden');
        }

        function openSearchResultsInNewTab() {
            // This could be enhanced to create a dedicated search results page
            alert('Feature coming soon: Open results in dedicated search page');
        }

        // Show/hide custom timestamps input based on distribution selection
        document.addEventListener('DOMContentLoaded', function() {
            const distributionSelect = document.getElementById('frame-distribution-select');
            if (distributionSelect) {
                distributionSelect.addEventListener('change', function() {
                    const customInput = document.getElementById('custom-timestamps-input');
                    if (this.value === 'custom') {
                        customInput.classList.remove('hidden');
                    } else {
                        customInput.classList.add('hidden');
                    }
                });
            }
        });

        // Initialize collapsible sections on page load
        document.addEventListener('DOMContentLoaded', function() {
            // System details section starts expanded
            const systemDetailsContent = document.getElementById('system-details-content');
            const systemDetailsChevron = document.getElementById('system-details-chevron');
            if (systemDetailsContent && systemDetailsChevron) {
                systemDetailsContent.classList.remove('hidden');
                systemDetailsChevron.style.transform = 'rotate(180deg)';
            }
            
            // Media processing section starts collapsed
            const mediaProcessingContent = document.getElementById('media-processing-content');
            const mediaProcessingChevron = document.getElementById('media-processing-chevron');
            if (mediaProcessingContent && mediaProcessingChevron) {
                mediaProcessingContent.classList.add('hidden');
                mediaProcessingChevron.style.transform = 'rotate(0deg)';
            }
            
            // Danger zone section starts collapsed
            const dangerZoneContent = document.getElementById('danger-zone-content');
            const dangerZoneChevron = document.getElementById('danger-zone-chevron');
            if (dangerZoneContent && dangerZoneChevron) {
                dangerZoneContent.classList.add('hidden');
                dangerZoneChevron.style.transform = 'rotate(0deg)';
            }
        });

    </script>

    <!-- Toast Notification Container for Video Page -->
    <div id="toast-container-video" class="fixed bottom-0 right-0 p-6 space-y-3 z-[100]">
        <!-- Toasts will be appended here -->
    </div>
</body>
</html> 