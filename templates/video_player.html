<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.display_title }} - Media Browser</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a73e8',
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col font-sans">
    <header class="bg-slate-800 sticky top-0 z-50 border-b border-slate-700">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
             <div class="flex justify-between items-center h-16">
                <a href="/" class="text-xl lg:text-2xl font-semibold text-white hover:text-primary transition-colors duration-150">Media Browser</a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-screen-2xl p-4 md:p-6 lg:p-8">
        <div class="lg:flex lg:gap-6 xl:gap-8">
            <!-- Video Player Section -->
            <div class="lg:flex-grow mb-6 lg:mb-0">
                <!-- Video Title and Status -->
                <div class="mb-4" id="video-title-header">
                    <h1 class="text-2xl lg:text-3xl font-bold text-slate-100 mb-2 overflow-hidden whitespace-nowrap text-ellipsis" title="{{ video.display_title }}">{{ video.display_title }}</h1>
                    <div id="video-status-indicator">
                        {% if video.has_transcoded_version %}
                            <span class="text-xs font-medium bg-green-500/20 text-green-400 px-2 py-1 rounded-full">Playing Transcoded Version</span>
                        {% else %}
                            <span class="text-xs font-medium bg-amber-500/20 text-amber-400 px-2 py-1 rounded-full">Playing Original Version</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Custom Video Player Container -->
                <div class="aspect-video bg-black rounded-lg overflow-hidden shadow-2xl relative group">
                    <video id="main-video-player" 
                           class="w-full h-full" 
                           poster="{{ video.thumbnail }}"
                           preload="metadata"
                           onclick="togglePlay()">
                        <source src="{{ video.path }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    
                    <!-- Custom Video Controls -->
                    <div id="video-controls" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/60 to-transparent p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <!-- Timeline Container -->
                        <div class="mb-3">
                            <div class="flex items-center text-white text-sm mb-2">
                                <span id="current-time">0:00</span>
                                <span class="mx-2">/</span>
                                <span id="duration">0:00</span>
                            </div>
                            <!-- Timeline -->
                            <div class="relative h-2 bg-white/20 rounded-full cursor-pointer" id="timeline-container">
                                <div id="timeline-progress" class="absolute top-0 left-0 h-full bg-primary rounded-full pointer-events-none" style="width: 0%"></div>
                                <div id="timeline-handle" class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-lg opacity-0 transition-opacity duration-200 pointer-events-none" style="left: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <!-- Play/Pause Button -->
                                <button id="play-pause-btn" onclick="togglePlay()" class="text-white hover:text-primary transition-colors duration-150">
                                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                                    </svg>
                                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 hidden">
                                        <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0114.25 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75h-1.5a.75.75 0 01-.75-.75V5.25z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                
                                <!-- Volume Controls -->
                                <div class="flex items-center space-x-2">
                                    <button id="mute-btn" onclick="toggleMute()" class="text-white hover:text-primary transition-colors duration-150">
                                        <svg id="volume-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                                        </svg>
                                        <svg id="mute-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 hidden">
                                            <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 001.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06zM17.78 9.22a.75.75 0 10-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 001.06 1.06L19.5 13.06l1.72 1.72a.75.75 0 101.06-1.06L20.56 12l1.72-1.72a.75.75 0 00-1.06-1.06L19.5 10.94l-1.72-1.72z" />
                                        </svg>
                                    </button>
                                    <div class="w-16 h-1 bg-white/20 rounded-full cursor-pointer" id="volume-container" onclick="setVolume(event)">
                                        <div id="volume-progress" class="h-full bg-white rounded-full" style="width: 100%"></div>
                                    </div>
                                </div>
                                
                                <!-- Time Display -->
                                <div class="text-white text-sm">
                                    <span id="current-time-main">0:00</span> / <span id="duration-main">0:00</span>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-3">
                                <!-- Speed Control -->
                                <div class="relative">
                                    <button id="speed-btn" onclick="toggleSpeedMenu()" class="text-white hover:text-primary transition-colors duration-150 text-sm font-medium">
                                        1x
                                    </button>
                                    <div id="speed-menu" class="absolute bottom-8 right-0 bg-slate-800 border border-slate-600 rounded-lg py-2 min-w-16 hidden">
                                        <button onclick="setSpeed(0.5)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">0.5x</button>
                                        <button onclick="setSpeed(0.75)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">0.75x</button>
                                        <button onclick="setSpeed(1)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">1x</button>
                                        <button onclick="setSpeed(1.25)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">1.25x</button>
                                        <button onclick="setSpeed(1.5)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">1.5x</button>
                                        <button onclick="setSpeed(2)" class="block w-full px-3 py-1 text-left text-white hover:bg-slate-700 text-sm">2x</button>
                                    </div>
                                </div>
                                
                                <!-- Fullscreen Button -->
                                <button id="fullscreen-btn" onclick="toggleFullscreen()" class="text-white hover:text-primary transition-colors duration-150">
                                    <svg id="fullscreen-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                        <path fill-rule="evenodd" d="M15 3.75a.75.75 0 01.75-.75h4.5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0V5.56l-3.97 3.97a.75.75 0 11-1.06-1.06l3.97-3.97h-2.69a.75.75 0 01-.75-.75zm-12 0A.75.75 0 013.75 3h4.5a.75.75 0 010 1.5H5.56l3.97 3.97a.75.75 0 01-1.06 1.06L4.5 5.56v2.69A.75.75 0 013 7.5v-4.5zm11.47 11.78a.75.75 0 111.06-1.06l3.97 3.97v-2.69a.75.75 0 011.5 0v4.5a.75.75 0 01-.75.75h-4.5a.75.75 0 010-1.5h2.69l-3.97-3.97zm-4.94-1.06a.75.75 0 010 1.06L5.56 19.5h2.69a.75.75 0 010 1.5h-4.5a.75.75 0 01-.75-.75v-4.5a.75.75 0 011.5 0v2.69l3.97-3.97a.75.75 0 011.06 0z" clip-rule="evenodd" />
                                    </svg>
                                    <svg id="exit-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 hidden">
                                        <path fill-rule="evenodd" d="M9.53 2.47a.75.75 0 010 1.06L6.81 6.25H9.5a.75.75 0 010 1.5H6.75a.75.75 0 01-.75-.75V4.25a.75.75 0 011.5 0v2.69L10.22 4.22a.75.75 0 011.06 0zM2.47 9.53a.75.75 0 011.06 0L6.25 6.81V9.5a.75.75 0 001.5 0V6.75a.75.75 0 00-.75-.75H4.25a.75.75 0 000 1.5h2.69L4.22 10.22a.75.75 0 000 1.06zm16.28 4.94a.75.75 0 01-1.06 0L14.97 11.75H17.5a.75.75 0 000-1.5h-2.75a.75.75 0 00-.75.75v2.75a.75.75 0 001.5 0v-2.69l2.72 2.72a.75.75 0 000 1.06zm-4.94 4.94a.75.75 0 010-1.06L16.53 15.75H14.5a.75.75 0 010-1.5h2.75a.75.75 0 01.75.75v2.75a.75.75 0 01-1.5 0V14.97l-2.72 2.72a.75.75 0 01-1.06 0z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-black/50 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    </div>
                    
                    <!-- Center Play Button -->
                    <div id="center-play-btn" class="absolute inset-0 flex items-center justify-center cursor-pointer" onclick="togglePlay()">
                        <div class="bg-black/60 rounded-full p-4 hover:bg-black/80 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-white">
                                <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metadata Sidebar Section -->
            {% include "_video_metadata_sidebar.html" %}
        </div>

        <!-- Video Queue Section -->
        {% if video_queue %}
        <div class="mt-8 bg-slate-800 rounded-lg shadow-xl border border-slate-700">
            <!-- Queue Header (Clickable) -->
            <div class="flex items-center justify-between p-5 cursor-pointer hover:bg-slate-700/50 transition-colors duration-150 rounded-t-lg" 
                 onclick="toggleQueue()">
                <h2 class="text-xl font-semibold text-slate-100 flex items-center">
                    <span>Up Next</span>
                    <span class="ml-2 text-slate-400 text-sm">({{ video_queue|length }} videos)</span>
                </h2>
                <div class="flex items-center text-slate-400">
                    <svg id="queue-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" 
                         class="w-5 h-5 transform transition-transform duration-200">
                        <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 01-1.06 0l-7.5-7.5a.75.75 0 011.06-1.06L12 14.69l6.97-6.97a.75.75 0 111.06 1.06l-7.5 7.5z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
            
            <!-- Queue Content (Collapsible) -->
            <div id="queue-content" class="border-t border-slate-700">
                <div class="p-5 pt-4 space-y-3 max-h-96 overflow-y-auto pr-2">
                    {% for q_video in video_queue %}
                        <div class="flex items-center justify-between group">
                            <a href="{{ url_for('video_player_page', video_name=q_video.name) }}" 
                               class="text-sm {% if q_video.id_db == video.id_db %}text-primary font-semibold{% else %}text-slate-300 hover:text-primary{% endif %} transition-colors duration-150 overflow-hidden whitespace-nowrap text-ellipsis flex-grow" 
                               title="{{ q_video.display_title }}">
                                {{ loop.index }}. {{ q_video.display_title }}
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

    </main>

    <!-- Advanced Transcoding Modal -->
    <div id="advancedTranscodingModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-slate-900 bg-opacity-75" onclick="closeAdvancedTranscodingModal()"></div>

            <!-- Modal content -->
            <div class="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-slate-800 shadow-xl rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-slate-100">Advanced Transcoding Options</h3>
                    <button onclick="closeAdvancedTranscodingModal()" class="text-slate-400 hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <form hx-post="{{ url_for('transcode_specific_video_advanced_endpoint', video_name=video.name) }}" 
                      hx-target="#advanced-transcoding-status" 
                      hx-swap="innerHTML" 
                      hx-indicator="#advanced-loading-spinner"
                      hx-on::after-request="closeAdvancedTranscodingModal()">
                    
                    <div class="space-y-4">
                        <div>
                            <label for="modal-resolution" class="block text-sm font-medium text-slate-300 mb-2">Resolution</label>
                            <select name="resolution" id="modal-resolution" 
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="original">Original Resolution</option>
                                <option value="1080p">1080p (Full HD)</option>
                                <option value="720p" selected>720p (HD)</option>
                                <option value="480p">480p (SD)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-quality-mode" class="block text-sm font-medium text-slate-300 mb-2">Quality Mode</label>
                            <select name="quality_mode" id="modal-quality-mode" onchange="toggleModalQualityOptions()"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="crf" selected>CRF (Constant Quality)</option>
                                <option value="bitrate">Bitrate (Constant Rate)</option>
                            </select>
                        </div>
                        
                        <div id="modal-crf-container">
                            <label for="modal-crf" class="block text-sm font-medium text-slate-300 mb-2">CRF Quality (Lower = Better)</label>
                            <select name="crf" id="modal-crf"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="18">18 (Very High Quality)</option>
                                <option value="23" selected>23 (High Quality)</option>
                                <option value="28">28 (Medium Quality)</option>
                                <option value="32">32 (Lower Quality)</option>
                            </select>
                        </div>
                        
                        <div id="modal-bitrate-container" style="display: none;">
                            <label for="modal-video-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Video Bitrate</label>
                            <select name="video_bitrate" id="modal-video-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="1M">1 Mbps</option>
                                <option value="2M" selected>2 Mbps</option>
                                <option value="4M">4 Mbps</option>
                                <option value="8M">8 Mbps</option>
                                <option value="12M">12 Mbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-audio-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Audio Bitrate</label>
                            <select name="audio_bitrate" id="modal-audio-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="96k">96 kbps</option>
                                <option value="128k" selected>128 kbps</option>
                                <option value="192k">192 kbps</option>
                                <option value="256k">256 kbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-preset" class="block text-sm font-medium text-slate-300 mb-2">Encoding Speed</label>
                            <select name="preset" id="modal-preset"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="ultrafast">Ultra Fast (Larger Files)</option>
                                <option value="fast">Fast</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="slow">Slow (Better Compression)</option>
                            </select>
                        </div>

                        <div>
                            <label for="modal-profile" class="block text-sm font-medium text-slate-300 mb-2">H.264 Profile</label>
                            <select name="profile" id="modal-profile"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="baseline">Baseline (Max Compatibility)</option>
                                <option value="main">Main (Good Quality/Compatibility)</option>
                                <option value="high" selected>High (Best Quality)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button type="button" onclick="closeAdvancedTranscodingModal()" 
                                class="flex-1 bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 text-sm">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                            <span id="advanced-loading-spinner" class="htmx-indicator animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                            Start Transcoding
                        </button>
                    </div>
                </form>

                <div id="advanced-transcoding-status" class="mt-4 p-3 bg-slate-700/50 rounded-md min-h-[40px] text-sm text-slate-300"></div>
            </div>
        </div>
    </div>

    <script>
        let choicesTagsInstance = null;
        let video = null;
        let isVideoReady = false;
        let currentSpeed = 1;

        // Initialize video player when page loads
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('main-video-player');
            initializeVideoPlayer();
        });

        function initializeVideoPlayer() {
            if (!video) return;

            // Video event listeners
            video.addEventListener('loadedmetadata', onVideoMetadataLoaded);
            video.addEventListener('loadeddata', onVideoDataLoaded);
            video.addEventListener('timeupdate', updateProgress);
            video.addEventListener('play', onVideoPlay);
            video.addEventListener('pause', onVideoPause);
            video.addEventListener('waiting', showLoading);
            video.addEventListener('canplay', hideLoading);
            video.addEventListener('ended', onVideoEnded);

            // Timeline event listeners
            const timelineContainer = document.getElementById('timeline-container');
            timelineContainer.addEventListener('click', seekTo);
            timelineContainer.addEventListener('mouseenter', () => {
                document.getElementById('timeline-handle').style.opacity = '1';
            });
            timelineContainer.addEventListener('mouseleave', () => {
                document.getElementById('timeline-handle').style.opacity = '0';
            });

            // Hide center play button initially if autoplay
            updateCenterPlayButton();
        }

        function togglePlay() {
            if (!video) return;

            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }

        function onVideoPlay() {
            document.getElementById('play-icon').classList.add('hidden');
            document.getElementById('pause-icon').classList.remove('hidden');
            document.getElementById('center-play-btn').classList.add('hidden');
        }

        function onVideoPause() {
            document.getElementById('play-icon').classList.remove('hidden');
            document.getElementById('pause-icon').classList.add('hidden');
            document.getElementById('center-play-btn').classList.remove('hidden');
        }

        function onVideoEnded() {
            document.getElementById('play-icon').classList.remove('hidden');
            document.getElementById('pause-icon').classList.add('hidden');
            document.getElementById('center-play-btn').classList.remove('hidden');
        }

        function onVideoMetadataLoaded() {
            updateDuration();
            console.log('Video metadata loaded - duration:', video.duration);
        }

        function onVideoDataLoaded() {
            isVideoReady = true;
            console.log('Video data loaded - ready for seeking');
        }

        function updateCenterPlayButton() {
            const centerBtn = document.getElementById('center-play-btn');
            if (video && video.paused) {
                centerBtn.classList.remove('hidden');
            } else {
                centerBtn.classList.add('hidden');
            }
        }

        function showLoading() {
            document.getElementById('loading-spinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        function updateDuration() {
            if (!video) return;
            const duration = formatTime(video.duration);
            document.getElementById('duration').textContent = duration;
            document.getElementById('duration-main').textContent = duration;
        }

        function updateProgress() {
            if (!video) return;
            
            const progress = (video.currentTime / video.duration) * 100;
            const currentTime = formatTime(video.currentTime);
            
            document.getElementById('timeline-progress').style.width = progress + '%';
            document.getElementById('timeline-handle').style.left = progress + '%';
            document.getElementById('current-time').textContent = currentTime;
            document.getElementById('current-time-main').textContent = currentTime;
        }

        function seekTo(event) {
            if (!video) return;
            
            // Check if video is ready for seeking
            if (!isVideoReady || !video.duration || isNaN(video.duration) || video.duration === 0) {
                console.log('Video not ready for seeking - ready:', isVideoReady, 'duration:', video.duration);
                return;
            }
            
            const timelineContainer = document.getElementById('timeline-container');
            const rect = timelineContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const progress = Math.max(0, Math.min(1, clickX / rect.width)); // Clamp between 0 and 1
            const newTime = progress * video.duration;
            
            // Validate the new time
            if (isNaN(newTime) || newTime < 0 || newTime > video.duration) {
                console.log('Invalid seek time calculated:', newTime);
                return;
            }
            
            try {
                video.currentTime = newTime;
                console.log('Seeking to:', newTime, 'seconds (', Math.round(progress * 100), '% )');
            } catch (error) {
                console.error('Error seeking video:', error);
            }
        }

        function toggleMute() {
            if (!video) return;
            
            video.muted = !video.muted;
            updateVolumeIcon();
            updateVolumeBar();
        }

        function updateVolumeIcon() {
            const volumeIcon = document.getElementById('volume-icon');
            const muteIcon = document.getElementById('mute-icon');
            
            if (video.muted || video.volume === 0) {
                volumeIcon.classList.add('hidden');
                muteIcon.classList.remove('hidden');
            } else {
                volumeIcon.classList.remove('hidden');
                muteIcon.classList.add('hidden');
            }
        }

        function updateVolumeBar() {
            const volumeProgress = document.getElementById('volume-progress');
            const volume = video.muted ? 0 : video.volume;
            volumeProgress.style.width = (volume * 100) + '%';
        }

        function setVolume(event) {
            if (!video) return;
            
            const volumeContainer = document.getElementById('volume-container');
            const rect = volumeContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const volume = Math.max(0, Math.min(1, clickX / rect.width));
            
            video.volume = volume;
            video.muted = false;
            updateVolumeIcon();
            updateVolumeBar();
        }

        function toggleSpeedMenu() {
            const speedMenu = document.getElementById('speed-menu');
            speedMenu.classList.toggle('hidden');
        }

        function setSpeed(speed) {
            if (!video) return;
            
            video.playbackRate = speed;
            currentSpeed = speed;
            document.getElementById('speed-btn').textContent = speed + 'x';
            document.getElementById('speed-menu').classList.add('hidden');
        }

        function toggleFullscreen() {
            const playerContainer = video.closest('.aspect-video');
            
            if (!document.fullscreenElement) {
                playerContainer.requestFullscreen().catch(err => {
                    console.log('Error attempting to enable fullscreen:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', function() {
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            const exitFullscreenIcon = document.getElementById('exit-fullscreen-icon');
            
            if (document.fullscreenElement) {
                fullscreenIcon.classList.add('hidden');
                exitFullscreenIcon.classList.remove('hidden');
            } else {
                fullscreenIcon.classList.remove('hidden');
                exitFullscreenIcon.classList.add('hidden');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (!video) return;
            
            // Only handle shortcuts when not typing in input fields
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    video.currentTime = Math.max(0, video.currentTime - 10);
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    video.currentTime = Math.min(video.duration, video.currentTime + 10);
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    video.volume = Math.min(1, video.volume + 0.1);
                    updateVolumeIcon();
                    updateVolumeBar();
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    video.volume = Math.max(0, video.volume - 0.1);
                    updateVolumeIcon();
                    updateVolumeBar();
                    break;
                case 'KeyM':
                    event.preventDefault();
                    toggleMute();
                    break;
                case 'KeyF':
                    event.preventDefault();
                    toggleFullscreen();
                    break;
            }
        });

        // Close speed menu when clicking outside
        document.addEventListener('click', function(event) {
            const speedBtn = document.getElementById('speed-btn');
            const speedMenu = document.getElementById('speed-menu');
            
            if (!speedBtn.contains(event.target) && !speedMenu.contains(event.target)) {
                speedMenu.classList.add('hidden');
            }
        });

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function initializeChoices() {
            const tagsInput = document.getElementById('tags-input');
            if (tagsInput) {
                if (choicesTagsInstance) {
                    choicesTagsInstance.destroy();
                }
                choicesTagsInstance = new Choices(tagsInput, {
                    removeItemButton: true,
                    delimiter: ',',
                    editItems: true,
                    allowHTML: false,
                    placeholderValue: 'Enter tags',
                    duplicateItemsAllowed: false,
                    classNames: {
                        containerOuter: 'choices choices-tags-outer',
                        containerInner: 'choices__inner bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus-within:ring-2 focus-within:ring-primary focus-within:border-primary min-h-[40px]',
                        input: 'choices__input choices__input--cloned text-slate-200',
                        inputCloned: 'choices__input--cloned',
                        list: 'choices__list',
                        listItems: 'choices__list--multiple',
                        listSingle: 'choices__list--single',
                        listDropdown: 'choices__list--dropdown',
                        item: 'choices__item bg-primary/80 border-primary/90 text-white',
                        itemSelectable: 'choices__item--selectable',
                        itemDisabled: 'choices__item--disabled',
                        itemChoice: 'choices__item--choice',
                        placeholder: 'choices__placeholder text-slate-500',
                        group: 'choices__group',
                        groupHeading : 'choices__heading',
                        button: 'choices__button',
                        activeState: 'is-active',
                        focusState: 'is-focused',
                        openState: 'is-open',
                        disabledState: 'is-disabled',
                        highlightedState: 'is-highlighted',
                        selectedState: 'is-selected',
                        flippedState: 'is-flipped',
                        loadingState: 'is-loading',
                        noResults: 'has-no-results',
                        noChoices: 'has-no-choices'
                    }
                });
            }
        }

        function toggleEditMetadataMode(editing) {
            const displaySection = document.getElementById('metadata-display-section');
            const editForm = document.getElementById('metadata-edit-form');
            const systemDetails = document.getElementById('system-details-section'); // For button positioning
            const editButton = document.getElementById('edit-metadata-button');

            if (editing) {
                displaySection.classList.add('hidden');
                editForm.classList.remove('hidden');
                systemDetails.classList.add('hidden'); // Hide system details during edit
                initializeChoices();
            } else {
                displaySection.classList.remove('hidden');
                editForm.classList.add('hidden');
                systemDetails.classList.remove('hidden'); // Show system details
                if (choicesTagsInstance) {
                   // choicesTagsInstance.destroy(); // Or just clear input if needed on cancel
                }
            }
        }
        
        function handleMetadataUpdateResponse(event) {
            const messageDiv = document.getElementById('metadata-edit-message');
            if (event.detail.successful) {
                // The hx-swap="outerHTML" on the form for #video-metadata-sidebar handles the UI update.
                // So, we just need to ensure we are back in display mode.
                // The new sidebar that is swapped in should be in display mode by default.
                // However, if the swap target was different, we might call toggleEditMetadataMode(false) here.
                // console.log("Metadata updated successfully, sidebar swapped.");
                // toggleEditMetadataMode(false); // Will be handled by full sidebar swap
            } else {
                if (messageDiv) {
                    let errorMsg = "Failed to update metadata.";
                    try {
                        const xhrResponse = JSON.parse(event.detail.xhr.responseText);
                        errorMsg = xhrResponse.detail || xhrResponse.message || errorMsg;
                    } catch (e) { /* Use default error msg */ }
                    messageDiv.innerHTML = `<p class="text-red-400">${errorMsg}</p>`;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup if needed (e.g. if form was visible by default)
            // toggleEditMetadataMode(false); // Ensure starts in display mode
        });

        // If HTMX swaps in the sidebar (e.g. after successful edit), re-ensure edit mode is off
        // and Choices.js is not active on a non-existent input if the form was destroyed.
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'video-metadata-sidebar') {
                toggleEditMetadataMode(false); // Ensure we are in display mode
                 const newEditButton = document.getElementById('edit-metadata-button');
                 if(newEditButton) {
                    // If new button exists, we can assume the display section is there.
                 } else {
                    // This case might happen if an error prevented full sidebar swap
                 }
            }
        });

        function openAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.remove('hidden');
        }

        function closeAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.add('hidden');
        }

        function toggleModalQualityOptions() {
            const qualityMode = document.getElementById('modal-quality-mode').value;
            const crfContainer = document.getElementById('modal-crf-container');
            const bitrateContainer = document.getElementById('modal-bitrate-container');
            
            if (qualityMode === 'crf') {
                crfContainer.style.display = 'block';
                bitrateContainer.style.display = 'none';
            } else {
                crfContainer.style.display = 'none';
                bitrateContainer.style.display = 'block';
            }
        }

        // Close modal when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAdvancedTranscodingModal();
            }
        });

        // Toggle queue visibility
        function toggleQueue() {
            const queueContent = document.getElementById('queue-content');
            const chevron = document.getElementById('queue-chevron');
            
            if (queueContent.style.display === 'none') {
                queueContent.style.display = 'block';
                chevron.classList.remove('rotate-180');
            } else {
                queueContent.style.display = 'none';
                chevron.classList.add('rotate-180');
            }
        }

        // Handle new transcode event triggered by HX-Trigger from server
        document.body.addEventListener('newTranscodeAvailable', function(event) {
            const newPath = event.detail.newPath;
            const fileName = event.detail.fileName;
            const player = document.getElementById('main-video-player');
            const videoStatusSpan = document.querySelector('#video-status-indicator span'); // More robust selector

            if (player && newPath) {
                player.src = newPath;
                player.load(); // Load the new source
                // player.play(); // Optionally auto-play
                
                if (videoStatusSpan) {
                    videoStatusSpan.textContent = `Playing Advanced Transcode: ${fileName}`;
                    videoStatusSpan.className = 'text-xs font-medium bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded-full';
                }
                
                // Update the download link if it needs to reflect the newest transcode (optional)
                // const downloadLink = document.getElementById('download-original-link');
                // if(downloadLink) { /* update if needed */ }

                // Close the modal as the primary action is complete
                closeAdvancedTranscodingModal(); 
                
                // Optionally, disable the basic transcode button if this advanced one supersedes it
                const basicTranscodeButton = document.querySelector('button[hx-post*="transcode_specific_video_endpoint"]');
                if (basicTranscodeButton) {
                    // basicTranscodeButton.disabled = true;
                    // basicTranscodeButton.innerText = 'Advanced Version Created';
                }
            } else {
                console.error("Could not update player. Player or newPath missing.", event.detail);
            }
        });
    </script>
</body>
</html> 