<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.name }} - Media Browser</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a73e8',
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen flex flex-col font-sans">
    <header class="bg-slate-800 sticky top-0 z-50 border-b border-slate-700">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
             <div class="flex justify-between items-center h-16">
                <a href="/" class="text-xl lg:text-2xl font-semibold text-white hover:text-primary transition-colors duration-150">Media Browser</a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto max-w-screen-2xl p-4 md:p-6 lg:p-8">
        <div class="lg:flex lg:gap-6 xl:gap-8">
            <!-- Video Player Section -->
            <div class="lg:flex-grow mb-6 lg:mb-0">
                <!-- Video Title and Status -->
                <div class="mb-4">
                    <h2 class="text-2xl lg:text-3xl font-bold text-slate-100 mb-2 overflow-hidden whitespace-nowrap text-ellipsis">{{ video.name }}</h2>
                    <div id="video-status-indicator">
                        {% if video.has_transcoded_version %}
                            <span class="text-xs font-medium bg-green-500/20 text-green-400 px-2 py-1 rounded-full">Playing Transcoded Version</span>
                        {% else %}
                            <span class="text-xs font-medium bg-amber-500/20 text-amber-400 px-2 py-1 rounded-full">Playing Original Version</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Video Player Container -->
                <div class="aspect-video bg-black rounded-lg overflow-hidden shadow-2xl">
                    <video id="main-video-player" 
                           class="w-full h-full" 
                           controls 
                           autoplay 
                           poster="{{ video.thumbnail }}"
                           preload="metadata">
                        <source src="{{ video.path }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>

            <!-- Metadata Sidebar Section -->
            <div class="lg:w-96 xl:w-[400px] lg:flex-shrink-0 bg-slate-800 p-5 rounded-lg shadow-xl">
                <h2 class="text-xl font-semibold mb-1 text-white overflow-hidden whitespace-nowrap text-ellipsis" title="{{ video.name }}">{{ video.name }}</h2>
                <p class="text-xs text-slate-400 mb-4">Uploaded/Found Details</p>
                
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-slate-400 font-medium">Duration:</span>
                        <span class="text-slate-200">{{ video.duration }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400 font-medium">Resolution:</span>
                        <span class="text-slate-200">{{ video.resolution }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400 font-medium">FPS:</span>
                        <span class="text-slate-200">{{ video.fps }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400 font-medium">Size:</span>
                        <span class="text-slate-200">{{ "%.2f" | format(video.size / (1024*1024)) }} MB</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400 font-medium">Path:</span>
                        <span class="text-slate-200 overflow-hidden whitespace-nowrap text-ellipsis" title="{{ video.path }}">{{ video.path }}</span>
                    </div>
                </div>
                
                <div class="mt-8 space-y-4">
                    <a href="{{ video.original_path_for_download }}" download class="w-full bg-primary text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                            <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
                            <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                        </svg>
                        Download Original ({{ (video.size / (1024*1024)) | round(2) }} MB)
                    </a>

                    {% if not video.has_specific_thumbnail %}
                    <button 
                        hx-post="{{ url_for('generate_specific_thumbnail_endpoint', video_name=video.name) }}"
                        hx-indicator="#thumbnail-spinner-{{ video.name | slugify_for_id }}"
                        hx-on::after-request="
                            let player = document.getElementById('main-video-player');
                            let newPosterUrl = event.detail.xhr.getResponseHeader('X-Thumbnail-Url');
                            if (newPosterUrl) {
                                player.poster = newPosterUrl;
                                this.remove(); // Remove button after success
                                let statusDiv = document.getElementById('thumbnail-status-message-{{ video.name | slugify_for_id }}');
                                if(statusDiv) statusDiv.innerHTML = '<p class=\'text-green-400 text-xs mt-2\'>Thumbnail generated and updated!</p>';
                            } else {
                                let statusDiv = document.getElementById('thumbnail-status-message-{{ video.name | slugify_for_id }}');
                                if(statusDiv) statusDiv.innerHTML = '<p class=\'text-red-400 text-xs mt-2\'>Failed to get thumbnail URL from response.</p>';
                            }
                        "
                        class="w-full bg-amber-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-amber-500 focus:outline-none focus:ring-2 focus:ring-amber-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                        <span id="thumbnail-spinner-{{ video.name | slugify_for_id }}" class="htmx-indicator animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                        Generate Thumbnail
                    </button>
                    <div id="thumbnail-status-message-{{ video.name | slugify_for_id }}"></div>
                    {% endif %}

                    {% if video.type == 'video' and not video.has_transcoded_version %}
                    <button 
                        hx-post="{{ url_for('transcode_specific_video_endpoint', video_name=video.name) }}"
                        hx-indicator="#transcode-spinner-{{ video.name | slugify_for_id }}"
                        hx-on::after-request="
                            this.innerText = 'Transcoding Started (refresh to play)'; 
                            this.disabled = true;
                            let statusDiv = document.getElementById('transcode-status-message-{{ video.name | slugify_for_id }}');
                            if(statusDiv) statusDiv.innerHTML = '<p class=\'text-sky-400 text-xs mt-2\'>Transcoding initiated. Refresh the page after a while to see if the transcoded version is available.</p>';
                        "
                        class="w-full bg-sky-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                        <span id="transcode-spinner-{{ video.name | slugify_for_id }}" class="htmx-indicator animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                        Create Web-Optimized Version (MP4)
                    </button>
                    <div id="transcode-status-message-{{ video.name | slugify_for_id }}"></div>
                    {% endif %}

                    {% if video.type == 'video' and not video.has_preview %}
                    <button 
                        hx-post="{{ url_for('generate_specific_preview_endpoint', video_name=video.name) }}"
                        hx-indicator="#preview-spinner-{{ video.name | slugify_for_id }}"
                        hx-on::after-request="
                            let newPreviewUrl = event.detail.xhr.getResponseHeader('X-Preview-Url');
                            if (newPreviewUrl) {
                                this.innerText = 'Preview Generated'; 
                                this.disabled = true;
                                let statusDiv = document.getElementById('preview-status-message-{{ video.name | slugify_for_id }}');
                                if(statusDiv) statusDiv.innerHTML = '<p class=\'text-purple-400 text-xs mt-2\'>Hover preview generated! It will be used in the media browser.</p>';
                                // Optionally, update video.has_preview and video.preview_url if we were managing state here
                            } else {
                                this.innerText = 'Preview Generation Failed';
                                let statusDiv = document.getElementById('preview-status-message-{{ video.name | slugify_for_id }}');
                                if(statusDiv) statusDiv.innerHTML = '<p class=\'text-red-400 text-xs mt-2\'>Failed to generate preview. Check logs.</p>';
                            }
                        "
                        class="w-full bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                        <span id="preview-spinner-{{ video.name | slugify_for_id }}" class="htmx-indicator animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                        Generate Hover Preview (5s)
                    </button>
                    <div id="preview-status-message-{{ video.name | slugify_for_id }}"></div>
                    {% endif %}

                    <!-- Advanced Transcoding Button -->
                    {% if video.type == 'video' %}
                    <button 
                        onclick="openAdvancedTranscodingModal()"
                        class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-5 rounded-lg hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-2">
                            <path fill-rule="evenodd" d="M11.828 2.25c-.916 0-1.699.663-1.85 1.567l-.091.549a.798.798 0 01-.517.608 7.45 7.45 0 00-.478.198.798.798 0 01-.796-.064l-.453-.324a1.875 1.875 0 00-2.416.2l-.243.243a1.875 1.875 0 00-.2 2.416l.324.453a.798.798 0 01.064.796 7.448 7.448 0 00-.198.478.798.798 0 01-.608.517l-.549.091A1.875 1.875 0 002.25 11.828v.344c0 .916.663 1.699 1.567 1.85l.549.091c.281.047.508.25.608.517.06.162.127.321.198.478a.798.798 0 01-.064.796l-.324.453a1.875 1.875 0 00.2 2.416l.243.243c.648.648 1.67.733 2.416.2l.453-.324a.798.798 0 01.796-.064c.157.071.316.137.478.198.267.1.47.327.517.608l.091.549a1.875 1.875 0 001.85 1.567h.344c.916 0 1.699-.663 1.85-1.567l.091-.549a.798.798 0 01.517-.608 7.52 7.52 0 00.478-.198.798.798 0 01.796.064l.453.324a1.875 1.875 0 002.416-.2l.243-.243c.648-.648.733-1.67.2-2.416l-.324-.453a.798.798 0 01-.064-.796c.071-.157.137-.316.198-.478.1-.267.327-.47.608-.517l.549-.091A1.875 1.875 0 0021.75 12.172v-.344c0-.916-.663-1.699-1.567-1.85l-.549-.091a.798.798 0 01-.608-.517 7.507 7.507 0 00-.198-.478.798.798 0 01.064-.796l.324-.453a1.875 1.875 0 00-.2-2.416l-.243-.243a1.875 1.875 0 00-2.416-.2l-.453.324a.798.798 0 01-.796.064 7.462 7.462 0 00-.478-.198.798.798 0 01-.517-.608l-.091-.549A1.875 1.875 0 0012.172 2.25h-.344zM12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" clip-rule="evenodd" />
                        </svg>
                        Advanced Transcoding Options
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>

    <!-- Advanced Transcoding Modal -->
    <div id="advancedTranscodingModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="fixed inset-0 transition-opacity bg-slate-900 bg-opacity-75" onclick="closeAdvancedTranscodingModal()"></div>

            <!-- Modal content -->
            <div class="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform bg-slate-800 shadow-xl rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-slate-100">Advanced Transcoding Options</h3>
                    <button onclick="closeAdvancedTranscodingModal()" class="text-slate-400 hover:text-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <form hx-post="{{ url_for('transcode_specific_video_advanced_endpoint', video_name=video.name) }}" 
                      hx-target="#advanced-transcoding-status" 
                      hx-swap="innerHTML" 
                      hx-indicator="#advanced-loading-spinner"
                      hx-on::after-request="closeAdvancedTranscodingModal()">
                    
                    <div class="space-y-4">
                        <div>
                            <label for="modal-resolution" class="block text-sm font-medium text-slate-300 mb-2">Resolution</label>
                            <select name="resolution" id="modal-resolution" 
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="original">Original Resolution</option>
                                <option value="1080p">1080p (Full HD)</option>
                                <option value="720p" selected>720p (HD)</option>
                                <option value="480p">480p (SD)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-quality-mode" class="block text-sm font-medium text-slate-300 mb-2">Quality Mode</label>
                            <select name="quality_mode" id="modal-quality-mode" onchange="toggleModalQualityOptions()"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="crf" selected>CRF (Constant Quality)</option>
                                <option value="bitrate">Bitrate (Constant Rate)</option>
                            </select>
                        </div>
                        
                        <div id="modal-crf-container">
                            <label for="modal-crf" class="block text-sm font-medium text-slate-300 mb-2">CRF Quality (Lower = Better)</label>
                            <select name="crf" id="modal-crf"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="18">18 (Very High Quality)</option>
                                <option value="23" selected>23 (High Quality)</option>
                                <option value="28">28 (Medium Quality)</option>
                                <option value="32">32 (Lower Quality)</option>
                            </select>
                        </div>
                        
                        <div id="modal-bitrate-container" style="display: none;">
                            <label for="modal-video-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Video Bitrate</label>
                            <select name="video_bitrate" id="modal-video-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="1M">1 Mbps</option>
                                <option value="2M" selected>2 Mbps</option>
                                <option value="4M">4 Mbps</option>
                                <option value="8M">8 Mbps</option>
                                <option value="12M">12 Mbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-audio-bitrate" class="block text-sm font-medium text-slate-300 mb-2">Audio Bitrate</label>
                            <select name="audio_bitrate" id="modal-audio-bitrate"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="96k">96 kbps</option>
                                <option value="128k" selected>128 kbps</option>
                                <option value="192k">192 kbps</option>
                                <option value="256k">256 kbps</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="modal-preset" class="block text-sm font-medium text-slate-300 mb-2">Encoding Speed</label>
                            <select name="preset" id="modal-preset"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="ultrafast">Ultra Fast (Larger Files)</option>
                                <option value="fast">Fast</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="slow">Slow (Better Compression)</option>
                            </select>
                        </div>

                        <div>
                            <label for="modal-profile" class="block text-sm font-medium text-slate-300 mb-2">H.264 Profile</label>
                            <select name="profile" id="modal-profile"
                                    class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="baseline">Baseline (Max Compatibility)</option>
                                <option value="main">Main (Good Quality/Compatibility)</option>
                                <option value="high" selected>High (Best Quality)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-3">
                        <button type="button" onclick="closeAdvancedTranscodingModal()" 
                                class="flex-1 bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 text-sm">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="flex-1 bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-sm">
                            <span id="advanced-loading-spinner" class="htmx-indicator animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                            Start Transcoding
                        </button>
                    </div>
                </form>

                <div id="advanced-transcoding-status" class="mt-4 p-3 bg-slate-700/50 rounded-md min-h-[40px] text-sm text-slate-300"></div>
            </div>
        </div>
    </div>

    <script>
        function openAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.remove('hidden');
        }

        function closeAdvancedTranscodingModal() {
            document.getElementById('advancedTranscodingModal').classList.add('hidden');
        }

        function toggleModalQualityOptions() {
            const qualityMode = document.getElementById('modal-quality-mode').value;
            const crfContainer = document.getElementById('modal-crf-container');
            const bitrateContainer = document.getElementById('modal-bitrate-container');
            
            if (qualityMode === 'crf') {
                crfContainer.style.display = 'block';
                bitrateContainer.style.display = 'none';
            } else {
                crfContainer.style.display = 'none';
                bitrateContainer.style.display = 'block';
            }
        }

        // Close modal when pressing Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeAdvancedTranscodingModal();
            }
        });

        // Handle new transcode event triggered by HX-Trigger from server
        document.body.addEventListener('newTranscodeAvailable', function(event) {
            const newPath = event.detail.newPath;
            const fileName = event.detail.fileName;
            const player = document.getElementById('main-video-player');
            const videoStatusSpan = document.querySelector('#video-status-indicator span'); // More robust selector

            if (player && newPath) {
                player.src = newPath;
                player.load(); // Load the new source
                // player.play(); // Optionally auto-play
                
                if (videoStatusSpan) {
                    videoStatusSpan.textContent = `Playing Advanced Transcode: ${fileName}`;
                    videoStatusSpan.className = 'text-xs font-medium bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded-full';
                }
                
                // Update the download link if it needs to reflect the newest transcode (optional)
                // const downloadLink = document.getElementById('download-original-link');
                // if(downloadLink) { /* update if needed */ }

                // Close the modal as the primary action is complete
                closeAdvancedTranscodingModal(); 
                
                // Optionally, disable the basic transcode button if this advanced one supersedes it
                const basicTranscodeButton = document.querySelector('button[hx-post*="transcode_specific_video_endpoint"]');
                if (basicTranscodeButton) {
                    // basicTranscodeButton.disabled = true;
                    // basicTranscodeButton.innerText = 'Advanced Version Created';
                }
            } else {
                console.error("Could not update player. Player or newPath missing.", event.detail);
            }
        });
    </script>
</body>
</html> 