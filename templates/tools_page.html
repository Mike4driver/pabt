<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Processing Tools - Media Browser</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a73e8',
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen font-sans">
    <header class="bg-slate-800 sticky top-0 z-50 border-b border-slate-700 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Main Navigation Bar -->
            <div class="flex justify-between items-center h-16">
                <!-- Brand/Logo -->
                <div class="flex-shrink-0">
                    <a href="/" class="text-xl font-bold text-white hover:text-primary transition-colors duration-200 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2 text-primary">
                            <path d="M4.5 6.375a4.125 4.125 0 1 1 8.25 0 4.125 4.125 0 0 1-8.25 0ZM14.25 8.625a3.375 3.375 0 1 1 6.75 0 3.375 3.375 0 0 1-6.75 0ZM1.5 19.125a7.125 7.125 0 0 1 14.25 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM17.25 19.128l-.001.144a2.25 2.25 0 0 1-.233.96 10.088 10.088 0 0 0 5.06-1.01.75.75 0 0 0 .42-.643 4.875 4.875 0 0 0-6.957-4.611 8.586 8.586 0 0 1 1.71 5.157l.001.003Z"/>
                        </svg>
                        Media Browser
                    </a>
                </div>

                <!-- Center - Page Title -->
                <div class="flex-1 max-w-2xl mx-6 text-center">
                    <div class="text-sm text-slate-400 font-medium">Page</div>
                    <div class="text-slate-200 text-lg font-semibold">Media Processing Tools</div>
                </div>

                <!-- Right Navigation -->
                <div class="flex items-center space-x-2">
                    <!-- Current Page Indicator (Tools) -->
                    <div class="px-3 py-2 text-sm font-medium text-primary bg-primary/10 rounded-lg border border-primary/30">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2 inline">
                            <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 0 1 8.82 1h2.36a1 1 0 0 1 .98.804l.331 1.652a6.993 6.993 0 0 1 1.929 1.115l1.598-.54a1 1 0 0 1 1.186.447l1.18 2.044a1 1 0 0 1-.205 1.251l-1.267 1.113a7.047 7.047 0 0 1 0 2.228l1.267 1.113a1 1 0 0 1 .206 1.25l-1.18 2.045a1 1 0 0 1-1.187.447l-1.598-.54a6.993 6.993 0 0 1-1.929 1.115l-.33 1.652a1 1 0 0 1-.98.804H8.82a1 1 0 0 1-.98-.804l-.331-1.652a6.993 6.993 0 0 1-1.929-1.115l-1.598.54a1 1 0 0 1-1.186-.447l-1.18-2.044a1 1 0 0 1 .205-1.251l1.267-1.114a7.05 7.05 0 0 1 0-2.227L1.821 7.773a1 1 0 0 1-.206-1.25l1.18-2.045a1 1 0 0 1 1.187-.447l1.598.54A6.992 6.992 0 0 1 7.51 3.456l.33-1.652ZM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" clip-rule="evenodd" />
                        </svg>
                        Tools
                    </div>

                    <!-- Background Jobs Link -->
                    <a href="{{ url_for('background_jobs_page') }}" 
                       class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200 border border-transparent hover:border-slate-600">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.236 4.53L8.107 10.5a.75.75 0 0 0-1.214 1.007l1.643 2.25a.75.75 0 0 0 1.214-.007l3.857-5.557Z" clip-rule="evenodd" />
                        </svg>
                        Job Monitor
                    </a>
                    
                    <!-- Settings -->
                    <a href="{{ url_for('settings_page') }}" 
                       class="inline-flex items-center p-2 text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-all duration-200 border border-transparent hover:border-slate-600"
                       title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M7.84 1.804A1 1 0 0 1 8.82 1h2.36a1 1 0 0 1 .98.804l.331 1.652a6.993 6.993 0 0 1 1.929 1.115l1.598-.54a1 1 0 0 1 1.186.447l1.18 2.044a1 1 0 0 1-.205 1.251l-1.267 1.113a7.047 7.047 0 0 1 0 2.228l1.267 1.113a1 1 0 0 1 .206 1.25l-1.18 2.045a1 1 0 0 1-1.187.447l-1.598-.54a6.993 6.993 0 0 1-1.929 1.115l-.33 1.652a1 1 0 0 1-.98.804H8.82a1 1 0 0 1-.98-.804l-.331-1.652a6.993 6.993 0 0 1-1.929-1.115l-1.598.54a1 1 0 0 1-1.186-.447l-1.18-2.044a1 1 0 0 1 .205-1.251l1.267-1.114a7.05 7.05 0 0 1 0-2.227L1.821 7.773a1 1 0 0 1-.206-1.25l1.18-2.045a1 1 0 0 1 1.187-.447l1.598.54A6.992 6.992 0 0 1 7.51 3.456l.33-1.652ZM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" clip-rule="evenodd" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
        <div x-data="{ activeTab: 'thumbnails' }">
            <!-- Tabs -->
            <div class="mb-6 border-b border-slate-700">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button @click="activeTab = 'thumbnails'" 
                            :class="{ 'border-primary text-primary': activeTab === 'thumbnails', 'border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500': activeTab !== 'thumbnails' }"
                            class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors duration-150 focus:outline-none">
                        Thumbnails
                    </button>
                    <button @click="activeTab = 'transcoding'" 
                            :class="{ 'border-primary text-primary': activeTab === 'transcoding', 'border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500': activeTab !== 'transcoding' }"
                            class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors duration-150 focus:outline-none">
                        Transcoding
                    </button>
                    <button @click="activeTab = 'previews'" 
                            :class="{ 'border-primary text-primary': activeTab === 'previews', 'border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500': activeTab !== 'previews' }"
                            class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors duration-150 focus:outline-none">
                        Hover Previews
                    </button>
                    <button @click="activeTab = 'database'" 
                            :class="{ 'border-primary text-primary': activeTab === 'database', 'border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-500': activeTab !== 'database' }"
                            class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition-colors duration-150 focus:outline-none">
                        Database & Sync
                    </button>
                </nav>
            </div>

            <!-- Thumbnails Section -->
            <div x-show="activeTab === 'thumbnails'" class="space-y-6">
                <div class="bg-slate-800 p-6 rounded-lg shadow-md border border-slate-700">
                    <h2 class="text-lg font-semibold text-slate-100 mb-4">Generate All Video Thumbnails</h2>
                    <p class="text-sm text-slate-400 mb-4">
                        This will generate thumbnails for all videos in your library that don't currently have one.
                        This process runs in the background.
                    </p>
                    <button hx-post="/generate-all-video-thumbnails" 
                            hx-target="#thumbnail-job-status"
                            hx-swap="innerHTML"
                            hx-on:htmx:after-request="handleJobStart(event)"
                            class="px-4 py-2 bg-primary text-white text-sm rounded-md hover:bg-primary/80 transition-colors duration-150 shadow-sm">
                        Generate All Thumbnails
                    </button>
                    <div id="thumbnail-job-status" class="mt-4"></div>
                </div>
            </div>

            <!-- Transcoding Section -->
            <div x-show="activeTab === 'transcoding'" class="space-y-6">
                <div class="bg-slate-800 p-6 rounded-lg shadow-md border border-slate-700">
                    <h2 class="text-lg font-semibold text-slate-100 mb-4">Transcode All Videos</h2>
                    <p class="text-sm text-slate-400 mb-4">
                        Transcode all videos to a web-optimized MP4 format. This is useful for broader compatibility and faster streaming.
                        This process runs in the background and can take a significant amount of time.
                    </p>
                    <button hx-post="/transcode-all-videos" 
                            hx-target="#transcode-job-status"
                            hx-swap="innerHTML"
                            hx-on:htmx:after-request="handleJobStart(event)"
                            class="px-4 py-2 bg-primary text-white text-sm rounded-md hover:bg-primary/80 transition-colors duration-150 shadow-sm">
                        Transcode All Videos (Default Settings)
                    </button>
                    <div id="transcode-job-status" class="mt-4"></div>
                </div>
                <!-- Advanced Transcoding Options could be added here later -->
            </div>

            <!-- Hover Previews Section -->
            <div x-show="activeTab === 'previews'" class="space-y-6">
                <div class="bg-slate-800 p-6 rounded-lg shadow-md border border-slate-700">
                    <h2 class="text-lg font-semibold text-slate-100 mb-4">Generate All Hover Previews</h2>
                    <p class="text-sm text-slate-400 mb-4">
                        Create short, muted video previews that play on mouse hover in the media browser.
                        This process runs in the background.
                    </p>
                    <button hx-post="/generate-all-previews" 
                            hx-target="#preview-job-status"
                            hx-swap="innerHTML"
                            hx-on:htmx:after-request="handleJobStart(event)"
                            class="px-4 py-2 bg-primary text-white text-sm rounded-md hover:bg-primary/80 transition-colors duration-150 shadow-sm">
                        Generate All Hover Previews
                    </button>
                    <div id="preview-job-status" class="mt-4"></div>
                </div>
            </div>

            <!-- Database & Sync Section -->
            <div x-show="activeTab === 'database'" class="space-y-6">
                <div class="bg-slate-800 p-6 rounded-lg shadow-md border border-slate-700">
                    <h2 class="text-lg font-semibold text-slate-100 mb-4">Scan Media Directory</h2>
                    <p class="text-sm text-slate-400 mb-4">
                        Scan the configured media directory for new files, update metadata for existing ones,
                        and remove entries for files that no longer exist. This helps keep your library in sync.
                        This process runs in the background.
                    </p>
                    <button hx-post="/tools/scan-media-directory" 
                            hx-target="#scan-media-job-status"
                            hx-swap="innerHTML"
                            hx-on:htmx:after-request="handleJobStart(event)"
                            class="px-4 py-2 bg-primary text-white text-sm rounded-md hover:bg-primary/80 transition-colors duration-150 shadow-sm">
                        Scan Media Directory & Update Database
                    </button>
                    <div id="scan-media-job-status" class="mt-4"></div>
                </div>
                <!-- Other database tools like clear_db could be added here -->
            </div>
        </div>

        <!-- Background Jobs Status Section -->
        <div id="background-jobs-section" class="bg-slate-800 p-6 rounded-xl shadow-xl border border-slate-700 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-slate-100 flex items-center">
                    <div class="p-2 bg-blue-500/20 rounded-full mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-blue-400">
                            <path fill-rule="evenodd" d="M4.755 10.059a7.5 7.5 0 0112.548-3.364l1.903 1.903h-3.183a.75.75 0 100 1.5h4.992a.75.75 0 00.75-.75V4.356a.75.75 0 00-1.5 0v3.18l-1.9-1.9A9 9 0 003.306 9.67a.75.75 0 101.45.388zm15.408 3.352a.75.75 0 00-.919.53 7.5 7.5 0 01-12.548 3.364l-1.902-1.903h3.183a.75.75 0 000-1.5H2.984a.75.75 0 00-.75.75v4.992a.75.75 0 001.5 0v-3.18l1.9 1.9a9 9 0 0015.059-4.035.75.75 0 00-.53-.918z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    Background Jobs
                </h2>
                <button onclick="refreshJobs()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded-md transition-colors duration-150">
                    Refresh
                </button>
            </div>
            <div id="jobs-container" class="space-y-3">
                <!-- Jobs will be inserted here -->
            </div>
        </div>

        <!-- Thumbnail Generation Section -->
        <div class="bg-slate-800 p-6 sm:p-8 rounded-xl shadow-xl border border-slate-700">
            <div class="flex items-center mb-6">
                <div class="p-3 bg-primary/20 rounded-full mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-primary">
                        <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
                    </svg>
                </div>
                <h2 class="text-2xl font-semibold text-slate-100">Video Thumbnails</h2>
            </div>
            <p class="text-slate-400 mb-6 text-sm leading-relaxed">
                Generate missing thumbnails for all video files. Existing thumbnails will be skipped.
            </p>
            <button 
                hx-post="/generate-all-video-thumbnails"
                hx-target="#thumbnail-status-message"
                hx-swap="innerHTML"
                hx-indicator="#loading-spinner-thumbnails"
                hx-on:htmx:after-request="handleJobStart(event)"
                class="w-full bg-primary/80 text-white font-semibold py-3 px-6 rounded-lg hover:bg-primary focus:outline-none focus:ring-2 focus:ring-primary/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-base">
                <span id="loading-spinner-thumbnails" class="htmx-indicator animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mr-3"></span>
                Generate Missing Thumbnails
            </button>
            <div class="mt-6 p-4 bg-slate-700/50 rounded-md min-h-[50px]">
                <p id="thumbnail-status-message" class="text-sm text-slate-300"></p>
            </div>
        </div>

        <!-- Video Transcoding Section -->
        <div class="bg-slate-800 p-6 sm:p-8 rounded-xl shadow-xl border border-slate-700">
            <div class="flex items-center mb-6">
                <div class="p-3 bg-sky-500/20 rounded-full mr-4">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-sky-400">
                        <path d="M4.5 4.5a3 3 0 00-3 3v9a3 3 0 003 3h15a3 3 0 003-3v-9a3 3 0 00-3-3h-15zm11.25 9.75l-3.75-2.25v4.5l3.75-2.25z" />
                        <path fill-rule="evenodd" d="M1.5 7.5a3 3 0 013-3h15a3 3 0 013 3v9a3 3 0 01-3 3h-15a3 3 0 01-3-3v-9zm3 .75a1.5 1.5 0 011.5-1.5h10.5a1.5 1.5 0 011.5 1.5v2.443c.572.235 1.072.559 1.5.942V7.5a3 3 0 00-3-3h-10.5a3 3 0 00-3 3v9a3 3 0 003 3h10.5a3 3 0 003-3v-.693c-.428.383-.928.707-1.5.942V16.5a1.5 1.5 0 01-1.5 1.5h-10.5a1.5 1.5 0 01-1.5-1.5v-8.25z" clip-rule="evenodd" />
                    </svg>
                </div>
                <h2 class="text-2xl font-semibold text-slate-100">Video Transcoding</h2>
            </div>
            <p class="text-slate-400 mb-6 text-sm leading-relaxed">
                Transcode all videos to web-friendly H.264 MP4 format with customizable quality settings. This is CPU intensive and can take significant time. Existing transcoded files will be skipped.
            </p>
            
            <!-- Transcoding Options Form -->
            <form hx-post="/transcode-all-videos-with-options" hx-target="#transcoding-status-message" hx-swap="innerHTML" hx-indicator="#loading-spinner-transcoding" hx-on:htmx:after-request="handleJobStart(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="resolution" class="block text-sm font-medium text-slate-300 mb-2">Resolution</label>
                        <select name="resolution" id="resolution" 
                                class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="original">Original Resolution</option>
                            <option value="1080p">1080p (Full HD)</option>
                            <option value="720p" selected>720p (HD)</option>
                            <option value="480p">480p (SD)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="quality_mode" class="block text-sm font-medium text-slate-300 mb-2">Quality Mode</label>
                        <select name="quality_mode" id="quality_mode" onchange="toggleQualityOptions()"
                                class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="crf" selected>CRF (Constant Quality)</option>
                            <option value="bitrate">Bitrate (Constant Rate)</option>
                        </select>
                    </div>
                    
                    <div id="crf-container">
                        <label for="crf" class="block text-sm font-medium text-slate-300 mb-2">CRF Quality (Lower = Better)</label>
                        <select name="crf" id="crf"
                                class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="18">18 (Very High Quality)</option>
                            <option value="23" selected>23 (High Quality)</option>
                            <option value="28">28 (Medium Quality)</option>
                            <option value="32">32 (Lower Quality)</option>
                        </select>
                    </div>
                    
                    <div id="bitrate-container" style="display: none;">
                        <label for="video_bitrate" class="block text-sm font-medium text-slate-300 mb-2">Video Bitrate</label>
                        <select name="video_bitrate" id="video_bitrate"
                                class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="1M">1 Mbps</option>
                            <option value="2M" selected>2 Mbps</option>
                            <option value="4M">4 Mbps</option>
                            <option value="8M">8 Mbps</option>
                            <option value="12M">12 Mbps</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="audio_bitrate" class="block text-sm font-medium text-slate-300 mb-2">Audio Bitrate</label>
                        <select name="audio_bitrate" id="audio_bitrate"
                                class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="96k">96 kbps</option>
                            <option value="128k" selected>128 kbps</option>
                            <option value="192k">192 kbps</option>
                            <option value="256k">256 kbps</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="preset" class="block text-sm font-medium text-slate-300 mb-2">Encoding Speed</label>
                        <select name="preset" id="preset"
                                class="w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-slate-200 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="ultrafast">Ultra Fast (Larger Files)</option>
                            <option value="fast">Fast</option>
                            <option value="medium" selected>Medium (Balanced)</option>
                            <option value="slow">Slow (Better Compression)</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" 
                        class="w-full bg-sky-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-base">
                    <span id="loading-spinner-transcoding" class="htmx-indicator animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mr-3"></span>
                    Transcode All Videos
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-slate-700/50 rounded-md min-h-[50px]">
                <p id="transcoding-status-message" class="text-sm text-slate-300"></p>
            </div>
        </div>

        <!-- Hover Previews Generation Section -->
        <div class="bg-slate-800 p-6 sm:p-8 rounded-xl shadow-xl border border-slate-700">
            <div class="flex items-center mb-6">
                <div class="p-3 bg-purple-500/20 rounded-full mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-purple-400">
                        <path fill-rule="evenodd" d="M3.75 4.5a.75.75 0 01.75-.75h15a.75.75 0 01.75.75v15a.75.75 0 01-.75.75h-15a.75.75 0 01-.75-.75V4.5zm0-1.5a2.25 2.25 0 00-2.25 2.25v15a2.25 2.25 0 002.25 2.25h15a2.25 2.25 0 002.25-2.25V4.5a2.25 2.25 0 00-2.25-2.25h-15z" clip-rule="evenodd" />
                        <path d="M9 9.75a.75.75 0 00-1.5 0v4.5a.75.75 0 001.5 0v-4.5zm3.75-.75a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5a.75.75 0 01.75-.75zm2.25 0a.75.75 0 00-1.5 0v4.5a.75.75 0 001.5 0v-4.5z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-semibold text-slate-100">Video Hover Previews</h2>
            </div>
            <p class="text-slate-400 mb-6 text-sm leading-relaxed">
                Generate short, muted, looping video previews (approx. 5 seconds) that can play on hover in the media browser. This is also CPU intensive. Existing previews will be skipped.
            </p>
            <button 
                hx-post="/generate-all-previews"
                hx-target="#preview-status-message"
                hx-swap="innerHTML"
                hx-indicator="#loading-spinner-previews"
                hx-on:htmx:after-request="handleJobStart(event)"
                class="w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/60 focus:ring-offset-2 focus:ring-offset-slate-800 transition-all duration-200 flex items-center justify-center text-base">
                <span id="loading-spinner-previews" class="htmx-indicator animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full mr-3"></span>
                Generate All Hover Previews
            </button>
            <div class="mt-6 p-4 bg-slate-700/50 rounded-md min-h-[50px]">
                <p id="preview-status-message" class="text-sm text-slate-300"></p>
            </div>
        </div>
        
        <!-- Note about FFmpeg -->
        <div class="text-center text-xs text-slate-500 mt-8">
            <p><strong>Note:</strong> Thumbnail generation, transcoding, and preview generation require FFmpeg to be installed and accessible in your system's PATH.</p>
        </div>
    </main>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-0 right-0 p-6 space-y-3 z-[100]">
        <!-- Toasts will be appended here -->
    </div>

    <script>
        function toggleQualityOptions() {
            const qualityMode = document.getElementById('quality_mode').value;
            const crfContainer = document.getElementById('crf-container');
            const bitrateContainer = document.getElementById('bitrate-container');
            
            if (qualityMode === 'crf') {
                crfContainer.style.display = 'block';
                bitrateContainer.style.display = 'none';
            } else {
                crfContainer.style.display = 'none';
                bitrateContainer.style.display = 'block';
            }
        }

        function goBack() {
            history.back();
        }

        // Background job monitoring
        let activeJobs = new Set();
        let jobPollingInterval = null;
        let previousToolPageJobStates = new Map(); // To track job state changes for notifications on this page

        function handleJobStart(event) {
            try {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.job_id) {
                    activeJobs.add(response.job_id);
                    showJobsSection();
                    startJobPolling();
                    
                    // Update the status message with job info
                    const target = event.detail.target;
                    if (target) {
                        target.innerHTML = `<div class="text-blue-400">Started in background: ${response.message}</div>`;
                    }
                }
            } catch (e) {
                console.error('Error parsing job start response:', e);
            }
        }

        function showJobsSection() {
            document.getElementById('background-jobs-section').classList.remove('hidden');
        }

        function hideJobsSection() {
            document.getElementById('background-jobs-section').classList.add('hidden');
        }

        function startJobPolling() {
            if (jobPollingInterval) return; // Already polling
            
            jobPollingInterval = setInterval(() => {
                if (activeJobs.size === 0) {
                    stopJobPolling();
                    return;
                }
                refreshJobs();
            }, 2000); // Poll every 2 seconds
        }

        function stopJobPolling() {
            if (jobPollingInterval) {
                clearInterval(jobPollingInterval);
                jobPollingInterval = null;
            }
        }

        function refreshJobs() {
            fetch('/jobs')
                .then(response => response.json())
                .then(data => {
                    updateJobsDisplay(data.jobs);
                    checkForToolPageCompletedJobsAndNotify(data.jobs);
                })
                .catch(error => {
                    console.error('Error fetching jobs:', error);
                });
        }

        function updateJobsDisplay(jobs) {
            const container = document.getElementById('jobs-container');
            
            if (jobs.length === 0) {
                hideJobsSection();
                activeJobs.clear();
                stopJobPolling();
                return;
            }

            // Update active jobs set
            activeJobs.clear();
            jobs.forEach(job => {
                if (job.status === 'running') {
                    activeJobs.add(job.job_id);
                }
            });

            container.innerHTML = jobs.map(job => createJobElement(job)).join('');
            
            // Stop polling if no running jobs
            if (activeJobs.size === 0) {
                setTimeout(() => {
                    if (activeJobs.size === 0) {
                        stopJobPolling();
                    }
                }, 5000); // Keep showing results for 5 seconds, then stop polling if still no active jobs
            }
        }

        function createJobElement(job) {
            const progressPercent = job.total > 0 ? Math.round((job.progress / job.total) * 100) : 0;
            const statusColor = {
                'running': 'text-blue-400',
                'completed': 'text-green-400',
                'failed': 'text-red-400'
            }[job.status] || 'text-slate-400';

            const statusIcon = {
                'running': 'üîÑ',
                'completed': '‚úÖ',
                'failed': '‚ùå'
            }[job.status] || '‚è≥';

            return `
                <div class="bg-slate-700/50 rounded-lg p-4 border border-slate-600">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${statusIcon}</span>
                            <span class="font-medium text-slate-200">${job.description}</span>
                            <span class="text-xs ${statusColor} capitalize">${job.status}</span>
                        </div>
                        ${job.status !== 'running' ? `
                            <button onclick="removeJob('${job.job_id}')" class="text-xs text-slate-400 hover:text-slate-300 px-2 py-1 rounded">
                                ‚úï
                            </button>
                        ` : ''}
                    </div>
                    
                    ${job.status === 'running' ? `
                        <div class="mb-2">
                            <div class="flex justify-between text-xs text-slate-400 mb-1">
                                <span>${job.current_item || 'Processing...'}</span>
                                <span>${job.progress}/${job.total} (${progressPercent}%)</span>
                            </div>
                            <div class="w-full bg-slate-600 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${job.status === 'completed' && job.result ? `
                        <div class="text-xs text-green-400 mt-2">
                            ${job.result.message || 'Completed successfully'}
                        </div>
                    ` : ''}
                    
                    ${job.status === 'failed' && job.error ? `
                        <div class="text-xs text-red-400 mt-2">
                            Error: ${job.error}
                        </div>
                    ` : ''}
                    
                    <div class="text-xs text-slate-500 mt-2">
                        Started: ${new Date(job.start_time).toLocaleTimeString()}
                        ${job.end_time ? `‚Ä¢ Finished: ${new Date(job.end_time).toLocaleTimeString()}` : ''}
                    </div>
                </div>
            `;
        }

        function removeJob(jobId) {
            fetch(`/jobs/${jobId}`, { method: 'DELETE' })
                .then(() => {
                    refreshJobs();
                })
                .catch(error => {
                    console.error('Error removing job:', error);
                });
        }

        function checkForToolPageCompletedJobsAndNotify(newJobs) {
            const jobsOnThisPage = newJobs.filter(job => activeJobs.has(job.job_id) || previousToolPageJobStates.has(job.job_id));

            jobsOnThisPage.forEach(job => {
                const previousState = previousToolPageJobStates.get(job.job_id);
                if (previousState === 'running' && (job.status === 'completed' || job.status === 'failed')) {
                    showToastOnToolsPage(job.result?.message || job.error || `Job ${job.status}`, job.description, job.status);
                }
                previousToolPageJobStates.set(job.job_id, job.status);
            });

            // Clean up old job states if job no longer exists or is no longer managed by this page
            const currentJobIds = new Set(jobsOnThisPage.map(j => j.job_id));
            for (const jobId of previousToolPageJobStates.keys()) {
                if (!currentJobIds.has(jobId)) {
                    previousToolPageJobStates.delete(jobId);
                }
            }
        }

        function showToastOnToolsPage(message, description, status = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toastId = `toast-tools-${Date.now()}`;
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `max-w-sm w-full bg-slate-800 shadow-2xl rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden border ${status === 'completed' ? 'border-green-500' : status === 'failed' ? 'border-red-500' : 'border-blue-500'}`;

            const iconColor = status === 'completed' ? 'text-green-400' : status === 'failed' ? 'text-red-400' : 'text-blue-400';
            let iconSvg = '';
            if (status === 'completed') {
                iconSvg = `
                    <svg class="h-6 w-6 ${iconColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>`;
            } else if (status === 'failed') {
                iconSvg = `
                    <svg class="h-6 w-6 ${iconColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m0-10.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.75c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.57-.598-3.75h-.152c-3.196 0-6.1-1.249-8.25-3.286zm0 13.036h.008v.008H12v-.008z" />
                    </svg>`;
            } else { // Default info/running icon
                 iconSvg = `
                    <svg class="h-6 w-6 ${iconColor}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>`;
            }

            toast.innerHTML = `
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            ${iconSvg}
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-semibold text-slate-100">${description}</p>
                            <p class="mt-1 text-xs text-slate-300">${message}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button type="button" onclick="document.getElementById('${toastId}').remove()" class="inline-flex bg-slate-800 rounded-md p-1 text-slate-400 hover:text-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-600">
                                <span class="sr-only">Close</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(toast);

            setTimeout(() => {
                const currentToast = document.getElementById(toastId);
                if (currentToast) {
                    currentToast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                    setTimeout(() => currentToast.remove(), 500);
                }
            }, 7000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing jobs on page load
            refreshJobs();
        });
    </script>
</body>
</html> 