{% if media_files %}
{% for file in media_files %}
<div 
    class="media-card group relative bg-slate-800 border border-slate-700 rounded-lg shadow-lg overflow-hidden transition-all duration-200 ease-in-out hover:shadow-2xl hover:border-primary/70 focus-within:ring-2 focus-within:ring-primary focus-within:ring-offset-2 focus-within:ring-offset-slate-900"
    data-preview-url="{{ file.preview_url if file.type == 'video' and file.has_preview else '' }}"
    data-thumbnail-url="{{ file.thumbnail }}"
    id="media-card-{{ file.id_db }}_{{ loop.index }}"
>
    {% set video_url_params = [] %}
    {% if search_query %}{% set _ = video_url_params.append('search=' + search_query|urlencode) %}{% endif %}
    {% if current_media_type %}{% set _ = video_url_params.append('media_type=' + current_media_type|urlencode) %}{% endif %}
    {% if current_tags %}{% set _ = video_url_params.append('tags=' + current_tags|urlencode) %}{% endif %}
    {% if current_sort_by and current_sort_by != 'date_added' %}{% set _ = video_url_params.append('sort_by=' + current_sort_by|urlencode) %}{% endif %}
    {% if current_sort_order and current_sort_order != 'desc' %}{% set _ = video_url_params.append('sort_order=' + current_sort_order|urlencode) %}{% endif %}
    {% if file.get('best_frame_timestamp') %}{% set _ = video_url_params.append('t=' + file.best_frame_timestamp|string) %}{% endif %}
    {% set video_url_query = '?' + video_url_params|join('&') if video_url_params else '' %}
    
    <a href="{{ (url_for('video_player_page', video_name=file.name) | string) + video_url_query if file.type == 'video' else file.path }}" 
       class="block aspect-[16/9] bg-black media-thumbnail-container relative"
       aria-label="View {{ file.display_title }}"
    >
        <img src="{{ file.thumbnail }}" 
             alt="Thumbnail for {{ file.display_title }}" 
             class="media-thumbnail-img w-full h-full object-contain transition-opacity duration-300 ease-in-out group-hover:opacity-75 {{ 'p-4' if 'generic' in file.thumbnail else '' }}"
             loading="lazy">
        
        {# Placeholder for the preview video, will be populated by JS #}
        <div class="preview-video-container absolute inset-0 w-full h-full"></div>

        {% if file.duration %}
        <span class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-1.5 py-0.5 rounded-sm">{{ file.duration }}</span>
        {% endif %}
        
        {% if file.type == 'video' and file.has_transcoded_version %}
        <span class="absolute top-2 left-2 bg-green-500/80 text-white text-xs px-1.5 py-0.5 rounded-sm font-medium">Transcoded</span>
        {% endif %}
        
        {% if file.type == 'video' and file.has_ml_analysis %}
        <span class="absolute top-2 {% if file.has_transcoded_version %}left-20{% else %}left-2{% endif %} bg-blue-500/80 text-white text-xs px-1.5 py-0.5 rounded-sm font-medium flex items-center" title="ML Analysis: {{ file.ml_analysis_info.frame_count }} frames processed with {{ file.ml_analysis_info.model_name }}">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3 h-3 mr-1">
                <path d="M8 2L2 7l6 5 6-5-6-5zM2 12l6 5 6-5M2 9l6 5 6-5"/>
            </svg>
            ML
        </span>
        {% endif %}
        
        {% if file.get('search_type') == 'semantic' %}
        <span class="absolute top-2 right-2 bg-purple-500/80 text-white text-xs px-1.5 py-0.5 rounded-sm font-medium flex items-center" title="Semantic match: {{ '%.1f'|format(file.semantic_search_score * 100) }}% similarity">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3 h-3 mr-1">
                <path d="M8 2a6 6 0 100 12A6 6 0 008 2zM7 5a1 1 0 112 0v2a1 1 0 11-2 0V5zM8 10a1 1 0 100-2 1 1 0 000 2z"/>
            </svg>
            {{ '%.0f'|format(file.semantic_search_score * 100) }}%
        </span>
        {% endif %}
        
        {% if file.type == 'audio' %}
            <div class="absolute inset-0 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 text-slate-500 opacity-50">
                    <path fill-rule="evenodd" d="M19.952 1.651a.75.75 0 01.298.599V16.5a3 3 0 01-5.223 2.502l-10.706-8.25a.75.75 0 010-1.004L14.729 1.5H4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0v-10h9.479l-3.082 2.392a.75.75 0 00-.012 1.011L15 12.182v-3.475a2.25 2.25 0 011.084-1.993l3.75-2.25a.75.75 0 01.118-.063zM5.25 12a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75H6a.75.75 0 01-.75-.75v-1.5z" clip-rule="evenodd" />
                    <path d="M15.75 15a.75.75 0 01.75-.75H18a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-1.5a.75.75 0 01-.75-.75v-1.5z" />
                </svg>
            </div>
        {% endif %}
    </a>
    <div class="p-2 sm:p-3 lg:p-4">
        <h3 class="text-xs sm:text-sm lg:text-base font-semibold text-slate-200 group-hover:text-primary transition-colors duration-150 truncate" title="{{ file.display_title }}">
            <a href="{{ (url_for('video_player_page', video_name=file.name) | string) + video_url_query if file.type == 'video' else file.path }}" class="focus:outline-none">
                {{ file.display_title }}
            </a>
        </h3>
        <p class="text-xs text-slate-400 capitalize">{{ file.type }}</p>
        {% if file.type == 'video' and file.tags %}
            <div class="mt-1.5 flex flex-wrap gap-1">
                {% for tag in file.tags[:3] %}
                    <span class="tag-bubble text-xs bg-slate-700 text-slate-300 px-1.5 py-0.5 rounded-full">{{ tag }}</span>
                {% endfor %}
                {% if file.tags|length > 3 %}
                    <span class="tag-bubble text-xs bg-slate-600 text-slate-400 px-1.5 py-0.5 rounded-full">+{{ file.tags|length - 3 }} more</span>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endfor %}

{# Build pagination URL parameters #}
{% set pagination_params = [] %}
{% if search_query %}{% set _ = pagination_params.append('search=' + search_query|urlencode) %}{% endif %}
{% if current_media_type %}{% set _ = pagination_params.append('media_type=' + current_media_type|urlencode) %}{% endif %}
{% if current_tags %}{% set _ = pagination_params.append('tags=' + current_tags|urlencode) %}{% endif %}
{% if current_sort_by and current_sort_by != 'date_added' %}{% set _ = pagination_params.append('sort_by=' + current_sort_by|urlencode) %}{% endif %}
{% if current_sort_order and current_sort_order != 'desc' %}{% set _ = pagination_params.append('sort_order=' + current_sort_order|urlencode) %}{% endif %}
{% set _ = pagination_params.append('per_page=' + pagination.per_page|string) %}
{% set pagination_query = '&' + pagination_params|join('&') if pagination_params else '' %}

{# Pagination Controls #}
{% if pagination.total_pages > 1 %}
<div class="col-span-full mt-8 mb-4" data-total-count="{{ pagination.total_count }}">
    <div class="flex items-center justify-between">
        <div class="text-sm text-slate-400">
            Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} to {% if pagination.page * pagination.per_page > pagination.total_count %}{{ pagination.total_count }}{% else %}{{ pagination.page * pagination.per_page }}{% endif %} of {{ pagination.total_count }} results
        </div>
        <nav class="flex items-center space-x-1" aria-label="Pagination">
            <!-- Previous Page Button -->
            {% if pagination.has_prev %}
                <button 
                    hx-get="/files?page={{ pagination.prev_page }}{{ pagination_query }}"
                    hx-target="#media-grid"
                    hx-swap="innerHTML"
                    class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150"
                    aria-label="Previous page"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                        <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                    </svg>
                    Previous
                </button>
            {% else %}
                <span class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-500 bg-slate-800 border border-slate-700 rounded-md cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                        <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                    </svg>
                    Previous
                </span>
            {% endif %}

            <!-- Page Numbers -->
            <div class="flex items-center space-x-1">
                {% set start_page = 1 if pagination.page - 2 < 1 else pagination.page - 2 %}
                {% set end_page = pagination.total_pages if pagination.page + 2 > pagination.total_pages else pagination.page + 2 %}
                
                {% if start_page > 1 %}
                    <button 
                        hx-get="/files?page=1{{ pagination_query }}"
                        hx-target="#media-grid"
                        hx-swap="innerHTML"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150"
                    >
                        1
                    </button>
                    {% if start_page > 2 %}
                        <span class="text-slate-500 px-2">...</span>
                    {% endif %}
                {% endif %}

                {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == pagination.page %}
                        <span class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-primary border border-primary rounded-md">
                            {{ page_num }}
                        </span>
                    {% else %}
                        <button 
                            hx-get="/files?page={{ page_num }}{{ pagination_query }}"
                            hx-target="#media-grid"
                            hx-swap="innerHTML"
                            class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150"
                        >
                            {{ page_num }}
                        </button>
                    {% endif %}
                {% endfor %}

                {% if end_page < pagination.total_pages %}
                    {% if end_page < pagination.total_pages - 1 %}
                        <span class="text-slate-500 px-2">...</span>
                    {% endif %}
                    <button 
                        hx-get="/files?page={{ pagination.total_pages }}{{ pagination_query }}"
                        hx-target="#media-grid"
                        hx-swap="innerHTML"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150"
                    >
                        {{ pagination.total_pages }}
                    </button>
                {% endif %}
            </div>

            <!-- Next Page Button -->
            {% if pagination.has_next %}
                <button 
                    hx-get="/files?page={{ pagination.next_page }}{{ pagination_query }}"
                    hx-target="#media-grid"
                    hx-swap="innerHTML"
                    class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150"
                    aria-label="Next page"
                >
                    Next
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1">
                        <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                    </svg>
                </button>
            {% else %}
                <span class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-500 bg-slate-800 border border-slate-700 rounded-md cursor-not-allowed">
                    Next
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1">
                        <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                    </svg>
                </span>
            {% endif %}
        </nav>
    </div>
</div>
{% endif %}

{% else %}
<div class="col-span-full text-center py-12">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto text-slate-500 mb-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75 18 18M8.25 8.25 6 6" />
      </svg>
    <h3 class="text-xl font-semibold text-slate-300">No media files found.</h3>
    <p class="text-slate-400 mt-2">
        The application is looking for media in: <br>
        <code class="text-sm bg-slate-700 px-1 py-0.5 rounded">{{ MEDIA_DIR_NAME_FOR_TEMPLATE }}</code> (full path: <code class="text-sm bg-slate-700 px-1 py-0.5 rounded">{{ MEDIA_DIR_PATH_FOR_TEMPLATE }}</code>).
    </p>
    <p class="text-slate-400 mt-1">
        Ensure this directory exists and contains supported media files (videos, images, audio).
    </p>
    {% if search_query %}
        <p class="text-slate-500 mt-4">
            You searched for: <strong class="text-slate-400">"{{ search_query }}"</strong>. Try a different search or clear it.
        </p>
    {% endif %}
    <p class="text-slate-500 mt-4">If you just changed the media directory in settings, you may need to restart the application.</p>
</div>
{% endif %}

<script>
function setupVideoPreviews() {
    const mediaCards = document.querySelectorAll('.media-card');

    mediaCards.forEach(card => {
        const previewUrl = card.dataset.previewUrl;
        const thumbnailImg = card.querySelector('.media-thumbnail-img');
        const previewContainer = card.querySelector('.preview-video-container');

        if (!previewUrl || !thumbnailImg || !previewContainer) {
            return; // No preview for this card, or elements missing
        }

        // Create video player once and preload
        const videoPlayer = document.createElement('video');
        videoPlayer.src = previewUrl;
        videoPlayer.preload = 'auto'; // Changed from 'metadata' to 'auto' for faster hover playback
        videoPlayer.loop = true;
        videoPlayer.muted = true;
        videoPlayer.playsInline = true;
        videoPlayer.className = 'absolute inset-0 w-full h-full object-cover transition-opacity duration-300 ease-in-out opacity-0'; // Start hidden
        previewContainer.appendChild(videoPlayer);
        videoPlayer.load(); // Explicitly tell the browser to load

        card.addEventListener('mouseenter', () => {
            // No timeout, attempt to play immediately
            if (thumbnailImg) thumbnailImg.style.opacity = '0'; // Hide thumbnail
            videoPlayer.style.opacity = '1'; // Show video
            videoPlayer.play().catch(error => {
                if (error.name !== 'AbortError') {
                    console.error("Error playing preview:", previewUrl, error);
                    // If play fails for other reasons, hide video and show thumbnail again
                    videoPlayer.style.opacity = '0';
                    if (thumbnailImg) thumbnailImg.style.opacity = '1';
                }
            });
        });

        card.addEventListener('mouseleave', () => {
            videoPlayer.style.opacity = '0'; // Hide video
            videoPlayer.pause();
            if (thumbnailImg) thumbnailImg.style.opacity = '1'; // Restore thumbnail
        });
    });
}

// Handle search input to reset pagination to page 1
function handleSearchReset() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        // Intercept search requests to ensure we start from page 1
        searchInput.addEventListener('htmx:configRequest', function(event) {
            // Check if AI search is manually enabled
            const searchQuery = searchInput.value.trim();
            if (window.aiSearchEnabled && searchQuery) {
                // Prevent the default HTMX request
                event.preventDefault();
                // Perform semantic search instead
                performSemanticSearch(searchQuery, 1);
                return;
            }
            
            // Reset to page 1 for any search
            const url = new URL(event.detail.path, window.location.origin);
            url.searchParams.set('page', '1');
            event.detail.path = url.pathname + url.search;
        });
    }
}



// Perform semantic search
async function performSemanticSearch(query, page = 1) {
    const startTime = performance.now();
    console.group('🔍 Semantic Search Debug');
    console.log('📝 Search Parameters:', {
        query: query,
        page: page,
        threshold: window.semanticSearchThreshold || 0.7,
        timestamp: new Date().toISOString()
    });
    
    try {
        // Show loading state
        const mediaGrid = document.getElementById('media-grid');
        mediaGrid.innerHTML = `
            <div class="col-span-full flex items-center justify-center py-12">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                    <p class="text-slate-300 text-lg font-medium">Searching with AI...</p>
                    <p class="text-slate-400 text-sm mt-1">Analyzing video content for: "${query}"</p>
                </div>
            </div>
        `;
        
        // Get current per_page setting
        const urlParams = new URLSearchParams(window.location.search);
        const perPage = urlParams.get('per_page') || '20';
        
        // Prepare form data
        const formData = new FormData();
        formData.append('query_text', query);
        formData.append('page', page.toString());
        formData.append('per_page', perPage);
        formData.append('similarity_threshold', (window.semanticSearchThreshold || 0.7).toString());
        
        console.log('📤 Request Details:', {
            endpoint: '/api/semantic-search',
            method: 'POST',
            formData: {
                query_text: query,
                page: page,
                per_page: perPage,
                similarity_threshold: (window.semanticSearchThreshold || 0.7).toString()
            }
        });
        
        // Perform semantic search
        const response = await fetch('/api/semantic-search', {
            method: 'POST',
            body: formData
        });
        
        console.log('📥 Response Status:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok,
            headers: Object.fromEntries(response.headers.entries())
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const endTime = performance.now();
        
        console.log('📊 Search Results:', {
            totalResults: data.pagination?.total_count || 0,
            currentPage: data.pagination?.page || page,
            totalPages: data.pagination?.total_pages || 0,
            resultsOnPage: data.media_files?.length || 0,
            searchDuration: `${(endTime - startTime).toFixed(2)}ms`,
            queryInfo: data.query_info || {}
        });
        
        // Log detailed results for each video
        if (data.media_files && data.media_files.length > 0) {
            console.log('🎬 Video Results Details:');
            data.media_files.forEach((video, index) => {
                console.log(`  ${index + 1}. "${video.display_title || video.name}"`, {
                    id: video.id_db,
                    filename: video.name,
                    semanticScore: video.semantic_search_score,
                    maxSimilarity: video.max_similarity,
                    avgSimilarity: video.avg_similarity,
                    matchingFrames: video.matching_frames,
                    hasMLAnalysis: video.has_ml_analysis,
                    mlInfo: video.ml_analysis_info
                });
            });
        } else {
            console.warn('⚠️ No results found for query:', query);
        }
        
        // Update the media grid with results
        updateMediaGridWithSemanticResults(data, query);
        
        // Update URL to reflect semantic search
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('search', query);
        newUrl.searchParams.set('page', page.toString());
        newUrl.searchParams.set('search_type', 'semantic');
        window.history.pushState({}, '', newUrl);
        
        console.log('✅ Search completed successfully');
        console.groupEnd();
        
    } catch (error) {
        const endTime = performance.now();
        console.error('❌ Semantic Search Error:', {
            error: error.message,
            stack: error.stack,
            searchDuration: `${(endTime - startTime).toFixed(2)}ms`,
            query: query,
            page: page,
            threshold: window.semanticSearchThreshold || 0.7,
            timestamp: new Date().toISOString()
        });
        console.groupEnd();
        
        // Show error state
        const mediaGrid = document.getElementById('media-grid');
        mediaGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 mx-auto text-red-500 mb-4">
                    <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-xl font-semibold text-slate-300">Semantic search failed</h3>
                <p class="text-slate-400 mt-2">
                    ${error.message.includes('500') ? 
                        'AI search is not available. Make sure videos have been processed with ML analysis.' : 
                        'An error occurred while searching. Please try again.'}
                </p>
                <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                    Try Again
                </button>
            </div>
        `;
    }
}

// Update media grid with semantic search results
function updateMediaGridWithSemanticResults(data, query) {
    const mediaGrid = document.getElementById('media-grid');
    
    if (!data.media_files || data.media_files.length === 0) {
        mediaGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 mx-auto text-slate-500 mb-4">
                    <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-xl font-semibold text-slate-300">No semantic matches found</h3>
                <p class="text-slate-400 mt-2">
                    No videos found matching: <strong>"${query}"</strong>
                </p>
                <p class="text-slate-500 mt-1 text-sm">
                    Try different keywords or make sure your videos have been processed with ML analysis.
                </p>
                <div class="mt-4 space-x-2">
                    <button onclick="clearSemanticSearch()" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-500 transition-colors">
                        Clear Search
                    </button>
                    <a href="/ml-processing" class="inline-block px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                        Process Videos
                    </a>
                </div>
            </div>
        `;
        return;
    }
    
    // Show semantic search header
    let resultsHtml = `
        <div class="col-span-full mb-6 bg-purple-500/10 border border-purple-500/20 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-purple-400">
                            <path d="M8 2a6 6 0 100 12A6 6 0 008 2zM7 5a1 1 0 112 0v2a1 1 0 11-2 0V5zM8 10a1 1 0 100-2 1 1 0 000 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-purple-300">AI Semantic Search Results</h3>
                        <p class="text-sm text-purple-200">Found ${data.pagination.total_count} videos matching: <strong>"${query}"</strong></p>
                        <p class="text-xs text-purple-300 mt-1">Sensitivity: ${Math.round((window.semanticSearchThreshold || 0.7) * 100)}% • ${data.pagination.total_count} results</p>
                    </div>
                </div>
                <button onclick="clearSemanticSearch()" class="text-purple-300 hover:text-purple-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                        <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                </button>
            </div>
        </div>
    `;
    
    // Render video cards (reuse existing template logic)
    data.media_files.forEach((file, index) => {
        resultsHtml += generateVideoCardHtml(file, index, query);
    });
    
    // Add pagination for semantic results
    if (data.pagination.total_pages > 1) {
        resultsHtml += generateSemanticPaginationHtml(data.pagination, query);
    }
    
    mediaGrid.innerHTML = resultsHtml;
    
    // Re-setup video previews for new content
    setupVideoPreviews();
}

// Generate HTML for a video card (extracted from existing template)
function generateVideoCardHtml(file, index, searchQuery = '') {
    const videoUrlParams = [];
    if (searchQuery) videoUrlParams.push('search=' + encodeURIComponent(searchQuery));
    
    // Add timestamp parameter if this is a semantic search result with best frame timestamp
    if (file.best_frame_timestamp !== undefined) {
        videoUrlParams.push('t=' + file.best_frame_timestamp);
    }
    
    const videoUrlQuery = videoUrlParams.length > 0 ? '?' + videoUrlParams.join('&') : '';
    
    const videoUrl = file.type === 'video' ? 
        `/video/${encodeURIComponent(file.name)}${videoUrlQuery}` : 
        file.path;
    
    const thumbnailClass = file.thumbnail.includes('generic') ? 'p-4' : '';
    const transcodedBadge = file.type === 'video' && file.has_transcoded_version ? 
        '<span class="absolute top-2 left-2 bg-green-500/80 text-white text-xs px-1.5 py-0.5 rounded-sm font-medium">Transcoded</span>' : '';
    
    const mlBadge = file.type === 'video' && file.has_ml_analysis ? 
        `<span class="absolute top-2 ${file.has_transcoded_version ? 'left-20' : 'left-2'} bg-blue-500/80 text-white text-xs px-1.5 py-0.5 rounded-sm font-medium flex items-center" title="ML Analysis: ${file.ml_analysis_info?.frame_count || 0} frames processed with ${file.ml_analysis_info?.model_name || 'unknown'}">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3 h-3 mr-1">
                <path d="M8 2L2 7l6 5 6-5-6-5zM2 12l6 5 6-5M2 9l6 5 6-5"/>
            </svg>
            ML
        </span>` : '';
    
    const semanticBadge = file.search_type === 'semantic' ? 
        `<span class="absolute top-2 right-2 bg-purple-500/80 text-white text-xs px-1.5 py-0.5 rounded-sm font-medium flex items-center" title="Semantic match: ${(file.semantic_search_score * 100).toFixed(1)}% similarity">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-3 h-3 mr-1">
                <path d="M8 2a6 6 0 100 12A6 6 0 008 2zM7 5a1 1 0 112 0v2a1 1 0 11-2 0V5zM8 10a1 1 0 100-2 1 1 0 000 2z"/>
            </svg>
            ${Math.round(file.semantic_search_score * 100)}%
        </span>` : '';
    
    const durationBadge = file.duration ? 
        `<span class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-1.5 py-0.5 rounded-sm">${file.duration}</span>` : '';
    
    const audioIcon = file.type === 'audio' ? 
        `<div class="absolute inset-0 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 text-slate-500 opacity-50">
                <path fill-rule="evenodd" d="M19.952 1.651a.75.75 0 01.298.599V16.5a3 3 0 01-5.223 2.502l-10.706-8.25a.75.75 0 010-1.004L14.729 1.5H4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0v-10h9.479l-3.082 2.392a.75.75 0 00-.012 1.011L15 12.182v-3.475a2.25 2.25 0 011.084-1.993l3.75-2.25a.75.75 0 01.118-.063zM5.25 12a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75H6a.75.75 0 01-.75-.75v-1.5z" clip-rule="evenodd" />
                <path d="M15.75 15a.75.75 0 01.75-.75H18a.75.75 0 01.75.75v1.5a.75.75 0 01-.75.75h-1.5a.75.75 0 01-.75-.75v-1.5z" />
            </svg>
        </div>` : '';
    
    const tags = file.type === 'video' && file.tags ? 
        file.tags.slice(0, 3).map(tag => 
            `<span class="tag-bubble text-xs bg-slate-700 text-slate-300 px-1.5 py-0.5 rounded-full">${escapeHtml(tag)}</span>`
        ).join('') + 
        (file.tags.length > 3 ? `<span class="tag-bubble text-xs bg-slate-600 text-slate-400 px-1.5 py-0.5 rounded-full">+${file.tags.length - 3} more</span>` : '') : '';
    
    return `
        <div class="media-card group relative bg-slate-800 border border-slate-700 rounded-lg shadow-lg overflow-hidden transition-all duration-200 ease-in-out hover:shadow-2xl hover:border-primary/70 focus-within:ring-2 focus-within:ring-primary focus-within:ring-offset-2 focus-within:ring-offset-slate-900"
             data-preview-url="${file.type === 'video' && file.has_preview ? file.preview_url : ''}"
             data-thumbnail-url="${file.thumbnail}"
             id="media-card-${file.id_db}_${index}">
            
            <a href="${videoUrl}" 
               class="block aspect-[16/9] bg-black media-thumbnail-container relative"
               aria-label="View ${escapeHtml(file.display_title)}">
                <img src="${file.thumbnail}" 
                     alt="Thumbnail for ${escapeHtml(file.display_title)}" 
                     class="media-thumbnail-img w-full h-full object-contain transition-opacity duration-300 ease-in-out group-hover:opacity-75 ${thumbnailClass}"
                     loading="lazy">
                
                <div class="preview-video-container absolute inset-0 w-full h-full"></div>
                
                ${durationBadge}
                ${transcodedBadge}
                ${mlBadge}
                ${semanticBadge}
                ${audioIcon}
            </a>
            
            <div class="p-2 sm:p-3 lg:p-4">
                <h3 class="text-xs sm:text-sm lg:text-base font-semibold text-slate-200 group-hover:text-primary transition-colors duration-150 truncate" title="${escapeHtml(file.display_title)}">
                    <a href="${videoUrl}" class="focus:outline-none">
                        ${escapeHtml(file.display_title)}
                    </a>
                </h3>
                <p class="text-xs text-slate-400 capitalize">${file.type}</p>
                ${tags ? `<div class="mt-1.5 flex flex-wrap gap-1">${tags}</div>` : ''}
            </div>
        </div>
    `;
}

// Generate pagination HTML for semantic search results
function generateSemanticPaginationHtml(pagination, query) {
    const prevButton = pagination.has_prev ? 
        `<button onclick="performSemanticSearch('${escapeHtml(query)}', ${pagination.prev_page})" 
                class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
            </svg>
            Previous
        </button>` : 
        `<span class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-500 bg-slate-800 border border-slate-700 rounded-md cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
            </svg>
            Previous
        </span>`;
    
    const nextButton = pagination.has_next ? 
        `<button onclick="performSemanticSearch('${escapeHtml(query)}', ${pagination.next_page})" 
                class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150">
            Next
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1">
                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
            </svg>
        </button>` : 
        `<span class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-500 bg-slate-800 border border-slate-700 rounded-md cursor-not-allowed">
            Next
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1">
                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
            </svg>
        </span>`;
    
    // Generate page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.page + 2);
    
    let pageNumbers = '';
    
    if (startPage > 1) {
        pageNumbers += `<button onclick="performSemanticSearch('${escapeHtml(query)}', 1)" class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150">1</button>`;
        if (startPage > 2) {
            pageNumbers += '<span class="text-slate-500 px-2">...</span>';
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === pagination.page) {
            pageNumbers += `<span class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-primary border border-primary rounded-md">${i}</span>`;
        } else {
            pageNumbers += `<button onclick="performSemanticSearch('${escapeHtml(query)}', ${i})" class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150">${i}</button>`;
        }
    }
    
    if (endPage < pagination.total_pages) {
        if (endPage < pagination.total_pages - 1) {
            pageNumbers += '<span class="text-slate-500 px-2">...</span>';
        }
        pageNumbers += `<button onclick="performSemanticSearch('${escapeHtml(query)}', ${pagination.total_pages})" class="inline-flex items-center px-3 py-2 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-md hover:bg-slate-600 hover:text-white transition-colors duration-150">${pagination.total_pages}</button>`;
    }
    
    return `
        <div class="col-span-full mt-8 mb-4">
            <div class="flex items-center justify-between">
                <div class="text-sm text-slate-400">
                    Showing ${((pagination.page - 1) * pagination.per_page) + 1} to ${Math.min(pagination.page * pagination.per_page, pagination.total_count)} of ${pagination.total_count} semantic matches
                </div>
                <nav class="flex items-center space-x-1" aria-label="Pagination">
                    ${prevButton}
                    <div class="flex items-center space-x-1">${pageNumbers}</div>
                    ${nextButton}
                </nav>
            </div>
        </div>
    `;
}

// Clear semantic search and return to normal search
function clearSemanticSearch() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.value = '';
    }
    
    // Turn off AI search toggle
    if (window.toggleAISearch && window.aiSearchEnabled) {
        window.toggleAISearch();
    }
    
    // Remove semantic search parameters from URL
    const newUrl = new URL(window.location);
    newUrl.searchParams.delete('search_type');
    newUrl.searchParams.delete('search');
    newUrl.searchParams.set('page', '1');
    window.history.pushState({}, '', newUrl);
    
    // Reload the page to show normal results
    location.reload();
}

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initial setup
document.addEventListener('DOMContentLoaded', function() {
    setupVideoPreviews();
    handleSearchReset();
    
    // Check if we're on a semantic search results page
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('search_type') === 'semantic') {
        const searchQuery = urlParams.get('search');
        if (searchQuery) {
            // Update search input to show the semantic query
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = searchQuery;
            }
            
            // Enable AI search toggle if we're viewing semantic results
            if (window.toggleAISearch && !window.aiSearchEnabled) {
                window.toggleAISearch();
            }
        }
    }
});

// Re-run setup if HTMX swaps content (e.g., after search or pagination)
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'media-grid' || event.detail.target.closest('#media-grid')) {
        setupVideoPreviews();
    }
});
</script> 